Menu="Utilities"
Type="xmenu"
Title="Automover"
Icon="icon.png"
Tag="icon.png"
Markdown="false"
---
<?php
$cfgPath = '/boot/config/plugins/automover/settings.cfg';

// Define all default keys and their order
$defaults = [
    'POOL_NAME' => 'cache',
    'THRESHOLD' => 0,
    'DRY_RUN' => 'no',
    'ALLOW_DURING_PARITY' => 'no',
    'AUTOSTART' => 'no',
    'AGE_BASED_FILTER' => 'no',
    'AGE_DAYS' => 1,
    'SIZE_BASED_FILTER' => 'no',
    'SIZE_MB' => 1,
    'EXCLUSIONS_ENABLED' => 'no',
    'QBITTORRENT_SCRIPT' => 'no',
    'QBITTORRENT_HOST' => '',
    'QBITTORRENT_USERNAME' => '',
    'QBITTORRENT_PASSWORD' => '',
    'QBITTORRENT_DAYS_FROM' => '0',
    'QBITTORRENT_DAYS_TO' => '2',
    'QBITTORRENT_STATUS' => 'completed',
    'HIDDEN_FILTER' => 'no',
    'FORCE_RECONSTRUCTIVE_WRITE' => 'no',
    'CONTAINER_NAMES' => '',
    'ENABLE_JDUPES' => 'no',
    'HASH_PATH' => '/mnt/user/appdata',
    'ENABLE_CLEANUP' => 'no',
    'CRON_MODE' => 'minutes',
    'MINUTES_FREQUENCY' => '2',
    'HOURLY_FREQUENCY' => '',
    'DAILY_TIME' => '',
    'WEEKLY_DAY' => '',
    'WEEKLY_TIME' => '',
    'MONTHLY_DAY' => '',
    'MONTHLY_TIME' => '',
    'CUSTOM_CRON' => '',
    'CRON_EXPRESSION' => '',
    'STOP_THRESHOLD' => 0,
    'ENABLE_NOTIFICATIONS' => 'no',
    'WEBHOOK_URL' => '',
    'MANUAL_MOVE' => 'no',
    'STOP_ALL_CONTAINERS' => 'no',
    'ENABLE_TRIM' => 'no',
    'ENABLE_SCRIPTS' => 'no',
    'PRE_SCRIPT' => '',
    'POST_SCRIPT' => ''
];

// Load existing config if present
$existing = [];
if (file_exists($cfgPath)) {
    $existing = parse_ini_file($cfgPath) ?: [];
}
// Merge without overwriting existing keys
foreach ($defaults as $key => $value) {
    if (!array_key_exists($key, $existing)) {
        $existing[$key] = $value;
    }
}
// Rebuild config text in the correct order
$configText = '';
foreach ($defaults as $key => $defaultValue) {
    $val = $existing[$key];
    $configText .= "$key=\"$val\"\n";
}
@file_put_contents($cfgPath, $configText);
$settings = $existing;
?>

<?php
$unraid_version = "7.2"; // fallback
if (file_exists("/etc/unraid-version")) {
    $data = parse_ini_file("/etc/unraid-version");
    if (!empty($data["version"])) {
        $unraid_version = $data["version"];
    }
}
?>

<script>
  // UNIVERSAL CSRF TOKEN DISCOVERY for Unraid plugin pages
  let csrfToken = "<?= $_GET['csrf_token'] ?? ($_COOKIE['csrf_token'] ?? '') ?>";

  // Try dynamic lookup from global scope, cookie, or meta
  if (!csrfToken || csrfToken === "undefined" || csrfToken === "") {
    try {
      // 1️⃣ Try the global variable used by Unraid's WebGUI JS
      if (typeof window.csrf_token !== "undefined" && window.csrf_token) {
        csrfToken = window.csrf_token;
      }

      // 2️⃣ Try any embedded meta tag
      if ((!csrfToken || csrfToken === "") && document.querySelector("meta[name='csrf_token']")) {
        csrfToken = document.querySelector("meta[name='csrf_token']").getAttribute("content");
      }

      // 3️⃣ Try cookie (most Unraid builds set it)
      if ((!csrfToken || csrfToken === "") && document.cookie.includes("csrf_token=")) {
        const m = document.cookie.match(/csrf_token=([^;]+)/);
        if (m) csrfToken = decodeURIComponent(m[1]);
      }

      // 4️⃣ Fallback: try to extract from any script tag in the parent frame
      if ((!csrfToken || csrfToken === "") && window.parent) {
        try {
          if (window.parent.csrf_token) csrfToken = window.parent.csrf_token;
        } catch (e) { /* ignore cross-frame */ }
      }
    } catch (err) {
      console.warn("CSRF token discovery failed:", err);
    }
  }

  console.log("Resolved CSRF token:", csrfToken || "<empty>");
</script>

<style>
  :root {
    --primary-blue: #00aaff;
    --status-green: #2ECC40;
  }

  /* === Layout Wrapper === */
  #automover-wrapper {
    display: flex;
    flex-wrap: nowrap;
    /* stay side-by-side */
    align-items: flex-start;
    /* align at top */
    justify-content: space-evenly;
    /* even horizontal spacing */
    gap: 20px;
    /* space between panels */
    width: 100%;
    box-sizing: border-box;
  }

  /* === Each Panel (auto-sizing) === */
  #automover-settings,
  #moved-log-container,
  #last-run-container {
    background: #111;
    border-radius: 12px;
    box-shadow: 0 0 12px rgba(0, 128, 128, .3);
    color: #f0f8ff;
    padding: 20px;
    flex: 1 1 auto;
    /* grow and shrink dynamically */
    height: auto;
    /* dynamic height */
    max-height: none;
    /* remove fixed limit */
    overflow: visible;
    /* expand with content */
    min-width: 0;
    /* prevent overflow on long content */
    box-sizing: border-box;
  }

  #automover-settings {
    padding-top: 0px !important;
    /* reduce from default 20px */
  }

  #last-run-container {
    padding-top: 10px !important;
    /* reduce from default 20px */
  }

  #last-run-container h3 {
    margin-top: 0 !important;
    /* remove any top margin */
    margin-bottom: 10px;
    /* keep small spacing below title */
  }

  #moved-log-container {
    padding-top: 10px !important;
    /* reduce from default 20px */
  }

  #moved-log-container h3 {
    margin-top: 0 !important;
    /* remove any top margin */
    margin-bottom: 10px;
    /* keep small spacing below title */
  }

  /* === Optional: fine-tune widths === */
  #automover-settings {
    flex-basis: 25%;
  }

  #moved-log-container {
    flex-basis: 53%;
  }

  #last-run-container {
    flex-basis: 22%;
  }

  .unraid-71 #automover-settings {
    min-height: 77vh;
    max-height: 77vh;
    overflow-y: auto;
    margin: 0;
  }

  .unraid-71 #moved-log-container pre {
    max-height: 60vh;
    overflow-y: auto;
    margin: 0;
  }

  .unraid-71 #last-run-container pre {
    max-height: 68vh;
    overflow-y: auto;
    margin: 0;
  }

  .unraid-72 #automover-settings {
    min-height: 76vh;
    max-height: 76vh;
    overflow-y: auto;
    margin: 0;
  }

  .unraid-72 #moved-log-container pre {
    max-height: 59vh;
    overflow-y: auto;
    margin: 0;
  }

  .unraid-72 #last-run-container pre {
    max-height: 67vh;
    overflow-y: auto;
    margin: 0;
  }

  @media (max-width: 1100px) {
    #automover-wrapper {
      flex-wrap: wrap;
    }

    #automover-settings,
    #moved-log-container,
    #last-run-container {
      flex: 1 1 100%;
    }
  }

  .form-row {
    flex-direction: column;
    gap: 15px;
    margin-bottom: 20px;
  }

  label {
    color: var(--primary-blue);
    font-weight: bold;
    margin-bottom: 5px;
  }

  input,
  select {
    background: #111;
    border: 1px solid var(--primary-blue);
    border-radius: 5px;
    color: #fff;
    padding: 8px;
  }

  .unraid-71 #automover-wrapper {
    margin-top: -31px !important;
  }

  .unraid-72 #automover-wrapper {
    margin-top: -20px !important;
  }

  button {
    border: none;
    border-radius: 4px;
    color: #fff;
    cursor: pointer;
    margin-right: 10px;
    padding: 8px 15px;
  }

  .checkbox-row {
    align-items: center;
    display: grid;
    gap: 0 0px;
    grid-template-columns: repeat(2, 1fr);
    margin-top: 10px;
  }

  .checkbox-row label {
    align-items: center;
    cursor: pointer;
    display: flex;
    font-size: 15px;
    gap: 0px;
    line-height: 1.4;
  }

  .checkbox-row input[type="checkbox"] {
    accent-color: var(--primary-blue);
    transform: scale(1.2);
  }

  input[type="checkbox"] {
    accent-color: var(--primary-blue);
    cursor: pointer;
    height: 16px;
    width: 16px;
  }

  .form-check input {
    margin-right: 8px;
    vertical-align: middle;
  }

  .status-container {
    margin-top: 20px;
  }

  .status-row {
    align-items: center;
    display: flex;
    margin-bottom: 6px;
  }

  .status-label {
    color: var(--primary-blue);
    font-weight: bold;
    width: 75px;
  }

  #status-text,
  #last-run-text {
    color: var(--status-green);
  }

  .tooltip {
    display: inline-block;
    position: relative;
  }

  .tooltip:hover::after {
    background: #333;
    border-radius: 4px;
    bottom: 125%;
    color: #fff;
    content: attr(data-tooltip);
    font-size: 12px;
    left: 0;
    opacity: .9;
    padding: 6px 10px;
    position: absolute;
    text-transform: none;
    white-space: nowrap;
    z-index: 10;
  }

  .form-pair {
    display: flex;
    align-items: center;
    /* Center vertically */
    justify-content: flex-start;
    gap: 10px;
    margin-bottom: 15px;
    margin-top: 8px;
  }

  .input-wrapper {
    display: flex;
    flex-direction: column;
    flex: 1;
    /* Let input fill remaining width */
  }

  .form-pair label {
    width: 130px;
    /* Match other field labels */
    color: var(--primary-blue);
    font-weight: bold;
    text-align: left;
    /* Align text right for consistency */
    margin-right: 10px;
  }

  .form-pair input,
  .form-pair select {
    background: #111;
    color: #fff;
    width: 200px;
    /* Full width under input-wrapper */
    min-width: fit-content;
    max-width: 100%;
    /* Cap the input width if needed */
  }

  .form-pair input[type="text"],
  .form-pair input[type="password"] {
    min-width: fit-content;
    max-width: 100%;
    /* Cap the input width if needed */
  }

  .short-input {
    flex: 0 0 auto;

  }

  .short-input-filter {
    flex: 0 0 auto;

  }

  #pool.short-input {
    flex: 0 0 auto;

  }

  input.invalid {
    border-color: red;
    color: red;
  }

  .field-warning {
    color: red;
    display: none;
    font-size: 12px;
    margin-top: 4px;
  }

  input.invalid+.field-warning {
    display: block;
  }

  @keyframes shake {

    0%,
    100% {
      transform: translateX(0);
    }

    25% {
      transform: translateX(-5px);
    }

    50% {
      transform: translateX(5px);
    }

    75% {
      transform: translateX(-5px);
    }
  }

  #automover-settings.shake {
    animation: shake .3s;
  }

  #move-now-confirmation,
  #save-confirmation,
  #stop-confirmation {
    animation: flash .4s ease;
    background: var(--primary-blue);
    border-radius: 6px;
    clear: both;
    color: #fff;
    display: block;
    font-weight: bold;
    opacity: 0;
    padding: 6px 12px;
    transition: opacity .4s ease;
    width: fit-content;
    display: inline-block;
    margin-bottom: 10px;
  }

  @keyframes flash {
    0% {
      opacity: 0;
      transform: scale(1);
    }

    50% {
      opacity: 1;
      transform: scale(1.1);
    }

    100% {
      opacity: 1;
      transform: scale(1);
    }
  }

  #moved-log-container h3 {
    color: var(--primary-blue);
    font-size: 18px;
    margin-bottom: 12px;
  }

  #automover-log {
    background: #111;
    border: 1px solid var(--primary-blue);
    border-radius: 8px;
    box-sizing: border-box;
    color: #00ffaa;
    font-family: monospace;
    font-size: 13px;
    padding: 10px;
    white-space: pre-wrap;
    width: 100%;
    word-break: break-word;
  }

  #log-counts {
    color: var(--primary-blue);
    font-size: 14px;
    margin-bottom: 0px;
    text-align: left;
    width: 100%;
  }

  .skipped-line {
    color: #ffd700;
  }

  .log-header {
    align-items: flex-start;
    display: flex;
    flex-direction: column;
    margin-bottom: 12px;
  }

  .log-header h3 {
    color: var(--primary-blue);
    font-size: 18px;
    margin: 0;
  }

  .log-header-row {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 8px;
  }

  .log-header-row h3 {
    color: var(--primary-blue);
    font-size: 18px;
    margin: 0;
  }

  .log-header-row button {
    margin-top: -1px;
    background: transparent;
    color: #ff8800;
    border: 2px solid #ff6600;
  }

  .log-header-row button:hover {
    background: linear-gradient(90deg, #ff3c00 0%, #ff8800 100%);
    color: #fff;
    box-shadow: 0 0 8px rgba(255, 136, 0, 0.4);
    transform: translateY(-1px);
  }

  .log-header-row button:active {
    transform: translateY(0);
    box-shadow: 0 0 4px rgba(255, 136, 0, 0.2);
  }

  .toast-wrapper {
    display: flex;
    flex-direction: column;
    align-items: flex-end;
    position: relative;
  }

  .toast-wrapper .toast-inline {
    align-self: flex-end;
  }

  .toast-inline {
    display: block;
    /* take full row under button */
    border-radius: 6px;
    color: #ff8800;
    font-size: 13px;
    font-weight: 600;
    padding: 6px 12px;
    margin-top: -17px;
    opacity: 0;
    height: 0;
    overflow: hidden;
    transform: translateY(-6px);
    transition:
      opacity 0.4s ease,
      transform 0.3s ease,
      height 0.3s ease,
      margin 0.3s ease;
    pointer-events: none;
    text-align: center;
    white-space: nowrap;
  }

  .toast-inline.show {
    opacity: 1;
    height: auto;
    margin-top: 8px;
    transform: translateY(0);
  }

  .toast-inline.hide {
    opacity: 0;
    height: 0;
    margin-top: 0;
    transform: translateY(-6px);
  }

  .log-stats {
    color: #00ffaa;
    font-size: 14px;
    text-align: right;
    white-space: nowrap;
  }

  #last-run-container h3 {
    color: var(--primary-blue);
    font-size: 18px;
    margin-bottom: 12px;
  }

  #last-run-log {
    background: #111;
    border: 1px solid var(--primary-blue);
    border-radius: 8px;
    color: #00ffaa;
    font-family: monospace;
    font-size: 13px;
    max-height: 95vh;
    overflow-y: auto;
    padding: 10px;
    white-space: pre-wrap;
    word-break: break-word;
  }

  #log-filter {
    background: #111;
    border: 1px solid var(--primary-blue);
    border-radius: 6px;
    box-shadow: 0 0 6px rgba(0, 128, 128, .3);
    color: #00ffaa;
    font-family: monospace;
    font-size: 13px;
    padding: 8px 12px;
    transition: border-color .2s, box-shadow .2s;
    width: 200px;
  }

  #log-filter:focus {
    border-color: #00bfff;
    box-shadow: 0 0 10px rgba(0, 191, 255, .5);
    outline: none;
  }

  #log-filter::placeholder {
    color: #008080;
  }

  input[type="number"].short-input {
    -moz-appearance: auto;
    -webkit-appearance: auto;
    appearance: auto;
  }

  /* Restore number input spinner alignment for Unraid 7.2 */
  input[type="number"] {
    padding-right: 0;
    /* remove internal spacing */
  }

  /* Force Chrome/Webkit to place arrows at field edge */
  input[type="number"]::-webkit-inner-spin-button,
  input[type="number"]::-webkit-outer-spin-button {
    margin: 0;
    right: 0;
    position: absolute;
  }

  .select-pool {
    min-width: fit-content;
    appearance: none;
    max-width: 100%;
    overflow: hidden;
    text-overflow: ellipsis;
    transition: width .2s;
    white-space: nowrap;
    width: 200px;
  }

  #save-messages div {
    opacity: 1;
    transition: opacity .6s;
  }

  /* Modal picker */
  #exclusion-modal {
    align-items: center;
    background: rgba(0, 0, 0, .8);
    bottom: 0;
    display: none;
    justify-content: center;
    left: 0;
    position: fixed;
    right: 0;
    top: 0;
    z-index: 9999;
  }

  #exclusion-modal .box {
    background: #111;
    border-radius: 10px;
    color: #fff;
    display: flex;
    flex-direction: column;
    height: 600px;
    min-height: fit-content;
    max-height: 100%;
    overflow: hidden;
    padding: 18px;
    position: relative;
    width: 800px;
    min-width: fit-content;
    max-width: 100%;
  }

  #exclusion-modal .header {
    align-items: center;
    display: flex;
    gap: 10px;
    margin-bottom: 0px;
  }

  #exclusion-modal .crumbs {
    flex: 1;
    overflow: auto;
    white-space: nowrap;
  }

  #exclusion-modal .crumbs a {
    color: #00bfff;
    margin-right: 8px;
    text-decoration: none;
  }

  #exclusion-modal .grid {
    border: 1px solid #333;
    flex: 1;
    overflow-y: auto;
    padding: 6px;
  }

  #exclusion-modal .row {
    align-items: center;
    cursor: default;
    display: flex;
    gap: 0px;
    padding: 0px;
  }

  #exclusion-modal .row .name {
    align-items: center;
    color: #fff;
    display: flex;
    flex: 1;
    font-weight: 500;
    gap: 0px;
  }

  #exclusion-modal .row.folder .name {
    color: var(--primary-blue);
  }

  #exclusion-modal .row .name .icon {
    margin-right: 2px;
  }

  #exclusion-modal .row .name .label {
    display: inline-block;
  }

  #exclusion-modal .row input[type="checkbox"] {
    margin-right: 2px;
    transform: scale(1.1);
  }

  #exclusion-modal .row .type {
    opacity: .7;
    text-align: right;
    width: 70px;
  }

  #exclusion-modal .footer {
    align-items: center;
    display: flex;
    gap: 12px;
    justify-content: space-between;
    margin-top: 0px;
  }

  #exclusion-modal .toast {
    border-radius: 6px;
    bottom: 0px;
    color: red;
    display: none;
    left: 16px;
    padding: 8px 10px;
    position: absolute;
  }

  #exclusion-modal .btn {
    background: #0b5fff;
    border: none;
    border-radius: 6px;
    color: #fff;
    cursor: pointer;
    padding: 8px 12px;
  }

  #exclusion-modal .btn.secondary {
    background: #444;
  }

  #exclusion-modal .btn.warn {
    background: #b54708;
  }

  #exclusions-field {
    color: #ccc;
    cursor: pointer;
    font-style: italic;
    opacity: 0.6;
    user-select: none;
    width: 200px;
    min-width: fit-content;
    max-width: 100%;
  }

  #exclusion-modal .crumb {
    color: var(--primary-blue);
    cursor: pointer;
    font-weight: 500;
    transition: color 0.2s ease;
    user-select: none;
  }

  #exclusion-view-modal .modal-body {
    position: relative;
  }

  #exclusion-view-modal .toast {
    background: rgba(0, 0, 0, 0.9);
    border: 1px solid #00aaff55;
    border-radius: 6px;
    bottom: 12px;
    color: #00ff99;
    display: none;
    font-weight: 600;
    left: 50%;
    padding: 8px 14px;
    position: absolute;
    transform: translateX(-50%);
    z-index: 10;
  }

  #exclusion-view-modal .toast.error {
    color: #ff5555;
  }

  #exclusion-modal .crumb:hover {
    color: #ff3333;
    text-decoration: underline;
  }

  #exclusion-modal .sep {
    color: #999;
  }

  .footer>div {
    gap: 6px !important;
  }

  .footer button {
    margin: 0 !important;
  }

  *,
  *::before,
  *::after {
    box-sizing: border-box;
  }

  /* Focus outline for keyboard users */
  :focus-visible {
    outline: 2px solid var(--primary-blue);
    outline-offset: 2px;
  }

  /* Hover and focus for interactive elements */
  button:hover,
  input[type="checkbox"]:hover,
  select:hover,
  a:hover {
    filter: brightness(1.1);
  }

  button:focus-visible,
  input[type="checkbox"]:focus-visible,
  select:focus-visible,
  a:focus-visible {
    outline: 2px solid var(--primary-blue);
    outline-offset: 2px;
  }

  /* Scrollbar dark theme for readability */
  ::-webkit-scrollbar {
    width: 8px;
  }

  ::-webkit-scrollbar-thumb {
    background: var(--primary-blue);
    border-radius: 4px;
  }

  #qbit_status {
    width: 200px;
    min-width: fit-content;
    max-width: 100%;
    display: inline-block;
  }

  #HASH_PATH {
    width: 200px;
    min-width: fit-content;
    max-width: 100%;
    display: inline-block;
  }

  #manual-move-section {
    width: 24.5%;
    box-sizing: border-box;
  }

  .manual-move-toggle-wrapper {
    margin-top: 20px;
  }

  #manual-move-section .form-pair label {
    width: 130px;
    /* match automover settings labels */
    font-weight: bold;
    color: var(--primary-blue);
  }

  #manual-move-section .form-pair input {
    width: 200px;
    /* same as others */
  }

  #manual-move-section .form-check {
    gap: 4px !important;
  }

  #manual-move-section input[type="checkbox"] {
    margin-right: 2px !important;
    transform: scale(1.1);
  }

  /* Shake animation for invalid click */
  @keyframes pickerShake {
    0% {
      transform: translateX(0);
    }

    20% {
      transform: translateX(-8px);
    }

    40% {
      transform: translateX(8px);
    }

    60% {
      transform: translateX(-8px);
    }

    80% {
      transform: translateX(8px);
    }

    100% {
      transform: translateX(0);
    }
  }

  .shake-picker {
    animation: pickerShake 0.3s ease;
  }

  /* --- Picker link styles (same as exclusions modal) --- */
  .picker-link {
    color: var(--primary-blue);
    cursor: pointer;
    font-weight: 500;
  }

  .picker-link:hover {
    text-decoration: underline;
  }

  /* Breadcrumb container matches exclusions modal */
  #manual-picker-crumbs {
    font-size: 14px;
    color: var(--primary-blue);
    padding: 10px 12px;
    border-bottom: 1px solid #333;
    display: flex;
    gap: 6px;
    flex-wrap: wrap;
  }

  /* Breadcrumb pieces */
  .picker-crumb {
    color: #3ca8ff;
    cursor: pointer;
    transition: color 0.15s ease;
  }

  .picker-crumb:hover {
    text-decoration: underline;
    color: #ff4444;
  }

  #manual_source,
  #manual_dest {
    cursor: pointer;
  }

  #qbit-days-to-warning,
  #qbit-days-order-warning {
    max-width: 200px;
    width: 200px;
    /* optional, keeps consistent width */
    white-space: normal;
    /* allows wrapping */
  }

  .manual-error-toast {
    display: none;
    color: #ff4444;
    padding: -66px 10px;
    border-radius: 6px;
    font-size: 13px;
    font-weight: 600;
    max-width: 200px;
    white-space: normal;
  }

  .manual-error-wide {
    max-width: 350px !important;
  }

  @keyframes manualShake {
    0% {
      transform: translateX(0);
    }

    20% {
      transform: translateX(-8px);
    }

    40% {
      transform: translateX(8px);
    }

    60% {
      transform: translateX(-8px);
    }

    80% {
      transform: translateX(8px);
    }

    100% {
      transform: translateX(0);
    }
  }

  .manual-shake {
    animation: manualShake .35s ease;
  }

  #exclusion-view-modal .modal-body {
    display: flex;
    flex-direction: column;
    padding-right: 18px !important;
  }

  #exclusion-view-modal p {
    width: 100% !important;
    max-width: 100% !important;
    margin-right: 0 !important;
  }

  #exclusionsEditor {
    width: 100% !important;
    margin-right: 0 !important;
    padding-right: 8px;
  }

  #exclusion-view-modal .footer {
    display: flex;
    justify-content: flex-end !important;
    margin-top: 10px;
  }

  #exclusion-view-modal .footer>div:first-child {
    margin-right: auto;
  }

  #stop-button {
    border: none;
  }

  .form-check {
    display: flex;
    align-items: center;
    gap: 0px;
    /* same spacing as other checkboxes */
    cursor: pointer;
    color: var(--primary-blue);
  }

  .form-check input[type="checkbox"] {
    width: 16px;
    height: 16px;
    transform: scale(1.1);
    /* same enlargement as others */
    accent-color: var(--primary-blue);
    cursor: pointer;
  }

  .form-check label {
    margin: 0;
    line-height: 1.4;
    font-size: 14px;
    font-weight: bold;
    color: var(--primary-blue);
    cursor: pointer;
  }

  #stop_all_containers {
    margin-left: 2px;
    transform: scale(1.1);
    width: 16px;
    height: 16px;
    vertical-align: middle;
  }

  #cron-warning-fields,
  #cron-warning-minute,
  #cron-warning-interval {
    max-width: 360px;
    width: 100%;
    box-sizing: border-box;
    word-wrap: break-word;
  }
</style>

<div id="automover-wrapper">
  <form id="automover-settings">
    <div class="status-container">
      <div class="status-row"><span class="status-label">Status:</span><span id="status-text">Stopped</span></div>
      <div class="status-row"><span class="status-label">Last Run:</span><span id="last-run-text">No last run
          available</span></div>
    </div>

    <div class="form-group">
      <span title="Save your configuration settings and start the automover service" class="automovertip">
        <button type="button" id="save-settings">Save & Start</button>
      </span>

      <span title="Stop Automover service and stop moving" class="automovertip">
        <button type="button" id="stop-button">Stop</button>
      </span>

      <span title="Run Automover immediately, ignoring filters" class="automovertip">
        <button type="button" id="moveNowBtn">Move Now</button>
      </span>
    </div>

    <div id="move-now-confirmation" style="display:none;">✅ Moving Now</div>
    <div id="save-confirmation" style="display:none;">✅ Saved & Started Automover</div>
    <div id="stop-confirmation" style="display:none;">✅ Stopping Automover</div>

    <div id="save-messages" style="display:none;background:#111;border-radius:6px;font-family:monospace;color:red;">
    </div>

    <!-- Pool -->
    <div class="form-pair">
      <label for="pool" <span title="Choose which pool to monitor for disk usage" class="automovertip">Pool:</span>
      </label>
      <span title="Choose which pool to monitor for disk usage" class="automovertip">
        <select id="pool" class="select-pool"
          data-selected="<?php echo htmlspecialchars($settings['POOL_NAME'] ?? '') ?>"></select>
      </span>
    </div>

    <div id="pool-warning" class="field-warning">⚠️ This pool is not assigned to any share that has mover direction
      cache -> array. Nothing would be moved with this pool selected.</div>

    <!-- Threshold -->
    <div class="form-pair">
      <label for="threshold" <span title="Set the disk usage percentage threshold that triggers the mover"
        class="automovertip">Threshold (%):</span>
      </label>
      <div class="input-wrapper">
        <span title="Set the disk usage percentage threshold that triggers the mover" class="automovertip">
          <input type="number" id="threshold" class="short-input" min="0" max="100" step="1"
            value="<?php echo htmlspecialchars($settings['THRESHOLD'] ?? '') ?>">
        </span>
        <div id="threshold-warning" class="field-warning">⚠️ Threshold must be between 0–100</div>
      </div>
    </div>

    <!-- Stop Threshold -->
    <div class="form-pair">
      <label for="stop_threshold" <span title="Set the disk usage percentage to stop moving" class="automovertip">
        Stop Threshold (%):
        </span>
      </label>
      <div class="input-wrapper">
        <span title="Set the disk usage percentage to stop moving" class="automovertip">
          <input type="number" id="stop_threshold" class="short-input" min="0" max="100" step="1"
            value="<?php echo htmlspecialchars($settings['STOP_THRESHOLD'] ?? ''); ?>">
        </span>
        <div id="stop-threshold-warning" class="field-warning">⚠️ Stop threshold must be between 0–100</div>
      </div>
    </div>

<!-- Scheduling Selection -->
<div class="form-pair" id="cron-expression-row">
  <label for="cron_mode">
    <span class="automovertip" title="Select scheduling selection">
      Scheduling:
    </span>
  </label>
  <div class="input-wrapper">
    <span class="automovertip" title="Select scheduling selection">
      <select id="cron_mode" name="CRON_MODE" class="short-input">
        <option value="minutes" <?php echo (($settings['CRON_MODE'] ?? '' )==='minutes' ) ? 'selected' : '' ; ?>>Minutes</option>
        <option value="hourly" <?php echo (($settings['CRON_MODE'] ?? '' )==='hourly' ) ? 'selected' : '' ; ?>>Hourly</option>
        <option value="daily" <?php echo (($settings['CRON_MODE'] ?? '' )==='daily' ) ? 'selected' : '' ; ?>>Daily</option>
        <option value="weekly" <?php echo (($settings['CRON_MODE'] ?? '' )==='weekly' ) ? 'selected' : '' ; ?>>Weekly</option>
        <option value="monthly" <?php echo (($settings['CRON_MODE'] ?? '' )==='monthly' ) ? 'selected' : '' ; ?>>Monthly</option>
        <option value="custom" <?php echo (($settings['CRON_MODE'] ?? '' )==='custom' ) ? 'selected' : '' ; ?>>Custom</option>
      </select>
    </span>
  </div>
</div>

<!-- Minutes Options -->
<div id="minutes-options" style="display:none; margin-top:10px;">
  <div class="form-pair">
    <label for="minutes_frequency">
      <span class="automovertip" title="Select minute frequency">
        Select Frequency:
      </span>
    </label>
    <div class="input-wrapper">
      <span class="automovertip" title="Select minute frequency">
        <select id="minutes_frequency" name="MINUTES_FREQUENCY" class="short-input">
          <?php
            for ($i = 2; $i <= 59; $i++) {
              $selected = (($settings['MINUTES_FREQUENCY'] ?? '') == strval($i)) ? 'selected' : '';
              echo "<option value=\"$i\" $selected>Every $i Minutes</option>";
            }
          ?>
        </select>
      </span>
    </div>
  </div>
</div>

<!-- Hourly Options -->
<div id="hourly-options" style="display:none; margin-top:10px;">
  <div class="form-pair">
    <label for="hourly_frequency">
      <span class="automovertip" title="Select hourly frequency">
        Select Frequency:
      </span>
    </label>
    <div class="input-wrapper">
      <span class="automovertip" title="Select hourly frequency">
        <select id="hourly_frequency" name="HOURLY_FREQUENCY" class="short-input">
          <?php
          for ($i = 1; $i <= 23; $i++) {
              $selected = (($settings['HOURLY_FREQUENCY'] ?? '') === (string)$i) ? 'selected' : '';
              echo "<option value=\"$i\" $selected>Every $i Hour" . ($i > 1 ? 's' : '') . "</option>";
          }
          ?>
        </select>
      </span>
    </div>
  </div>
</div>

    <!-- Daily Options -->
    <div id="daily-options" style="display:none; margin-top:10px;">
      <div class="form-pair">
        <label for="daily_time">
          <span class="automovertip" title="Select the time of day for daily execution">
            Time Of Day:
          </span>
        </label>
        <div class="input-wrapper">
          <span class="automovertip" title="Select the time of day for daily execution">
            <select id="daily_time" name="DAILY_TIME" class="short-input">
              <?php for ($h = 0; $h < 24; $h++): 
            $time = str_pad($h, 2, "0", STR_PAD_LEFT) . ":00"; ?>
              <option value="<?php echo $time; ?>" <?php echo (($settings['DAILY_TIME'] ?? '' )===$time) ? 'selected'
                : '' ; ?>>
                <?php echo $time; ?>
              </option>
              <?php endfor; ?>
            </select>
          </span>
        </div>
      </div>
    </div>

    <!-- Weekly Options -->
    <div id="weekly-options" style="display:none; margin-top:10px;">
      <div class="form-pair">
        <label for="weekly_day">
          <span class="automovertip" title="Select day of the week">
            Day Of Week:
          </span>
        </label>
        <div class="input-wrapper">
          <span class="automovertip" title="Select day of the week">
            <select id="weekly_day" name="WEEKLY_DAY" class="short-input">
              <?php 
            $days = ["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"];
            foreach ($days as $day): ?>
              <option value="<?php echo $day; ?>" <?php echo (($settings['WEEKLY_DAY'] ?? '' )===$day) ? 'selected' : ''
                ; ?>>
                <?php echo $day; ?>
              </option>
              <?php endforeach; ?>
            </select>
          </span>
        </div>
      </div>

      <div class="form-pair">
        <label for="weekly_time">
          <span class="automovertip" title="Select time of day for weekly execution">
            Time Of Day:
          </span>
        </label>
        <div class="input-wrapper">
          <span class="automovertip" title="Select time of day for weekly execution">
            <select id="weekly_time" name="WEEKLY_TIME" class="short-input">
              <?php for ($h = 0; $h < 24; $h++): 
            $time = str_pad($h, 2, "0", STR_PAD_LEFT) . ":00"; ?>
              <option value="<?php echo $time; ?>" <?php echo (($settings['WEEKLY_TIME'] ?? '' )===$time) ? 'selected'
                : '' ; ?>>
                <?php echo $time; ?>
              </option>
              <?php endfor; ?>
            </select>
          </span>
        </div>
      </div>
    </div>

    <!-- Monthly Options -->
    <div id="monthly-options" style="display:none; margin-top:10px;">
      <div class="form-pair">
        <label for="monthly_day">
          <span class="automovertip" title="Select day of the month">
            Day Of Month:
          </span>
        </label>
        <div class="input-wrapper">
          <span class="automovertip" title="Select day of the month">
            <select id="monthly_day" name="MONTHLY_DAY" class="short-input">
              <?php for ($d = 1; $d <= 31; $d++): 
            $day = str_pad($d, 2, "0", STR_PAD_LEFT); ?>
              <option value="<?php echo $day; ?>" <?php echo (($settings['MONTHLY_DAY'] ?? '' )===$day) ? 'selected'
                : '' ; ?>>
                <?php echo $day; ?>
              </option>
              <?php endfor; ?>
            </select>
          </span>
        </div>
      </div>

      <div class="form-pair">
        <label for="monthly_time">
          <span class="automovertip" title="Select time of day for monthly execution">
            Time Of Day:
          </span>
        </label>
        <div class="input-wrapper">
          <span class="automovertip" title="Select time of day for monthly execution">
            <select id="monthly_time" name="MONTHLY_TIME" class="short-input">
              <?php for ($h = 0; $h < 24; $h++): 
            $time = str_pad($h, 2, "0", STR_PAD_LEFT) . ":00"; ?>
              <option value="<?php echo $time; ?>" <?php echo (($settings['MONTHLY_TIME'] ?? '' )===$time) ? 'selected'
                : '' ; ?>>
                <?php echo $time; ?>
              </option>
              <?php endfor; ?>
            </select>
          </span>
        </div>
      </div>
    </div>

    <!-- Custom Option -->
    <div id="custom-options" style="display:none; margin-top:10px;">
      <div class="form-pair">
        <label for="custom_cron">
          <span class="automovertip"
            title="Enter a valid cron expression 5 fields with spaces between each for example */2 * * * * visit https://crontab.guru for help">
            Cron Expression:
          </span>
        </label>
        <div class="input-wrapper">
          <span class="automovertip"
            title="Enter a valid cron expression 5 fields with spaces between each for example */2 * * * * visit https://crontab.guru for help">
            <input type="text" id="custom_cron" name="CUSTOM_CRON" class="short-input" placeholder="*/2 * * * *"
              value="<?php echo htmlspecialchars($settings['CUSTOM_CRON'] ?? ''); ?>">
          </span>
        </div>
      </div>

      <div class="form-pair">
        <div id="cron-warning-fields" class="field-warning" role="alert" style="display:none;">
          ⚠️ Enter a valid cron expression 5 fields with spaces between each for example */2 * * * *
          visit <a href="https://crontab.guru/" target="_blank">https://crontab.guru</a> for help
        </div>
        <div id="cron-warning-minute" class="field-warning" role="alert" style="display:none;">
          ⚠️ First field cannot be * use */2 or higher
        </div>
        <div id="cron-warning-interval" class="field-warning" role="alert" style="display:none;">
          ⚠️ First field must be */2 or higher
        </div>
      </div>
    </div>

    <!-- Webhook URL -->
    <div class="form-pair" id="webhook_row" style="display:none;">
      <label for="webhook_url">
        <span title="Optional: Discord Webhook URL for notifications" class="automovertip">Discord Webhook:</span>
      </label>
      <div class="input-wrapper">
        <span title="Optional: Discord Webhook URL for notifications" class="automovertip">
          <input type="text" id="webhook_url" placeholder="https://discord.com/api/webhooks/yourwebhookid"
            value="<?php echo htmlspecialchars($settings['WEBHOOK_URL'] ?? '') ?>">
        </span>
        <div id="webhook-warning" class="field-warning">
          ⚠️ Needs entered like this https://discord.com/api/webhooks/yourwebhookid
        </div>
      </div>
    </div>

    <!-- Container Names -->
    <div class="form-pair">
      <label for="container_names">
        <span
          title="Optional: Enter a comma separated list of containers to stop during moves and start after moving finishes. Leave blank to disable"
          class="automovertip">
          Stop Containers:
        </span>
      </label>
      <div class="input-wrapper">
        <span
          title="Optional: Enter a comma separated list of containers to stop during moves and start after moving finishes. Leave blank to disable"
          class="automovertip">
          <input type="text" id="container_names" placeholder="e.g. qbit-manage,cross-seed"
            value="<?php echo htmlspecialchars($settings['CONTAINER_NAMES'] ?? '') ?>">
        </span>
      </div>
    </div>

    <div class="form-pair">
      <div class="input-wrapper">
        <div class="form-check">
          <input type="checkbox" id="stop_all_containers" <?php echo (($settings['STOP_ALL_CONTAINERS'] ?? 'no'
            )==='yes' ) ? 'checked' : '' ; ?>>
          <span
            title="Optional: Enable to stop all containers on the system that are running during moves and start only those the plugin stopped after moving finishes"
            class="automovertip">
            <label for="stop_all_containers">Stop All Containers</label>
          </span>
        </div>
        <label></label>
      </div>
    </div>

    <!-- Age -->
    <div class="form-pair" id="age-days-container" style="display:none;">
      <label for="age_days" <span title="Only move files older than this many days" class="automovertip">Age
        (days):</span>
      </label>
      <div class="input-wrapper">
        <span title="Only move files older than this many days" class="automovertip">
          <input type="number" id="age_days" class="short-input" min="1" step="1"
            value="<?php echo htmlspecialchars($settings['AGE_DAYS'] ?? '') ?>">
        </span>
        <div id="age-days-warning" class="field-warning">⚠️ Age must be at least 1 days</div>
      </div>
    </div>

    <!-- Size -->
    <div class="form-pair" id="size-mb-container" style="display:none;">
      <label for="size_mb" <span title="Only move files larger than this size (in MB)" class="automovertip">Min Size
        (MB):</span>
      </label>
      <div class="input-wrapper">
        <span title="Only move files larger than this size (in MB)" class="automovertip">
          <input type="number" id="size_mb" class="short-input" min="1" step="1"
            value="<?php echo htmlspecialchars($settings['SIZE_MB'] ?? '') ?>">
        </span>
        <div id="size-mb-warning" class="field-warning">⚠️ Size must be at least 1 MB</div>
      </div>
    </div>

    <!-- Qbittorrent Configuration Fields -->
    <div id="qbit-fields" style="display:none;">

      <div class="form-pair">
        <label for="qbit_host" <span title="Example: 10.100.10.250:8080" class="automovertip">Host:</span>
        </label>
        <div class="input-wrapper">
          <span title="Example: 10.100.10.250:8080" class="automovertip">
            <input type="text" id="qbit_host" placeholder="e.g. 10.100.10.250:8080"
              value="<?php echo htmlspecialchars($settings['QBITTORRENT_HOST'] ?? '') ?>">
          </span>
          <div id="qbit-host-warning" class="field-warning">⚠️ Host is required</div>
        </div>
      </div>

      <div class="form-pair">
        <label for="qbit_user" <span title="Qbittorrent webui username" class="automovertip">Username:</span>
        </label>
        <div class="input-wrapper">
          <span title="Qbittorrent webui username" class="automovertip">
            <input type="text" id="qbit_user"
              value="<?php echo htmlspecialchars($settings['QBITTORRENT_USERNAME'] ?? '') ?>">
          </span>
          <div id="qbit-user-warning" class="field-warning">⚠️ Username is required</div>
        </div>
      </div>

      <div class="form-pair">
        <label for="qbit_pass" <span title="Qbittorrent webui password" class="automovertip">Password:</span>
        </label>
        <div class="input-wrapper">
          <span title="Qbittorrent webui password" class="automovertip">
            <input type="password" id="qbit_pass"
              value="<?php echo htmlspecialchars($settings['QBITTORRENT_PASSWORD'] ?? '') ?>">
          </span>
          <div id="qbit-pass-warning" class="field-warning">⚠️ Password is required</div>
        </div>
      </div>

      <div class="form-pair">
        <label for="qbit_days_from" <span title="Torrents newer than this age (days) will be ignored"
          class="automovertip">Days From:</span>
        </label>
        <div class="input-wrapper">
          <span title="Torrents newer than this age (days) will be ignored" class="automovertip">
            <input type="number" id="qbit_days_from" class="short-input" min="0" max="999" step="1"
              value="<?php echo htmlspecialchars($settings['QBITTORRENT_DAYS_FROM'] ?? '') ?>">
          </span>
          <div id="qbit-days-from-warning" class="field-warning">⚠️ Must be a number between 0 and 999</div>
        </div>
      </div>

      <div class="form-pair">
        <label for="qbit_days_to" <span title="Torrents older than this age (days) will be ignored"
          class="automovertip">Days To:</span>
        </label>
        <div class="input-wrapper">
          <span title="Torrents older than this age (days) will be ignored" class="automovertip">
            <input type="number" id="qbit_days_to" class="short-input" min="1" max="999" step="1"
              value="<?php echo htmlspecialchars($settings['QBITTORRENT_DAYS_TO'] ?? '') ?>">
          </span>
          <div id="qbit-days-to-warning" class="field-warning">⚠️ Must be a number between 1 and 999</div>
          <div id="qbit-days-order-warning" class="field-warning">⚠️ Days From cannot be equal or lower than Days To
          </div>
        </div>
      </div>

      <div class="form-pair">
        <label for="qbit_status" <span title="Which status of torrents to act on" class="automovertip">Status:</span>
        </label>
        <span title="Which status of torrents to act on" class="automovertip">
          <select id="qbit_status">
            <?php
        $statuses = [
          'completed', 'all', 'downloading', 'seeding', 'paused', 'stopped',
          'active', 'inactive', 'resumed', 'running', 'stalled', 'stalled_uploading',
          'stalled_downloading', 'checking', 'moving', 'errored'
        ];
        foreach ($statuses as $status) {
            $selected = ($settings['QBITTORRENT_STATUS'] ?? 'completed') === $status ? 'selected' : '';
            echo "<option value=\"$status\" $selected>$status</option>";
        }
        ?>
          </select>
        </span>
      </div>

      <div class="form-pair" id="hashPathRow" style="display:none;">
        <label for="HASH_PATH" <span title="Pick a share to save the jdupes hash database" class="automovertip">Hash
          Location:</span>
        </label>
        <span title="Pick a share to save the jdupes hash database" class="automovertip">
          <select id="HASH_PATH" name="HASH_PATH">
            <?php
        $sharesFile = '/var/local/emhttp/shares.ini';
        $default = '/mnt/user/appdata';
        $current = $settings['HASH_PATH'] ?? $default;

        if (file_exists($sharesFile)) {
          $shares = parse_ini_file($sharesFile, true);
          foreach ($shares as $shareName => $shareData) {
            $path = "/mnt/user/$shareName";
            $selected = ($current === $path || (!isset($settings['HASH_PATH']) && $shareName === 'appdata')) ? 'selected' : '';
            echo "<option value=\"$path\" $selected>$shareName</option>";
          }
        } else {
          // Fallback when shares.ini isn't found
          $options = ['appdata', 'system', 'domains', 'isos'];
          foreach ($options as $shareName) {
            $path = "/mnt/user/$shareName";
            $selected = ($current === $path || (!isset($settings['HASH_PATH']) && $shareName === 'appdata')) ? 'selected' : '';
            echo "<option value=\"$path\" $selected>$shareName</option>";
          }
        }
      ?>
          </select>
        </span>
      </div>

    </div>

    <!-- Exclusions row (appears below Interval when enabled) -->
    <div class="form-pair" id="exclusions-row" style="display:none;">
      <label for="exclusions-field" <span title="Open the file picker to add or remove excluded paths"
        class="automovertip">Exclusions:</span>
      </label>
      <div class="input-wrapper">
        <span title="Open the file picker to add or remove excluded paths" class="automovertip">
          <input id="exclusions-field" type="text" readonly value="Click to open file picker"
            title="Click to open file picker">
        </span>
        <span title="Open to view/edit exclusions" class="automovertip">
          <button id="viewExclusionsBtn" type="button">Exclusions List</button>
        </span>
      </div>
    </div>

    <div id="exclusion-view-modal" style="display:none; position:fixed; top:0; left:0; right:0; bottom:0;
  background:rgba(0,0,0,0.8); z-index:9999; align-items:center; justify-content:center;">
      <div class="modal-body"
        style="background:#111; color:white; padding:20px; border-radius:10px;
  width:600px; min-width: fit-content; max-width: 100%; height:600px; min-height: fit-content; max-height: 100%; overflow:hidden; display:flex; flex-direction:column;">
        <h3 style="margin-top:0;">View/Edit Exclusions</h3>
        <p style="margin-top:4px; margin-bottom:10px; color:#aaa; font-style:italic; font-size:13px;">
          * Only paths to pool disks will work. Can do individual files or full directory paths for example
          /mnt/cache/data/test.txt or /mnt/cache/data. <br> Do not use array disk paths like /mnt/disk1 or /mnt/user or
          /mnt/user0 paths
        </p>

        <textarea id="exclusionsEditor" style="
      background:#000; color:#fff; font-family:monospace;
      border:1px solid #333; border-radius:6px; padding:10px; resize:none;
      width:97%; height:480px; overflow-y:auto;"></textarea>

        <div style="display:flex; justify-content:space-between; margin-top:auto; padding-top:0px;">
          <div>
            <!-- Copy button now matches 'Remove Selected' style -->
            <button id="copyExclusionsBtn" type="button" style="
      background:#444;
      color:#fff;
      border:none;
      border-radius:6px;
      cursor:pointer;
      padding:8px 12px;
      font-weight:500;
    ">Copy</button>

            <!-- Save button now matches 'Add Selected' style -->
            <button id="saveExclusionsBtn" type="button" style="
      background:#0b5fff;
      color:#fff;
      border:none;
      border-radius:6px;
      cursor:pointer;
      padding:8px 12px;
      font-weight:600;
    ">Save</button>
          </div>

          <!-- Close button unchanged -->
          <button id="closeExclusionsView" type="button" style="
  background:#b54708;
  color:#fff;
  border:none;
  border-radius:6px;
  cursor:pointer;
  padding:8px 12px;
  font-weight:600;
  box-shadow:0 0 6px rgba(0,0,0,0.4);
">Close</button>
        </div>
      </div>
    </div>

    <!-- Pre Script Path -->
    <div class="form-pair" id="pre-script-row" style="display:none;">
      <label for="pre_script">
        <span title="Script to run at the beginning of every session" class="automovertip">
          Pre-Move Script:
        </span>
      </label>
      <div class="input-wrapper">
        <span title="Script to run at the beginning of every session" class="automovertip">
          <input type="text" id="pre_script" placeholder="/mnt/user/scripts/pre_move.sh"
            value="<?php echo htmlspecialchars($settings['PRE_SCRIPT'] ?? ''); ?>">
        </span>
      </div>
    </div>

    <!-- Post Script Path -->
    <div class="form-pair" id="post-script-row" style="display:none;">
      <label for="post_script">
        <span title="Script to run at the end of the session regardless if anything moves or not" class="automovertip">
          Post-Move Script:
        </span>
      </label>
      <div class="input-wrapper">
        <span title="Script to run at the end of the session regardless if anything moves or not" class="automovertip">
          <input type="text" id="post_script" placeholder="/mnt/user/scripts/post_move.sh"
            value="<?php echo htmlspecialchars($settings['POST_SCRIPT'] ?? ''); ?>">
        </span>
      </div>
    </div>

    <!-- Checkboxes row -->
    <div class="checkbox-row">
      <span title="Start Automover automatically when Unraid boots" class="automovertip">
        <label>
          <input type="checkbox" id="autostart" <?php echo ($settings['AUTOSTART'] ?? '' )==='yes' ? 'checked' : '' ?>>
          Autostart on Boot
        </label>
      </span>

      <span title="Enable an exclusions list of files and folders that won't be moved" class="automovertip">
        <label>
          <input type="checkbox" id="enable_exclusions" <?php echo ($settings['EXCLUSIONS_ENABLED'] ?? '' )==='yes'
            ? 'checked' : '' ?>> Enable Exclusions
        </label>
      </span>

      <span title="Allow Automover to run even when Unraid is doing a parity check" class="automovertip">
        <label>
          <input type="checkbox" id="allow_during_parity" <?php echo ($settings['ALLOW_DURING_PARITY'] ?? '' )==='yes'
            ? 'checked' : '' ?>> Allow During Parity
        </label>
      </span>

      <span title="Enable to move files only if older than the specified amount of days old" class="automovertip">
        <label>
          <input type="checkbox" id="age_based_filter" <?php echo ($settings['AGE_BASED_FILTER'] ?? '' )==='yes'
            ? 'checked' : '' ?>> Enable Age Based Filter
        </label>
      </span>

      <span title="Enable to simulate moves without actually transferring files" class="automovertip">
        <label>
          <input type="checkbox" id="dry_run" <?php echo ($settings['DRY_RUN'] ?? '' )==='yes' ? 'checked' : '' ?>> Dry
          Run
        </label>
      </span>

      <span title="Enable to move only files larger than the specified size in MB" class="automovertip">
        <label>
          <input type="checkbox" id="size_based_filter" <?php echo ($settings['SIZE_BASED_FILTER'] ?? '' )==='yes'
            ? 'checked' : '' ?>> Enable Size Based Filter
        </label>
      </span>

      <span title="Enable to pause qbittorrent torrents before move and resume after" class="automovertip">
        <label>
          <input type="checkbox" id="qbit_script" <?php echo ($settings['QBITTORRENT_SCRIPT'] ?? '' )==='yes'
            ? 'checked' : '' ?>> Enable Qbit Script
        </label>
      </span>

      <span title="Skip hidden files and folders (those starting with a dot)" class="automovertip">
        <label>
          <input type="checkbox" id="hidden_filter" <?php echo ($settings['HIDDEN_FILTER'] ?? '' )==='yes' ? 'checked'
            : '' ?>> Enable Hidden Filter
        </label>
      </span>

      <span title="Force Unraid to use reconstructive (turbo) write mode during file moves" class="automovertip">
        <label>
          <input type="checkbox" id="force_reconstructive_write" <?php echo ($settings['FORCE_RECONSTRUCTIVE_WRITE']
            ?? '' )==='yes' ? 'checked' : '' ?>> Force Turbo Write
        </label>
      </span>

      <span title="Enable to remove empty folders and datasets from shares that are moved" class="automovertip">
        <label>
          <input type="checkbox" id="enable_cleanup" <?php echo ($settings['ENABLE_CLEANUP'] ?? '' )==='yes' ? 'checked'
            : '' ?>> Enable Cleanup
        </label>
      </span>

      <span
        title="Enable this if you want jdupes to run a fix-hardlinks scan on the shares moved. Exclusions for appdata, system, domains, and isos"
        class="automovertip">
        <label>
          <input type="checkbox" id="ENABLE_JDUPES" <?php echo ($settings['ENABLE_JDUPES'] ?? '' )==='yes' ? 'checked'
            : '' ; ?>> Enable Jdupes
        </label>
      </span>

      <span title="Send Unraid system notifications when Automover starts and finishes" class="automovertip">
        <label>
          <input type="checkbox" id="enable_notifications" <?php echo ($settings['ENABLE_NOTIFICATIONS'] ?? '' )==='yes'
            ? 'checked' : '' ?>>
          Enable Notifications
        </label>
      </span>

      <span title="Enable running a session start and session end script which runs regardless of filters enabled"
        class="automovertip">
        <label>
          <input type="checkbox" id="enable_scripts" name="ENABLE_SCRIPTS" <?php echo (($settings['ENABLE_SCRIPTS']
            ?? 'no' )==='yes' ) ? 'checked' : '' ; ?>>
          Enable Pre/Post Scripts
        </label>
      </span>

      <span title="Enable ssd trim to run after the move completes" class="automovertip">
        <label>
          <input type="checkbox" id="enable_trim_toggle" name="ENABLE_TRIM" <?php echo (($settings['ENABLE_TRIM']
            ?? 'no' )==='yes' ) ? 'checked' : '' ; ?>>
          Enable SSD Trim
        </label>
      </span>

      <span title="Enable to show a manual move section below" class="automovertip">
        <label>
          <input type="checkbox" id="manual_move_toggle" <?php echo ($settings['MANUAL_MOVE'] ?? 'no' )==='yes'
            ? 'checked' : '' ; ?>>
          Manual Move
        </label>
      </span>
    </div>

    <div id="python-warning" data-python-installed="<?php echo file_exists('/usr/bin/python3') ? '1' : '0'; ?>" style="display:none; color:red; padding:8px 12px; border-radius:6px;
            margin-top:8px; font-weight:600; font-size:14px;">
      ⚠️ Python3 is not installed and this option requires it. Install it from the Apps page.
    </div>
  </form>

  <div id="moved-log-container">
    <div class="log-header-row">
      <h3>Files Moved</h3>
      <div class="toast-wrapper">
        <span title="Clear the files moved log" class="automovertip">
          <button id="clear-mover-log">Clear Log</button>
        </span>
        <div id="toast-mover" class="toast-inline"></div>
      </div>
    </div>
    <div id="log-counts" class="log-stats" style="margin-top:-10px;"></div>
    <input type="text" id="log-filter" class="short-input-filter" placeholder="🔍 Filter keyword"
      style="margin-bottom:12px;">
    <pre id="automover-log">Loading</pre>
  </div>

  <div id="last-run-container">
    <div class="log-header-row">
      <h3>Last Run Details</h3>
      <div class="toast-wrapper">
        <span title="Clear the last run details log" class="automovertip">
          <button id="clear-last-run-log">Clear Log</button>
        </span>
        <div id="toast-last" class="toast-inline"></div>
      </div>
    </div>
    <pre id="last-run-log">Loading last run log</pre>
  </div>
</div>

<!-- Modal -->
<div id="exclusion-modal">
  <div class="box">
    <div class="header">
      <button class="btn secondary" id="btn-up" title="Go up directory">↑ Up</button>
      <div class="crumbs" id="crumbs"></div>
    </div>

    <div class="grid" id="picker-grid"></div>

    <!-- ✅ Footer updated with Close button on bottom-right -->
    <div class="footer" style="display:flex; justify-content:space-between; margin-top:10px; align-items:flex-end;">
      <!-- Left side: Add/Remove buttons -->
      <div style="display:flex; flex-direction:column; gap:2px; line-height:1;">
        <!-- Row 1: Normal buttons -->
        <div style="display:flex; align-items:center; gap:6px; margin:0; padding:0;">
          <button id="btn-add" class="btn primary">Add Selected</button>
          <button id="btn-remove" class="btn secondary">Remove Selected</button>
        </div>

        <!-- Row 2: Wildcard buttons -->
        <div style="display:flex; align-items:center; gap:6px; margin:0; padding:0;">
          <button id="addExtBtn" type="button" class="btn primary" style="display:none; padding:6px 12px;">
            Add extensions as wildcards
          </button>
          <button id="removeExtBtn" type="button" class="btn secondary" style="display:none; padding:6px 12px;">
            Remove extensions as wildcards
          </button>
        </div>
      </div>

      <!-- Right side: Close button -->
      <div style="display:flex; justify-content:flex-end; align-items:flex-end;">
        <button class="btn warn" id="btn-close" style="padding:8px 12px; font-weight:600;">Close</button>
      </div>
    </div>

    <!-- Toast container -->
    <div id="toast-container" style="position:static; bottom:5px; right:15px;
                display:flex; flex-direction:column; align-items:flex-end;
                gap:6px; z-index:99999;">
    </div>
  </div>
</div>

<!-- ==========================
     MANUAL MOVE SECTION
     ========================== -->
<div class="manual-move-toggle-wrapper">
  <div id="manual-move-section" style="display:none; background:#111; padding:20px; border-radius:12px;
            box-shadow:0 0 12px rgba(0,128,128,.3); margin-bottom:20px;">

    <h3 style="color:var(--primary-blue); margin-top:0;">Manual Move</h3>

    <!-- Source -->
    <div class="form-pair">
      <label for="manual_source"> <span title="Source folder to move or copy"
          class="automovertip">Source:</label></span>
      <div class="input-wrapper">
        <span title="Source folder to move or copy" class="automovertip">
          <input type="text" id="manual_source" readonly placeholder="Select source">
        </span>
        <div id="manual-source-error" class="manual-error-toast">⚠️ Source is required</div>
      </div>
    </div>

    <!-- Destination -->
    <div class="form-pair">
      <label for="manual_dest"> <span title="Destination folder for the move or copy"
          class="automovertip">Destination:</label></span>
      <div class="input-wrapper">
        <span title="Destination folder for the move or copy" class="automovertip">
          <input type="text" id="manual_dest" readonly placeholder="Select destination">
        </span>
        <div id="manual-dest-error" class="manual-error-toast">⚠️ Destination is required</div>
      </div>
    </div>

    <!-- Options Row -->
    <div style="display:flex; gap:10px; margin-top:10px;">

      <span
        title="Uses rsync -aH /src/ /dst/ as the command which only copies to destination new or modified while preserving hardlinks"
        class="automovertip">
        <label class="form-check">
          <input type="checkbox" id="manual_copy">
          Copy
        </label>
      </span>

      <span
        title="Uses rsync -aH --remove-source-files /src/ dst/ as the command which copies new or modified to destination while preserving hardlinks and after successful transfer deletes the files from source that were transferred"
        class="automovertip">
        <label class="form-check">
          <input type="checkbox" id="manual_delete">
          Delete Source After
        </label>
      </span>

      <span
        title="Uses rsync -aH --delete /src/ /dst/ as the command which keep destination in full sync with source deleting anything on destination that is not currently on source"
        class="automovertip">
        <label class="form-check">
          <input type="checkbox" id="manual_fullsync">
          Full Sync
        </label>
    </div>
    </span>
    <div id="manual-options-error" class="manual-error-toast manual-error-wide">
      ⚠️ One of the three options is required
    </div>

    <div style="margin-top:4px; max-width: 360px; color:#aaa; font-size:12px;">
      <div>*Only dry run, enable cleanup, and enable notifications from above options are used and all others are
        ignored</div>
    </div>

    <span title="Starts the manual rsync process" class="automovertip">
      <button type="button" id="start-manual-rsync" class="button button-primary" style="padding:8px 16px;">
        Start
      </button>
    </span>

    <div id="manual-move-confirmation" style="display:none; margin-top:10px; background:var(--primary-blue);
              padding:6px 10px; border-radius:6px; font-weight:bold;">
      ✅ Manual Move Started
    </div>
  </div>
</div>

</div>

<!-- ======================= -->
<!--   PATH PICKER MODAL     -->
<!-- ======================= -->
<div id="path-picker-modal" style=" 
    position: fixed;
    top: 0; left: 0;
    width: 100%; height: 100%;
    background: rgba(0,0,0,0.75);
    display: none;
    z-index: 999999;
    justify-content: center;
    align-items: center;
">

  <div style="
    width: 700px;
    height: 520px;
    padding: 12px;
    display:flex;
    flex-direction: column;
    border: 1px solid var(--primary-blue);
    border-radius: 12px;
	  overflow: hidden;
    background:#111
">
    <!-- Row 1: Title only -->
    <div style="display:flex;">
      <strong style="flex:1; font-size: 14px; color: #3ca8ff;">Select Path</strong>
    </div>

    <!-- Row 2: Up (left) + Close (right) -->
    <div style="display:flex; margin-top: 8px;">
      <button id="picker-up" class="button" style="margin-right:auto;">⬆ Up</button>
      <button id="picker-close" class="button">Close</button>
    </div>

    <div id="manual-picker-crumbs" style="
            padding: 10px 12px;
            font-size: 14px;
            color: #ccc;
            overflow-x: auto;
            white-space: nowrap;
        "></div>

    <div id="manual-picker-grid" style="
            flex: 1;
            overflow-y: auto;
            padding: 8px 12px;
        "></div>

    <!-- FOOTER (Row 1 + Row 2) -->
    <div style="padding:1px;">

      <!-- ROW 1: Create Folder (left) + Add / Clear (right) -->
      <div style="display:flex; justify-content:space-between; align-items:center;">

        <!-- Left -->
        <button id="picker-create-folder" class="button button-primary">
          Create Folder
        </button>

        <!-- Right -->
        <div>
          <button id="picker-clear" class="button">Clear Selected</button>
          <button id="picker-add" class="button button-primary">Add Selected</button>
        </div>

      </div>

      <!-- ROW 2 (hidden unless creating folder) -->
      <div id="picker-newfolder-row" style="display:none; margin-top:10px; align-items:center; gap:8px;">

        <input id="picker-newfolder-input" type="text" placeholder="New folder name" style="background:#000; color:#fff; border:1px solid var(--primary-blue);
                  padding:6px 8px; border-radius:6px; width:200px;">

        <button id="picker-newfolder-confirm" class="button button-primary" style="padding:6px 10px;">Create</button>

        <button id="picker-newfolder-cancel" class="button" style="padding:6px 10px;">Cancel</button>
      </div>
    </div>

  </div>
</div>

<script>
  const stopBadge = document.getElementById('stop-confirmation');

  function updateStatus() {
    fetch('/plugins/automover/helpers/status_check.php')
      .then(res => res.json())
      .then(data => {
        document.getElementById('status-text').textContent = data.status;
        document.getElementById('last-run-text').textContent = data.last_run;
      })
      .catch(() => { document.getElementById('status-text').textContent = 'No details available'; });
  }
  updateStatus();
  setInterval(updateStatus, 5000);

  // === Poll for Automover completion (done flag) ===
  function checkAutomoverDone() {
    fetch('/plugins/automover/helpers/check_done.php', { cache: 'no-store' })
      .then(res => res.json())
      .then(data => {
        if (data.done) {
          const buttons = [
            document.getElementById('save-settings'),
            document.getElementById('moveNowBtn'),
          ];
          buttons.forEach(btn => {
            if (!btn) return;
            btn.disabled = false;
            btn.style.backgroundColor = '';
            btn.style.opacity = '1';
            btn.style.cursor = 'pointer';
          });
        }
      })
      .catch(() => { });
  }

  // run every 5s like your status updates
  setInterval(checkAutomoverDone, 5000);

  // Disable only Save & Start and Move Now
  function checkAutomoverLock() {
    fetch('/plugins/automover/helpers/check_lock.php', { cache: 'no-store' })
      .then(res => res.json())
      .then(data => {
        const locked = data.locked === true;

        // These get disabled during an active move
        const disableButtons = ['save-settings', 'moveNowBtn'];

        disableButtons.forEach(id => {
          const el = document.getElementById(id);
          if (el) {
            el.disabled = locked;
            el.style.opacity = locked ? '0.5' : '1';
            el.style.cursor = locked ? 'not-allowed' : 'pointer';
          }
        });

        // STOP BUTTON must always be enabled
        const stopBtn = document.getElementById('stop-button');
        if (stopBtn) {
          stopBtn.disabled = false;
          stopBtn.style.opacity = '1';
          stopBtn.style.cursor = 'pointer';
        }
      })
      .catch(() => { });
  }

  // Run once immediately, then every 5s (same as status polling)
  document.addEventListener('DOMContentLoaded', () => {
    checkAutomoverLock();
    setInterval(checkAutomoverLock, 5000);
  });

  document.addEventListener('DOMContentLoaded', function () {
    const form = document.getElementById('automover-settings');
    const poolSelect = document.getElementById('pool');
    const thresholdInput = document.getElementById('threshold');
    const stopThresholdInput = document.getElementById('stop_threshold');
    stopThresholdInput.addEventListener('input', () =>
      validateField(stopThresholdInput, { min: 0, max: 100 }, 'stop-threshold-warning')
    );
    const saveBtn = document.getElementById('save-settings');
    const confirmBadge = document.getElementById('save-confirmation');
    const moveNowBtn = document.getElementById('moveNowBtn');
    const moveNowBadge = document.getElementById('move-now-confirmation');
    let currentPoolSelection = poolSelect.dataset.selected || '';
    const ageFilterCheckbox = document.getElementById('age_based_filter');
    const ageDaysContainer = document.getElementById('age-days-container');
    const sizeFilterCheckbox = document.getElementById('size_based_filter');
    const sizeMbContainer = document.getElementById('size-mb-container');
    // === Manual Move Toggle State Persistence ===
    const manualMoveToggle = document.getElementById('manual_move_toggle');
    const manualMoveSection = document.getElementById('manual-move-section');

    // Set initial visibility based on checkbox state
    manualMoveSection.style.display = manualMoveToggle.checked ? 'block' : 'none';

    // Live toggle when checkbox is clicked
    manualMoveToggle.addEventListener('change', function () {
      manualMoveSection.style.display = this.checked ? 'block' : 'none';
    });

    // === Live validation for Discord Webhook URL (prefix-based) ===
    const webhookInput = document.getElementById('webhook_url');
    const webhookWarning = document.getElementById('webhook-warning');

    if (webhookInput && webhookWarning) {
      webhookInput.addEventListener('input', function () {
        const value = this.value.trim();

        // empty is allowed
        let valid = (value === '');

        // allow either discord.com or discordapp.com prefix
        if (value.startsWith('https://discord.com/api/webhooks/') ||
          value.startsWith('https://discordapp.com/api/webhooks/')) {
          valid = true;
        }

        if (!valid) {
          this.classList.add('invalid');
          webhookWarning.style.display = 'block';
          webhookWarning.style.opacity = '1';
        } else {
          this.classList.remove('invalid');
          webhookWarning.style.opacity = '0';
          setTimeout(() => {
            webhookWarning.style.display = 'none';
          }, 200);
        }
      });
    }

    // === Discord Webhook visibility control (safe) ===
    const enableNotificationsCheckbox = document.getElementById('enable_notifications');

    // try both dash and underscore, in case HTML used one or the other
    const webhookRow =
      document.getElementById('webhook-row') ||
      document.getElementById('webhook_row');

    if (enableNotificationsCheckbox && webhookRow) {
      // set initial state on load
      webhookRow.style.display = enableNotificationsCheckbox.checked ? 'flex' : 'none';

      // update on change
      enableNotificationsCheckbox.addEventListener('change', function () {
        webhookRow.style.display = this.checked ? 'flex' : 'none';
      });
    }



    moveNowBtn.addEventListener('click', () => {
      // Trigger the move action (you may already have this logic elsewhere)
      fetch('/plugins/automover/helpers/run_manual_move.php', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/x-www-form-urlencoded',
          'X-CSRF-TOKEN': csrfToken
        },
        body: 'csrf_token=' + encodeURIComponent(csrfToken)
      })
        .then(res => res.json())
        .then(data => {
          if (data.ok) {
            moveNowBadge.style.display = 'block';
            moveNowBadge.style.opacity = '1';
            moveNowBadge.style.animation = 'flash 0.4s ease';

            setTimeout(() => {
              moveNowBadge.style.opacity = '0';
              moveNowBadge.style.animation = '';
              setTimeout(() => {
                moveNowBadge.style.display = 'none'; // ✅ Collapse space after fade
              }, 400); // match transition duration
            }, 2000);
          } else {
            alert('Move Now failed: ' + (data.error || 'Unknown error'));
          }
        })
        .catch(err => {
          console.error('Move Now error:', err);
          alert('Move Now failed');
        });
    });

// --- Scheduling Dropdown Toggle ---
(function waitForSchedulingToggle() {
  function initSchedulingToggle() {
    const cronModeSelect = document.getElementById('cron_mode');

    // Option rows
    const minutesOptions = document.getElementById('minutes-options');
    const hourlyOptions  = document.getElementById('hourly-options');
    const dailyOptions   = document.getElementById('daily-options');
    const weeklyOptions  = document.getElementById('weekly-options');
    const monthlyOptions = document.getElementById('monthly-options');
    const customOptions  = document.getElementById('custom-options');

    // Inputs
    const minutesFreq = document.getElementById('minutes_frequency');
    const hourlyFreq  = document.getElementById('hourly_frequency');
    const dailyTime   = document.getElementById('daily_time');
    const weeklyDay   = document.getElementById('weekly_day');
    const weeklyTime  = document.getElementById('weekly_time');
    const monthlyDay  = document.getElementById('monthly_day');
    const monthlyTime = document.getElementById('monthly_time');
    const customCron  = document.getElementById('custom_cron');

    if (!cronModeSelect) return false;

    // Toggle which sub-options are visible
    function toggleCronOptions(value) {
      minutesOptions.style.display = (value === 'minutes') ? 'block' : 'none';
      hourlyOptions.style.display  = (value === 'hourly')  ? 'block' : 'none';
      dailyOptions.style.display   = (value === 'daily')   ? 'block' : 'none';
      weeklyOptions.style.display  = (value === 'weekly')  ? 'block' : 'none';
      monthlyOptions.style.display = (value === 'monthly') ? 'block' : 'none';
      customOptions.style.display  = (value === 'custom')  ? 'block' : 'none';
      updateCronExpression();
    }

    // Build cron string from dropdowns
    function updateCronExpression() {
      let cronString = "";

      if (cronModeSelect.value === "minutes" && minutesFreq) {
        const freq = parseInt(minutesFreq.value, 10);
        cronString = `*/${freq} * * * *`;
      }
      else if (cronModeSelect.value === "hourly" && hourlyFreq) {
        const freq = parseInt(hourlyFreq.value, 10);
        cronString = `0 */${freq} * * *`;
      }
      else if (cronModeSelect.value === "daily" && dailyTime) {
        const [hour, minute] = dailyTime.value.split(":");
        cronString = `${parseInt(minute, 10)} ${parseInt(hour, 10)} * * *`;
      }
      else if (cronModeSelect.value === "weekly" && weeklyDay && weeklyTime) {
        const [hour, minute] = weeklyTime.value.split(":");
        const dayMap = {
          Sunday: 0, Monday: 1, Tuesday: 2, Wednesday: 3,
          Thursday: 4, Friday: 5, Saturday: 6
        };
        cronString = `${parseInt(minute, 10)} ${parseInt(hour, 10)} * * ${dayMap[weeklyDay.value]}`;
      }
      else if (cronModeSelect.value === "monthly" && monthlyDay && monthlyTime) {
        const [hour, minute] = monthlyTime.value.split(":");
        const day = parseInt(monthlyDay.value, 10);
        cronString = `${parseInt(minute, 10)} ${parseInt(hour, 10)} ${day} * *`;
      }
      else if (cronModeSelect.value === "custom" && customCron) {
        cronString = customCron.value.trim();
      }

      // Store cron string in hidden input
      let hidden = document.getElementById("cron_expression_hidden");
      if (!hidden) {
        hidden = document.createElement("input");
        hidden.type = "hidden";
        hidden.id = "cron_expression_hidden";
        hidden.name = "CRON_EXPRESSION";
        cronModeSelect.closest(".form-pair").appendChild(hidden);
      }
      hidden.value = cronString;
    }

    // Initialize visibility
    toggleCronOptions(cronModeSelect.value);

    // Event listeners
    cronModeSelect.addEventListener('change', (e) => toggleCronOptions(e.target.value));
    minutesFreq?.addEventListener('change', updateCronExpression);
    hourlyFreq?.addEventListener('change', updateCronExpression);
    dailyTime?.addEventListener('change', updateCronExpression);
    weeklyDay?.addEventListener('change', updateCronExpression);
    weeklyTime?.addEventListener('change', updateCronExpression);
    monthlyDay?.addEventListener('change', updateCronExpression);
    monthlyTime?.addEventListener('change', updateCronExpression);
    customCron?.addEventListener('input', updateCronExpression);

    return true;
  }

  if (!initSchedulingToggle()) {
    const observer = new MutationObserver(() => {
      if (initSchedulingToggle()) observer.disconnect();
    });
    observer.observe(document.body, { childList: true, subtree: true });
  }
})();

    // === Toggle HASH_PATH dropdown visibility based on ENABLE_JDUPES ===
    const enableJdupesCheckbox = document.getElementById('ENABLE_JDUPES');
    const hashPathRow = document.getElementById('hashPathRow');
    const hashPathSelect = document.getElementById('HASH_PATH');

    function toggleHashPath() {
      if (enableJdupesCheckbox.checked) {
        hashPathRow.style.display = '';

        // Default to appdata if nothing selected
        if (!hashPathSelect.value || hashPathSelect.value.trim() === '') {
          for (const option of hashPathSelect.options) {
            if (option.text.toLowerCase() === 'appdata') {
              hashPathSelect.value = option.value;
              break;
            }
          }
        }
      } else {
        hashPathRow.style.display = 'none';
        hashPathSelect.value = '';
      }
    }

    enableJdupesCheckbox.addEventListener('change', toggleHashPath);
    window.addEventListener('DOMContentLoaded', toggleHashPath);

    // NEW: exclusions UI
    const enableExcl = document.getElementById('enable_exclusions');
    const exclRow = document.getElementById('exclusions-row');
    const exclField = document.getElementById('exclusions-field');
    const exclCount = document.getElementById('exclusions-count');

    function toggleAgeInput() { ageDaysContainer.style.display = ageFilterCheckbox.checked ? 'flex' : 'none'; }
    ageFilterCheckbox.addEventListener('change', toggleAgeInput); toggleAgeInput();

    function toggleSizeInput() { sizeMbContainer.style.display = sizeFilterCheckbox.checked ? 'flex' : 'none'; }
    sizeFilterCheckbox.addEventListener('change', toggleSizeInput); toggleSizeInput();

    function refreshExclusionsVisibility() {
      exclRow.style.display = enableExcl.checked ? 'flex' : 'none';
      if (enableExcl.checked) refreshExclusionCount();
    }
    enableExcl.addEventListener('change', refreshExclusionsVisibility);
    refreshExclusionsVisibility();

    // === QBITTORRENT FIELD TOGGLE ===
    const qbitCheckbox = document.getElementById('qbit_script');
    const qbitFields = document.getElementById('qbit-fields');
    function toggleQbitFields() {
      qbitFields.style.display = qbitCheckbox.checked ? 'block' : 'none';
    }
    qbitCheckbox.addEventListener('change', toggleQbitFields);
    toggleQbitFields();

    // === PRE/POST SCRIPT FIELDS TOGGLE ===
    const enableScripts = document.getElementById("enable_scripts");
    const preRow = document.getElementById("pre-script-row");
    const postRow = document.getElementById("post-script-row");

    function updateScriptVisibility() {
      if (!enableScripts || !preRow || !postRow) return;

      const show = enableScripts.checked;
      preRow.style.display = show ? "flex" : "none";
      postRow.style.display = show ? "flex" : "none";
    }

    enableScripts?.addEventListener("change", updateScriptVisibility);
    updateScriptVisibility();

    // --- element refs
    const viewBtn = document.getElementById('viewExclusionsBtn');
    const viewModal = document.getElementById('exclusion-view-modal');
    const viewClose = document.getElementById('closeExclusionsView');
    const editor = document.getElementById('exclusionsEditor');
    const copyBtn = document.getElementById('copyExclusionsBtn');
    const exclusionssaveBtn = document.getElementById('saveExclusionsBtn');

    // --- toast inside modal
    const exclusionstoast = document.createElement('div');
    exclusionstoast.id = 'exclToast';
    exclusionstoast.style.position = 'absolute';
    exclusionstoast.style.bottom = '28px';
    exclusionstoast.style.left = '50%';
    exclusionstoast.style.transform = 'translateX(-50%)';
    exclusionstoast.style.color = '#00ff99';
    exclusionstoast.style.padding = '8px 14px';
    exclusionstoast.style.borderRadius = '6px';
    exclusionstoast.style.fontWeight = '600';
    exclusionstoast.style.display = 'none';
    exclusionstoast.style.zIndex = '10';
    if (viewModal) viewModal.querySelector('div').appendChild(exclusionstoast);

    function showexclusionstoast(msg, type = 'ok') {
      exclusionstoast.textContent = msg;
      exclusionstoast.style.color = (type === 'ok') ? '#00ff99' : '#ff5555';
      exclusionstoast.style.display = 'block';
      clearTimeout(showexclusionstoast._t);
      showexclusionstoast._t = setTimeout(() => { exclusionstoast.style.display = 'none'; }, 1800);
    }

    // prevent form submits if buttons live in a <form>
    [viewBtn, copyBtn, exclusionssaveBtn, viewClose].forEach(b => {
      if (b) b.setAttribute('type', 'button');
    });

    // --- open modal and load file
    viewBtn.addEventListener('click', e => {
      e.preventDefault();
      viewModal.style.display = 'flex';

      fetch('/plugins/automover/helpers/manage_exclusions.php?action=get' +
        (typeof csrfToken !== 'undefined'
          ? '&csrf_token=' + encodeURIComponent(csrfToken)
          : ''), { cache: 'no-store' })
        .then(r => r.json())
        .then(data => {
          if (data.ok) {
            editor.value = (data.content || '').trim();
          } else {
            editor.value = data.error || '(Error loading exclusions.txt)';
            showexclusionstoast('Error loading file', 'err');
          }
        })
        .catch(err => {
          console.error('GET error:', err);
          editor.value = '(Error loading exclusions.txt)';
          showexclusionstoast('Fetch error', 'err');
        });
    });

    // --- copy (with fallback)
    copyBtn.addEventListener('click', e => {
      e.preventDefault();
      const txt = editor.value || '';

      function fallbackCopy() {
        const ta = document.createElement('textarea');
        ta.value = txt;
        ta.style.position = 'fixed';
        ta.style.left = '-9999px';
        document.body.appendChild(ta);
        ta.select();
        try {
          document.execCommand('copy');
          showexclusionstoast('✅ Copied!');
        } catch {
          showexclusionstoast('Copy failed', 'err');
        }
        document.body.removeChild(ta);
      }

      if (navigator.clipboard && window.isSecureContext) {
        navigator.clipboard.writeText(txt)
          .then(() => showexclusionstoast('Copied!'))
          .catch(() => fallbackCopy());
      } else {
        fallbackCopy();
      }
    });

    // --- save
    exclusionssaveBtn.addEventListener('click', e => {
      e.preventDefault();
      const content = editor.value || '';

      fetch('/plugins/automover/helpers/manage_exclusions.php?action=save', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/x-www-form-urlencoded',
          'X-CSRF-TOKEN': csrfToken        // header Unraid validates
        },
        body: 'csrf_token=' + encodeURIComponent(csrfToken) +
          '&content=' + encodeURIComponent(content)
      })
        .then(r => r.text())
        .then(text => {
          let data;
          try { data = JSON.parse(text); } catch { throw new Error(text || 'No response'); }
          if (data.ok) showexclusionstoast('✅ Save successful');
          else showexclusionstoast(data.error || 'Save failed', 'err');
        })
        .catch(err => {
          console.error('Save fetch error:', err);
          showexclusionstoast('Save failed', 'err');
        });

    });

    // --- close modal
    viewClose.addEventListener('click', e => {
      e.preventDefault();
      viewModal.style.display = 'none';
    });

    // Pool list
    function updatePoolUsage() {
      fetch('/plugins/automover/helpers/pool_usage.php')
        .then(res => res.json())
        .then(data => {
          poolSelect.innerHTML = '';
          const pools = Object.keys(data).filter(name => data[name] !== 'N/A');
          if (pools.length === 0) {
            poolSelect.innerHTML = '<option disabled>No pools detected - Is the array started?</option>';
          } else {
            pools.forEach(pool => {
              const option = document.createElement('option');
              option.value = pool;
              option.textContent = `${pool} (${data[pool]}%)`;
              if (pool === currentPoolSelection) option.selected = true;
              poolSelect.appendChild(option);
            });
          }
        })
        .catch(() => { poolSelect.innerHTML = '<option disabled>Error fetching pool usage</option>'; });

      poolSelect.addEventListener('change', () => { currentPoolSelection = poolSelect.value; });
    }
    updatePoolUsage();
    setInterval(updatePoolUsage, 5000);

    // Logs
    const filterInput = document.getElementById('log-filter');
    let filterTimer;
    filterInput.addEventListener('input', () => {
      clearTimeout(filterTimer);
      filterTimer = setTimeout(loadMoverLog, 500);
    });

    function loadLastRunLog() {
      fetch('/plugins/automover/helpers/fetch_last_run_log.php')
        .then(res => res.text())
        .then(data => { document.getElementById('last-run-log').textContent = data || 'No last run data available.'; })
        .catch(() => { document.getElementById('last-run-log').textContent = 'Error loading last run log.'; });
    }
    loadLastRunLog();
    setInterval(loadLastRunLog, 5000);

    function loadMoverLog() {
      const keyword = filterInput.value.trim();
      const query = keyword ? `?filter=${encodeURIComponent(keyword)}` : '';
      fetch(`/plugins/automover/helpers/fetch_files_moved_log.php${query}`)
        .then(res => res.json())
        .then(data => {
          const logContainer = document.getElementById('automover-log');
          logContainer.innerHTML = '';
          data.log.split('\n').forEach(line => {
            const div = document.createElement('div');
            div.textContent = line;
            if (line.toLowerCase().includes('skipped')) div.classList.add('skipped-line');
            logContainer.appendChild(div);
          });
          document.getElementById('log-counts').innerHTML = `<h3>Total Files Moved: ${data.moved}</h3>`;
        })
        .catch(() => {
          document.getElementById('automover-log').textContent = 'Error loading log.';
          document.getElementById('log-counts').textContent = '';
        });
    }
    loadMoverLog();
    setInterval(loadMoverLog, 5000);

    // Stop
    document.getElementById('stop-button').addEventListener('click', function () {
      const messageBox = document.getElementById('save-messages');
      messageBox.innerHTML = '';
      messageBox.style.display = 'none';

      fetch('/plugins/automover/helpers/stop_automover.php', {
        method: 'POST',
        credentials: 'same-origin',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body: 'csrf_token=' + encodeURIComponent(csrf_token)
      })
        .then(res => res.json())
        .then(() => {
          // Also stop cron schedule (optional but recommended)
          return fetch('/plugins/automover/helpers/stop_cron.php', {
            method: 'GET',
            credentials: 'same-origin'
          });
        })
        .then(() => {
          updateStatus();
          updatePoolUsage();

          stopBadge.style.display = 'inline-block';
          stopBadge.style.opacity = '0';
          stopBadge.style.animation = 'none';
          void stopBadge.offsetWidth;
          stopBadge.style.animation = 'flash .4s ease';
          stopBadge.style.opacity = '1';

          setTimeout(() => {
            stopBadge.style.opacity = '0';
            stopBadge.style.display = 'none';
          }, 3000);
        })
        .catch(() => {
          document.getElementById('status-text').textContent = 'Error stopping automover';
        });
    });

    // Validation
    function validateField(input, rules, warningId) {
      const value = input.value.trim();
      const number = parseFloat(value);
      const invalid = isNaN(number) || (rules.min !== undefined && number < rules.min) || (rules.max !== undefined && number > rules.max);
      input.classList.toggle('invalid', invalid);
      document.getElementById(warningId).style.display = invalid ? 'block' : 'none';
      return !invalid;
    }

    // === Manual Move Validation ===
    document.getElementById("start-manual-rsync").addEventListener("click", function () {

      const src = document.getElementById("manual_source").value.trim();
      const dst = document.getElementById("manual_dest").value.trim();
      const c1 = document.getElementById("manual_copy").checked;
      const c2 = document.getElementById("manual_delete").checked;
      const c3 = document.getElementById("manual_fullsync").checked;

      let valid = true;

      // reset all errors
      document.getElementById("manual-source-error").style.display = "none";
      document.getElementById("manual-dest-error").style.display = "none";
      document.getElementById("manual-options-error").style.display = "none";

      // check source
      if (src === "") {
        document.getElementById("manual-source-error").style.display = "block";
        valid = false;
      }

      // check destination
      if (dst === "") {
        document.getElementById("manual-dest-error").style.display = "block";
        valid = false;
      }

      // check options
      if (!c1 && !c2 && !c3) {
        document.getElementById("manual-options-error").style.display = "block";
        valid = false;
      }

      // If invalid → shake section + stop
      if (!valid) {
        const box = document.getElementById("manual-move-section");
        box.classList.remove("manual-shake");
        void box.offsetWidth; // restart animation
        box.classList.add("manual-shake");
        return;
      }

      // otherwise allow your real Start logic to run below…
      // (your existing AJAX code)

    });

    // === Qbittorrent Validation ===
    const qbitHostInput = document.getElementById('qbit_host');
    const qbitUserInput = document.getElementById('qbit_user');
    const qbitPassInput = document.getElementById('qbit_pass');
    const qbitDaysFromInput = document.getElementById('qbit_days_from');
    const qbitDaysToInput = document.getElementById('qbit_days_to');

    thresholdInput.addEventListener('input', () => validateField(thresholdInput, { min: 0, max: 100 }, 'threshold-warning'));
    const ageDaysInput = document.getElementById('age_days');
    ageDaysInput.addEventListener('input', () => validateField(ageDaysInput, { min: 1 }, 'age-days-warning'));
    const sizeMbInput = document.getElementById('size_mb');
    sizeMbInput.addEventListener('input', () => validateField(sizeMbInput, { min: 1 }, 'size-mb-warning'));

    // === Qbittorrent Validation ===
    function validateQbitFields() {
      if (!qbitCheckbox.checked) return true; // skip validation if not enabled

      let valid = true;

      // === HOST FIELD VALIDATION ===
      const hostVal = qbitHostInput.value.trim();
      const hasProtocol = /^https?:\/\//i.test(hostVal);
      const hostWarning = document.getElementById("qbit-host-warning");

      if (hostVal === "") {
        qbitHostInput.classList.add("invalid");
        hostWarning.textContent = "⚠️ Host is required";
        hostWarning.style.display = "block";
        valid = false;
      } else if (hasProtocol) {
        qbitHostInput.classList.add("invalid");
        hostWarning.textContent = "⚠️ Don't use http(s):// — only yourip:port";
        hostWarning.style.display = "block";
        valid = false;
      } else {
        qbitHostInput.classList.remove("invalid");
        hostWarning.style.display = "none";
      }

      // === USERNAME ===
      if (qbitUserInput.value.trim() === "") {
        qbitUserInput.classList.add("invalid");
        document.getElementById("qbit-user-warning").style.display = "block";
        valid = false;
      } else {
        qbitUserInput.classList.remove("invalid");
        document.getElementById("qbit-user-warning").style.display = "none";
      }

      // === PASSWORD ===
      if (qbitPassInput.value.trim() === "") {
        qbitPassInput.classList.add("invalid");
        document.getElementById("qbit-pass-warning").style.display = "block";
        valid = false;
      } else {
        qbitPassInput.classList.remove("invalid");
        document.getElementById("qbit-pass-warning").style.display = "none";
      }

      // === DAYS VALIDATION ===
      const fromVal = parseInt(qbitDaysFromInput.value, 10);
      const toVal = parseInt(qbitDaysToInput.value, 10);

      const validFrom = !isNaN(fromVal) && fromVal >= 0 && fromVal <= 999;
      const validTo = !isNaN(toVal) && toVal >= 1 && toVal <= 999;
      const validOrder = validFrom && validTo && fromVal < toVal;

      qbitDaysFromInput.classList.toggle("invalid", !validFrom);
      document.getElementById("qbit-days-from-warning").style.display = validFrom ? "none" : "block";

      qbitDaysToInput.classList.toggle("invalid", !validTo);
      document.getElementById("qbit-days-to-warning").style.display = validTo ? "none" : "block";

      document.getElementById("qbit-days-order-warning").style.display = validOrder ? "none" : "block";

      if (!validFrom || !validTo || !validOrder) valid = false;

      return valid;
    }

    // Live validation for qBittorrent fields
    [qbitHostInput, qbitUserInput, qbitPassInput, qbitDaysFromInput, qbitDaysToInput].forEach(input => {
      if (input) input.addEventListener('input', validateQbitFields);
    });

    // Also revalidate when toggling the "Enable Qbittorrent Script" checkbox
    if (qbitCheckbox) qbitCheckbox.addEventListener('change', validateQbitFields);

    // Dynamic validation between Days From and Days To
    [qbitDaysFromInput, qbitDaysToInput].forEach(input => {
      if (input) {
        input.addEventListener('input', () => {
          const fromVal = parseInt(qbitDaysFromInput.value, 10);
          const toVal = parseInt(qbitDaysToInput.value, 10);
          const validOrder = !isNaN(fromVal) && !isNaN(toVal) && fromVal < toVal;

          document.getElementById("qbit-days-order-warning").style.display = validOrder ? "none" : "block";
          qbitDaysFromInput.classList.toggle("invalid", !validOrder);
          qbitDaysToInput.classList.toggle("invalid", !validOrder);
        });
      }
    });

    function validateWebhook() {
      const enableNotifications = document.getElementById('enable_notifications');
      const webhookRow = document.getElementById('webhook-row');
      const webhookInput = document.getElementById('webhook_url');
      const webhookWarning = document.getElementById('webhook-warning');

      // Show/hide field depending on notifications
      if (enableNotifications && webhookRow) {
        webhookRow.style.display = enableNotifications.checked ? 'flex' : 'none';
      }

      if (!enableNotifications.checked) return true; // skip validation if notifications disabled
      if (!webhookInput) return true;

      const val = webhookInput.value.trim();
      if (val === '') {
        webhookInput.classList.remove('invalid');
        webhookWarning.style.display = 'none';
        return true; // empty is allowed
      }

      const valid = val.startsWith('https://discord.com/api/webhooks/');
      webhookInput.classList.toggle('invalid', !valid);
      webhookWarning.style.display = valid ? 'none' : 'block';
      return valid;
    }

    // ===== Exclusions picker (helper + csrf_token) =====
    const modal = document.getElementById('exclusion-modal');
    const grid = document.getElementById('picker-grid');
    const crumbs = document.getElementById('crumbs');
    const btnUp = document.getElementById('btn-up');
    const btnClose = document.getElementById('btn-close');
    const btnAdd = document.getElementById('btn-add');
    const btnRemove = document.getElementById('btn-remove');
    const toast = document.getElementById('picker-toast');
    let currentPath = '/mnt';

    let toastQueueDelay = 0; // keeps a running delay so toasts stagger

    function showToast(msg, type = 'ok') {
      const container = document.getElementById('toast-container');
      if (!container) return;

      const t = document.createElement('div');
      t.textContent = msg;

      t.style.color = type === 'err' ? '#ffaaaa' : '#00ff99';
      t.style.padding = '0px 0px';
      t.style.borderRadius = '0px';
      t.style.fontWeight = '600';
      t.style.boxShadow = '0 0 6px rgba(0,0,0,0.3)';
      t.style.opacity = '0';
      t.style.transform = 'translateX(30px)'; // slide from right
      t.style.transition = 'opacity .3s ease, transform .3s ease';
      t.style.minWidth = '160px';
      t.style.textAlign = 'right';

      container.appendChild(t);

      // apply a small delay so multiple toasts don't appear at the exact same time
      const delay = toastQueueDelay;
      toastQueueDelay += 1000; // 1s between toasts

      setTimeout(() => {
        t.style.opacity = '1';
        t.style.transform = 'translateX(0)';
      }, delay + 50);

      // fade out after it’s been visible for ~2 s
      setTimeout(() => {
        t.style.opacity = '0';
        t.style.transform = 'translateX(30px)';
        setTimeout(() => t.remove(), 300);
      }, delay + 2350);

      // reset queue after a few seconds (so future toasts don't keep offsetting forever)
      setTimeout(() => { toastQueueDelay = 0; }, delay + 3000);
    }

    function openPicker() { modal.style.display = 'flex'; loadDir('/mnt'); }
    function closePicker() { modal.style.display = 'none'; }

    exclField.addEventListener('click', openPicker);
    btnClose.addEventListener('click', closePicker);

    function buildCrumbs(path) {
      crumbs.innerHTML = '';

      // Normalize and split
      const cleanPath = path.replace(/\/+$/, '');
      if (!cleanPath.startsWith('/mnt')) {
        loadDir('/mnt');
        return;
      }

      const parts = cleanPath.split('/').filter(Boolean);
      let accum = '';

      // Add root first
      const root = document.createElement('span');
      root.textContent = '/mnt';
      root.className = 'crumb';
      root.dataset.path = '/mnt';
      crumbs.appendChild(root);

      // Build deeper segments
      for (let i = 1; i < parts.length; i++) {
        const seg = parts[i];
        const sep = document.createElement('span');
        sep.textContent = ' / ';
        sep.className = 'sep';
        crumbs.appendChild(sep);

        accum = accum ? accum + '/' + seg : '/mnt/' + seg;

        const a = document.createElement('span');
        a.textContent = seg;
        a.className = 'crumb';
        a.dataset.path = accum;
        crumbs.appendChild(a);
      }
    }

    // Delegated click handler (only one global listener needed)
    crumbs.addEventListener('click', e => {
      const crumb = e.target.closest('.crumb');
      if (!crumb) return;
      const path = crumb.dataset.path;
      if (!path) return;

      e.preventDefault();
      e.stopPropagation();
      loadDir(path);
    });

    function loadDir(path) {
      const url = `/plugins/automover/helpers/update_exclusions.php?action=list_dir&path=${encodeURIComponent(path)}&csrf_token=${encodeURIComponent(csrf_token)}`;
      fetch(url)
        .then(r => r.json())
        .then(data => {
          if (!data.ok) throw new Error('list_dir failed');
          currentPath = data.path || path;
          buildCrumbs(currentPath);
          grid.innerHTML = '';
          data.items.forEach(it => {
            const row = document.createElement('div');
            row.className = 'row';

            // --- Checkbox ---
            const cb = document.createElement('input');
            cb.type = 'checkbox';
            cb.dataset.path = it.path;

            // Disable if it's a root-level /mnt entry (like /mnt/disk1, /mnt/cache, etc.)
            if (/^\/mnt\/[^/]+$/.test(it.path)) {
              cb.disabled = true;
              cb.title = "Can't exclude entire disks or root pools";
              cb.style.cursor = 'not-allowed';
            }

            // --- Name / Icon / Color ---
            const name = document.createElement('div');
            name.className = 'name';
            name.title = it.path;

            // Folder
            if (it.isDir) {
              name.innerHTML = `<span class="icon">📁</span><span class="label">${it.name}</span>`;
              name.style.color = 'var(--primary-blue)';
              name.style.cursor = 'pointer';
              name.addEventListener('click', () => loadDir(it.path));
            } else {
              // File
              name.innerHTML = `<span class="icon">📄</span><span class="label">${it.name}</span>`;
              name.style.color = '#fff';
            }

            // --- Assemble Row ---
            row.appendChild(cb);
            row.appendChild(name);
            grid.appendChild(row);
          });
        })
        .catch(() => showToast('Error loading directory'));
    }

    btnUp.addEventListener('click', () => {
      if (!currentPath || currentPath === '/mnt') return;
      const up = currentPath.replace(/\/+$/, '').split('/').slice(0, -1).join('/') || '/mnt';
      loadDir(up.startsWith('/mnt') ? up : '/mnt');
    });

    function selectedPaths() { return Array.from(grid.querySelectorAll('input[type="checkbox"]:checked')).map(cb => cb.dataset.path); }

    function refreshExclusionCount() {
      fetch(`/plugins/automover/helpers/update_exclusions.php?action=get_exclusion_count&csrf_token=${encodeURIComponent(csrf_token)}`)
        .then(r => r.json())
        .then(d => {
          if (d.ok) {
            exclCount.textContent = `${d.count} item${d.count === 1 ? '' : 's'}`;
            exclField.value = d.count > 0 ? `Click to open file picker` : 'Click to open file picker';
          }
        }).catch(() => { });
    }

    btnAdd.addEventListener('click', () => {
      const paths = selectedPaths();
      if (paths.length === 0) { showToast('No selection'); return; }
      const body = new URLSearchParams(); body.append('csrf_token', csrf_token); paths.forEach(p => body.append('paths[]', p));
      fetch('/plugins/automover/helpers/update_exclusions.php?action=add_exclusions', { method: 'POST', body })
        .then(r => r.json()).then(d => {
          if (d.ok) { showToast('✅ Added'); refreshExclusionCount(); }
          else showToast('Add failed');
        }).catch(() => showToast('Add failed'));
    });

    btnRemove.addEventListener('click', () => {
      const paths = selectedPaths();
      if (paths.length === 0) { showToast('No selection'); return; }
      const body = new URLSearchParams(); body.append('csrf_token', csrf_token); paths.forEach(p => body.append('paths[]', p));
      fetch('/plugins/automover/helpers/update_exclusions.php?action=remove_exclusions', { method: 'POST', body })
        .then(r => r.json()).then(d => {
          if (d.ok) { showToast('✅ Removed'); refreshExclusionCount(); }
          else showToast('Remove failed');
        }).catch(() => showToast('Remove failed'));
    });

    btnClose.addEventListener('click', () => {
      addExtBtn.style.display = 'none';
      removeExtBtn.style.display = 'none';
      selectedExts.clear();
      modal.style.display = 'none';
    });

    // WILDCARD
    const addExtBtn = document.getElementById('addExtBtn');
    const removeExtBtn = document.getElementById('removeExtBtn');
    let selectedExts = new Set();

    document.addEventListener('change', (e) => {
      if (!e.target.matches('#picker-grid input[type="checkbox"]')) return;

      // collect all checked file extensions
      selectedExts.clear();
      const checked = Array.from(document.querySelectorAll('#picker-grid input[type="checkbox"]:checked'));
      checked.forEach(cb => {
        if (cb.dataset.isdir === 'true') return; // skip folders
        const name = cb.dataset.path.split('/').pop();
        const parts = name.split('.');
        if (parts.length > 1) selectedExts.add(parts.pop());
      });

      if (selectedExts.size > 0) {
        const label = Array.from(selectedExts).map(e => `*.${e}`).join(', ');
        addExtBtn.textContent = `Add extensions as wildcards`;
        removeExtBtn.textContent = `Remove extensions as wildcards`;
        addExtBtn.style.display = 'inline-block';
        removeExtBtn.style.display = 'inline-block';
      } else {
        addExtBtn.style.display = 'none';
        removeExtBtn.style.display = 'none';
      }
    });

    // Add extensions as wildcards
    addExtBtn.addEventListener('click', () => {
      if (selectedExts.size === 0) return;

      const body = new URLSearchParams();
      body.append('csrf_token', csrf_token);
      Array.from(selectedExts).forEach(ext => body.append('paths[]', `*.${ext}`));

      fetch('/plugins/automover/helpers/update_exclusions.php?action=add_exclusions', {
        method: 'POST',
        body
      })
        .then(r => r.json())
        .then(d => {
          if (d.ok) {
            let delay = 0;
            Array.from(selectedExts).forEach(ext => {
              setTimeout(() => showToast(`✅ Added *.${ext}`), delay);
              delay += 350;
            });
          } else showToast('Failed to add wildcard(s)', 'err');
        })
        .catch(err => {
          console.error('Add wildcard error:', err);
          showToast('Error adding wildcard(s)', 'err');
        });
    });

    // Remove extensions as wildcards
    removeExtBtn.addEventListener('click', () => {
      if (selectedExts.size === 0) return;

      const body = new URLSearchParams();
      body.append('csrf_token', csrf_token);
      Array.from(selectedExts).forEach(ext => body.append('paths[]', `*.${ext}`));

      fetch('/plugins/automover/helpers/update_exclusions.php?action=remove_exclusions', {
        method: 'POST',
        body
      })
        .then(r => r.json())
        .then(d => {
          if (d.ok) {
            let delay = 0;
            Array.from(selectedExts).forEach(ext => {
              setTimeout(() => showToast(`✅ Removed *.${ext}`), delay);
              delay += 350;
            });
          } else showToast('Failed to remove wildcard(s)', 'err');
        })
        .catch(err => {
          console.error('Remove wildcard error:', err);
          showToast('Error removing wildcard(s)', 'err');
        });
    });

// === Save & Start ===
saveBtn.addEventListener('click', function () {
  const stopAll = document.getElementById('stop_all_containers').checked ? 'yes' : 'no';
  const thresholdInput = document.getElementById('threshold');
  const stopThresholdInput = document.getElementById('stop_threshold');
  const form = document.getElementById('automover-settings');

  // --- Validation ---
  const thresholdValid = validateField(thresholdInput, { min: 0, max: 100 }, 'threshold-warning');
  const stopThresholdValid = validateField(stopThresholdInput, { min: 0, max: 100 }, 'stop-threshold-warning');
  const ageDaysInput = document.getElementById('age_days');
  const sizeMbInput = document.getElementById('size_mb');
  const ageDaysValid = !document.getElementById('age_based_filter').checked ||
    validateField(ageDaysInput, { min: 1 }, 'age-days-warning');
  const sizeMbValid = !document.getElementById('size_based_filter').checked ||
    validateField(sizeMbInput, { min: 1 }, 'size-mb-warning');
  const qbitValid = validateQbitFields();
  const webhookValid = validateWebhook();

  // --- Build cron string from dropdowns ---
  let cronExpression = '';
  const cronModeSelect = document.getElementById('cron_mode');

  if (cronModeSelect.value === 'minutes') {
    const freq = parseInt(document.getElementById('minutes_frequency').value, 10);
    cronExpression = `*/${freq} * * * *`;

  } else if (cronModeSelect.value === 'hourly') {
    const freq = parseInt(document.getElementById('hourly_frequency').value, 10);
    cronExpression = `0 */${freq} * * *`;

  } else if (cronModeSelect.value === 'daily') {
    const dailyTime = document.getElementById('daily_time').value;
    const [hour, minute] = dailyTime.split(':');
    cronExpression = `${parseInt(minute, 10)} ${parseInt(hour, 10)} * * *`;

  } else if (cronModeSelect.value === 'weekly') {
    const weeklyDay = document.getElementById('weekly_day').value;
    const weeklyTime = document.getElementById('weekly_time').value;
    const [hour, minute] = weeklyTime.split(':');
    const dayMap = { Sunday: 0, Monday: 1, Tuesday: 2, Wednesday: 3, Thursday: 4, Friday: 5, Saturday: 6 };
    cronExpression = `${parseInt(minute, 10)} ${parseInt(hour, 10)} * * ${dayMap[weeklyDay]}`;

  } else if (cronModeSelect.value === 'monthly') {
    const monthlyDay = document.getElementById('monthly_day').value;
    const monthlyTime = document.getElementById('monthly_time').value;
    const [hour, minute] = monthlyTime.split(':');
    cronExpression = `${parseInt(minute, 10)} ${parseInt(hour, 10)} ${parseInt(monthlyDay, 10)} * *`;

  } else if (cronModeSelect.value === 'custom') {
    const customCron = document.getElementById('custom_cron').value.trim();
    cronExpression = customCron;
  }

  // --- Cron validation (separate warnings) ---
  let cronValid = true;
  const cronParts = cronExpression.trim().split(/\s+/);

  const warnFields = document.getElementById('cron-warning-fields');
  const warnMinute = document.getElementById('cron-warning-minute');
  const warnInterval = document.getElementById('cron-warning-interval');

  [warnFields, warnMinute, warnInterval].forEach(w => { if (w) w.style.display = 'none'; });

  if (cronParts.length !== 5) {
    cronValid = false;
    if (warnFields) warnFields.style.display = 'block';
  } else {
    const minuteField = cronParts[0];
    if (minuteField === "*") {
      cronValid = false;
      if (warnMinute) warnMinute.style.display = 'block';
    } else {
      const match = minuteField.match(/^(\*\/)(\d+)$/);
      if (match) {
        const interval = parseInt(match[2], 10);
        if (interval < 2) {
          cronValid = false;
          if (warnInterval) warnInterval.style.display = 'block';
        }
      }
    }
  }

  // --- Final validation check ---
  if (!(thresholdValid && stopThresholdValid && ageDaysValid &&
        sizeMbValid && qbitValid && cronValid && webhookValid)) {
    form.classList.add('shake');
    setTimeout(() => form.classList.remove('shake'), 300);
    return;
  }

  // --- Build parameters for save_settings.php ---
  const params = new URLSearchParams({
    POOL_NAME: document.getElementById('pool').value,
    THRESHOLD: thresholdInput.value,
    DRY_RUN: document.getElementById('dry_run').checked ? 'yes' : 'no',
    ALLOW_DURING_PARITY: document.getElementById('allow_during_parity').checked ? 'yes' : 'no',
    AUTOSTART: document.getElementById('autostart').checked ? 'yes' : 'no',
    AGE_BASED_FILTER: document.getElementById('age_based_filter').checked ? 'yes' : 'no',
    AGE_DAYS: ageDaysInput.value,
    SIZE_BASED_FILTER: document.getElementById('size_based_filter').checked ? 'yes' : 'no',
    SIZE_MB: sizeMbInput.value,
    EXCLUSIONS_ENABLED: document.getElementById('enable_exclusions').checked ? 'yes' : 'no',
    QBITTORRENT_SCRIPT: document.getElementById('qbit_script').checked ? 'yes' : 'no',
    QBITTORRENT_HOST: document.getElementById('qbit_host').value.trim(),
    QBITTORRENT_USERNAME: document.getElementById('qbit_user').value.trim(),
    QBITTORRENT_PASSWORD: document.getElementById('qbit_pass').value.trim(),
    QBITTORRENT_DAYS_FROM: document.getElementById('qbit_days_from').value.trim(),
    QBITTORRENT_DAYS_TO: document.getElementById('qbit_days_to').value.trim(),
    QBITTORRENT_STATUS: document.getElementById('qbit_status').value.trim(),
    HIDDEN_FILTER: document.getElementById('hidden_filter').checked ? 'yes' : 'no',
    FORCE_RECONSTRUCTIVE_WRITE: document.getElementById('force_reconstructive_write').checked ? 'yes' : 'no',
    CONTAINER_NAMES: document.getElementById('container_names').value.trim(),
    ENABLE_JDUPES: document.getElementById('ENABLE_JDUPES').checked ? 'yes' : 'no',
    HASH_PATH: document.getElementById('HASH_PATH')?.value || '',
    ENABLE_CLEANUP: document.getElementById('enable_cleanup').checked ? 'yes' : 'no',
    MODE: 'cron', // always cron now
    CRON_EXPRESSION: cronExpression,
    STOP_THRESHOLD: stopThresholdInput.value,
    ENABLE_NOTIFICATIONS: document.getElementById('enable_notifications').checked ? 'yes' : 'no',
    WEBHOOK_URL: document.getElementById('webhook_url')?.value.trim() || '',
    MANUAL_MOVE: document.getElementById('manual_move_toggle').checked ? 'yes' : 'no',
    STOP_ALL_CONTAINERS: stopAll,
    ENABLE_TRIM: document.getElementById('enable_trim_toggle').checked ? 'yes' : 'no',
    ENABLE_SCRIPTS: document.getElementById('enable_scripts').checked ? 'yes' : 'no',
    PRE_SCRIPT: document.getElementById('pre_script').value.trim(),
    POST_SCRIPT: document.getElementById('post_script').value.trim(),
  });

// Add new scheduling fields so they persist in settings.cfg
params.set("CRON_MODE", cronModeSelect.value);
params.set("MINUTES_FREQUENCY", document.getElementById("minutes_frequency")?.value || "");
params.set("HOURLY_FREQUENCY", document.getElementById("hourly_frequency")?.value || "");
params.set("DAILY_TIME", document.getElementById("daily_time")?.value || "");
params.set("WEEKLY_DAY", document.getElementById("weekly_day")?.value || "");
params.set("WEEKLY_TIME", document.getElementById("weekly_time")?.value || "");
params.set("MONTHLY_DAY", document.getElementById("monthly_day")?.value || "");
params.set("MONTHLY_TIME", document.getElementById("monthly_time")?.value || "");
params.set("CUSTOM_CRON", document.getElementById("custom_cron")?.value.trim() || "");

// --- Step 1: Save settings ---
fetch('/plugins/automover/helpers/save_settings.php?' + params.toString(), { method: 'GET' })
  .then(res => res.json())
  .then(saveData => {
    if (saveData.status === 'error') {
      alert('❌ Save failed: ' + (saveData.message || 'Unknown error'));
      throw new Error('Save failed');
    }

    // --- Step 2: Start cron only if save succeeded ---
    const startForm = new URLSearchParams({
      csrf_token: csrfToken,
      MODE: 'cron',
      CRON_MODE: cronModeSelect.value,
      MINUTES_FREQUENCY: document.getElementById("minutes_frequency")?.value || "",
      HOURLY_FREQUENCY: document.getElementById("hourly_frequency")?.value || "",
      DAILY_TIME: document.getElementById("daily_time")?.value || "",
      WEEKLY_DAY: document.getElementById("weekly_day")?.value || "",
      WEEKLY_TIME: document.getElementById("weekly_time")?.value || "",
      MONTHLY_DAY: document.getElementById("monthly_day")?.value || "",
      MONTHLY_TIME: document.getElementById("monthly_time")?.value || "",
      CUSTOM_CRON: document.getElementById("custom_cron")?.value.trim() || "",
      CRON_EXPRESSION: cronExpression
    });

    return fetch('/plugins/automover/helpers/start_cron.php', {
      method: 'POST',
      body: startForm
    });
  })
  .then(res => res.json())
  .then(cronData => {
    if (!cronData || cronData.status !== 'ok') {
      alert('⚠️ Settings saved, but failed to start schedule: ' + (cronData?.message || 'Unknown error'));
      return;
    }
    // Success animation…
  })
  .catch(err => {
    console.error('Save + Start error:', err);
    alert('❌ Save or Start failed — check console for details.');
  });
});

    // Initial counts
    function refreshExclusionCount() {
      fetch(`/plugins/automover/helpers/update_exclusions.php?action=get_exclusion_count&csrf_token=${encodeURIComponent(csrf_token)}`)
        .then(r => r.json())
        .then(d => {
          if (d.ok) {
            exclCount.textContent = `${d.count} item${d.count === 1 ? '' : 's'}`;
            exclField.value = d.count > 0 ? `Click to open file picker` : 'Click to open file picker';
          }
        }).catch(() => { });
    }
    refreshExclusionCount();
  });

  // Keep pool-usage warning + CA update check
  document.addEventListener("DOMContentLoaded", () => {
    const poolSelect = document.getElementById('pool');
    const poolWarning = document.getElementById('pool-warning');
    function checkPoolUsage(poolName) {
      if (!poolName) { poolWarning.style.display = 'none'; return; }
      fetch(`/plugins/automover/helpers/check_pool_usage.php?pool=${encodeURIComponent(poolName)}`)
        .then(res => res.json())
        .then(data => { poolWarning.style.display = data.in_use ? 'none' : 'block'; })
        .catch(() => { poolWarning.style.display = 'none'; });
    }
    poolSelect.addEventListener('change', () => checkPoolUsage(poolSelect.value));
    setTimeout(() => { checkPoolUsage(poolSelect.value); }, 250);
  });
  if (typeof caPluginUpdateCheck === "function") {
    caPluginUpdateCheck("automover.plg", { name: "Automover" });
  }

  document.addEventListener('DOMContentLoaded', () => {
    const qbitToggle = document.getElementById('qbit_script');
    const warning = document.getElementById('python-warning');
    const pythonInstalled = warning.dataset.pythonInstalled === '1';

    const updateWarningVisibility = () => {
      if (qbitToggle.checked && !pythonInstalled) {
        warning.style.display = 'block';
      } else {
        warning.style.display = 'none';
      }
    };

    if (qbitToggle) {
      qbitToggle.addEventListener('change', updateWarningVisibility);
      updateWarningVisibility(); // Run on page load to reflect current state
    }
  });

  $('.automovertip').tooltipster({
    maxWidth: 300
  });

  function showToast(toastEl, message, type = "ok") {
    if (!toastEl) return;
    toastEl.textContent = message;
    toastEl.style.color = type === "ok" ? "#00ffaa" : "#ff5555";
    toastEl.classList.remove("hide");
    void toastEl.offsetWidth;
    toastEl.classList.add("show");

    clearTimeout(toastEl._timer);
    toastEl._timer = setTimeout(() => {
      toastEl.classList.remove("show");
      toastEl.classList.add("hide");
      // fully remove after fade to reclaim space
      setTimeout(() => (toastEl.textContent = ""), 400);
    }, 2000);
  }

  // === Clear Log Buttons (toast feedback) ===
  const clearLastRunBtn = document.getElementById("clear-last-run-log");
  const clearMoverBtn = document.getElementById("clear-mover-log");
  const toastLast = document.getElementById("toast-last");
  const toastMover = document.getElementById("toast-mover");

  if (clearLastRunBtn) {
    clearLastRunBtn.addEventListener("click", function () {
      if (confirm("Are you sure you want to clear the Last Run Log?")) {
        fetch("/plugins/automover/helpers/clear_log.php", {
          method: "POST",
          headers: {
            "Content-Type": "application/x-www-form-urlencoded",
            "X-CSRF-TOKEN": csrfToken
          },
          body: "log=last&csrf_token=" + encodeURIComponent(csrfToken)
        })
          .then(r => r.json())
          .then(data => {
            showToast(toastLast, data.message, data.ok ? "ok" : "err");
            if (data.ok) document.getElementById("last-run-log").textContent = "";
          })
          .catch(() => showToast(toastLast, "Failed to clear log", "err"));
      }
    });
  }

  if (clearMoverBtn) {
    clearMoverBtn.addEventListener("click", function () {
      if (confirm("Are you sure you want to clear the Mover Log?")) {
        fetch("/plugins/automover/helpers/clear_log.php", {
          method: "POST",
          headers: {
            "Content-Type": "application/x-www-form-urlencoded",
            "X-CSRF-TOKEN": csrfToken
          },
          body: "log=mover&csrf_token=" + encodeURIComponent(csrfToken)
        })
          .then(r => r.json())
          .then(data => {
            showToast(toastMover, data.message, data.ok ? "ok" : "err");
            if (data.ok) {
              document.getElementById("automover-log").textContent = "";
              document.getElementById("log-counts").textContent = "";
            }
          })
          .catch(() => showToast(toastMover, "Failed to clear log", "err"));
      }
    });
  }

  // ==============================
  // MANUAL MOVE — MUTUALLY EXCLUSIVE CHECKBOX LOGIC
  // ==============================
  function setupManualRsyncModeExclusivity() {
    const c1 = document.getElementById("manual_copy");
    const c2 = document.getElementById("manual_delete");
    const c3 = document.getElementById("manual_fullsync");

    function uncheckOthers(active) {
      [c1, c2, c3].forEach(c => {
        if (c !== active) c.checked = false;
      });
    }

    c1.addEventListener("change", () => { if (c1.checked) uncheckOthers(c1); });
    c2.addEventListener("change", () => { if (c2.checked) uncheckOthers(c2); });
    c3.addEventListener("change", () => { if (c3.checked) uncheckOthers(c3); });
  }

  document.addEventListener("DOMContentLoaded", setupManualRsyncModeExclusivity);

  // ==============================
  // MANUAL MOVE TOGGLE
  // ==============================
  const manualToggle = document.getElementById("manual_move_toggle");
  const manualSection = document.getElementById("manual-move-section");

  manualToggle.addEventListener("change", () => {
    manualSection.style.display = manualToggle.checked ? "block" : "none";
  });

  // ==============================
  // MANUAL MOVE: SAFE TOAST
  // ==============================
  function safeToast(msg, type = "ok") {
    const ref = (typeof toastSettings !== "undefined") ? toastSettings : null;
    if (typeof showToast === "function" && ref) {
      showToast(ref, msg, type);
    } else {
      console.log("Toast:", msg);
    }
  }

  // ==============================
  // MANUAL MOVE INITIALIZER
  // ==============================
  if (!window.manualMoveInit) {
    window.manualMoveInit = true;

    // Toggle block visibility
    const manualToggle = document.getElementById("manual_move_toggle");
    const manualSection = document.getElementById("manual-move-section");

    manualToggle.addEventListener("change", () => {
      manualSection.style.display = manualToggle.checked ? "block" : "none";
    });

    // Start Manual Rsync
    document.getElementById("start-manual-rsync").addEventListener("click", () => {
      // Immediately disable Automover buttons when manual move starts
      ['save-settings', 'moveNowBtn'].forEach(id => {
        const el = document.getElementById(id);
        if (el) {
          el.disabled = true;
          el.style.opacity = '0.5';
          el.style.cursor = 'not-allowed';
        }
      });

      const src = document.getElementById("manual_source").value.trim();
      const dst = document.getElementById("manual_dest").value.trim();

      const modeCopy = document.getElementById("manual_copy").checked;
      const modeDelete = document.getElementById("manual_delete").checked;
      const modeFull = document.getElementById("manual_fullsync").checked;

      if (!src || !dst) {
        safeToast("Source and Destination are required.", "err");
        return;
      }

      if (![modeCopy, modeDelete, modeFull].includes(true)) {
        safeToast("Select one rsync mode.", "err");
        return;
      }

      // Show confirmation toast
      const badge = document.getElementById("manual-move-confirmation");
      badge.style.display = "block";
      badge.style.opacity = "1";
      setTimeout(() => {
        badge.style.opacity = "0";
        setTimeout(() => (badge.style.display = "none"), 500);
      }, 2500);

      // Build params
      const params = new URLSearchParams();
      params.append("csrf_token", csrfToken);
      params.append("source", src);
      params.append("dest", dst);
      params.append("copy", modeCopy ? "1" : "0");
      params.append("delete", modeDelete ? "1" : "0");
      params.append("fullsync", modeFull ? "1" : "0");

      // Fire off request in background
      fetch("/plugins/automover/helpers/manual_rsync.php", {
        method: "POST",
        headers: {
          "Content-Type": "application/x-www-form-urlencoded",
          "X-CSRF-TOKEN": csrfToken
        },
        body: params.toString()
      })
        .then(res => res.json())
        .then(data => {
          if (!data.ok) {
            // Optional: show error toast if backend fails
            safeToast("Manual move failed.", "err");
          }
        })
        .catch(() => {
          safeToast("Manual move request error.", "err");
        });
    });
  }

  // ==========================
  // Picker state
  // ==========================
  let pickerMode = "";      // "src" or "dst"
  let pickerPath = "/mnt";
  let selectedPath = "";

  const pickerModal = document.getElementById("path-picker-modal");
  const pickerGrid = document.getElementById("manual-picker-grid");
  const pickerCrumbs = document.getElementById("manual-picker-crumbs");

  // Open from source input
  document.getElementById("manual_source").addEventListener("click", () => {
    pickerMode = "src";
    selectedPath = "";
    pickerPath = "/mnt";
    pickerModal.style.display = "flex";
    loadPicker(pickerPath);
  });

  // Open from destination input
  document.getElementById("manual_dest").addEventListener("click", () => {
    pickerMode = "dst";
    selectedPath = "";
    pickerPath = "/mnt";
    pickerModal.style.display = "flex";
    loadPicker(pickerPath);
  });

  // ==========================
  // Load directory contents
  // ==========================
  function loadPicker(path) {
    pickerPath = path;

    fetch(`/plugins/automover/helpers/list_dir.php?path=${encodeURIComponent(path)}`)
      .then(r => r.json())
      .then(data => {
        buildCrumbs(path);
        buildGrid(data.entries);
      });
  }

  // ==========================
  // Breadcrumbs
  // ==========================
  function buildCrumbs(path) {
    const crumbs = document.getElementById("manual-picker-crumbs");
    crumbs.innerHTML = "";

    // Normalize path so we don't get weird stuff like /mnt/mnt/cache
    if (!path.startsWith("/mnt")) {
      path = "/mnt";
    }

    // parts: ['mnt', 'cache', 'dev-files']
    const parts = path.split("/").filter(Boolean);

    let current = "";
    parts.forEach((part, index) => {
      current += "/" + part;          // /mnt, /mnt/cache, /mnt/cache/dev-files
      const crumbPath = current;      // freeze value for this crumb

      const span = document.createElement("span");
      span.className = "picker-crumb";

      // First crumb shows "/mnt", others just "folder"
      if (index === 0) {
        span.textContent = "/mnt";
      } else {
        span.textContent = part;
      }

      span.style.cursor = "pointer";
      span.style.color = "#3ca8ff";
      span.style.marginRight = "4px";

      // Hover color like exclusions (red-ish)
      span.addEventListener("mouseenter", () => {
        span.style.color = "#ff4444";
      });
      span.addEventListener("mouseleave", () => {
        span.style.color = "#3ca8ff";
      });

      span.onclick = () => {
        console.log("Breadcrumb clicked:", crumbPath);
        loadPicker(crumbPath);
      };

      crumbs.appendChild(span);

      // Add "/" separator between crumbs (but not after last)
      if (index < parts.length - 1) {
        const sep = document.createElement("span");
        sep.textContent = "/";
        sep.style.color = "#888";
        sep.style.marginRight = "4px";
        crumbs.appendChild(sep);
      }
    });

    function addCrumb(p) {
      const el = document.createElement("span");
      el.textContent = p;
      el.classList.add("picker-crumb");   // <-- blue text style

      el.onclick = () => loadPicker(p);
      pickerCrumbs.appendChild(el);
    }
  }

  // ==========================
  // Build folder/file grid
  // ==========================
  function buildGrid(entries) {
    pickerGrid.innerHTML = "";

    const srcVal = document.getElementById("manual_source").value.trim();
    const dstVal = document.getElementById("manual_dest").value.trim();
    const otherPath = (pickerMode === "src" ? dstVal : srcVal);

    // Classify the OTHER side (what's already chosen)
    const otherIsUser0 = /^\/mnt\/user0(\/|$)/.test(otherPath);
    const otherIsUser = !otherIsUser0 && /^\/mnt\/user(\/|$)/.test(otherPath);
    const otherIsDisk = /^\/mnt\/disk[0-9]+(\/|$)/.test(otherPath);

    console.log("OTHER PATH:", otherPath, { otherIsUser, otherIsUser0, otherIsDisk });

    entries.forEach(e => {
      const full = pickerPath.replace(/\/$/, "") + "/" + e.name; // normalize single slash

      // Classify THIS entry (order matters!)
      const isUser0 = /^\/mnt\/user0(\/|$)/.test(full);
      const isUser = !isUser0 && /^\/mnt\/user(\/|$)/.test(full);
      const isDisk = /^\/mnt\/disk[0-9]+(\/|$)/.test(full);

      let disabled = false;

      // ======================================================
      // Your requested block rules:
      // 1) If other is /mnt/user   → block user0 + disks
      // 2) If other is /mnt/user0  → block user + disks
      // 3) If other is /mnt/diskX  → block user + user0
      // ======================================================

      if (otherIsUser) {
        if (isUser0 || isDisk) disabled = true;
      }

      if (otherIsUser0) {
        if (isUser || isDisk) disabled = true;
      }

      if (otherIsDisk) {
        if (isUser || isUser0) disabled = true;
      }

      // ======================================================
      // NEW RULE: Prevent selecting identical path
      // ======================================================
      if (full === otherPath.replace(/\/$/, "")) {
        disabled = true;
      }

      const row = document.createElement("div");
      row.style.display = "flex";
      row.style.alignItems = "center";
      row.style.padding = "6px";
      row.style.borderBottom = "1px solid #333";
      row.style.opacity = disabled ? "0.35" : "1.0";

      // Checkbox (folders only)
      let cb = null;
      if (e.type === "dir") {
        cb = document.createElement("input");
        cb.type = "checkbox";
        cb.disabled = disabled;
        cb.style.marginRight = "10px";

        cb.onclick = ev => {
          ev.stopPropagation();
          pickerGrid.querySelectorAll("input[type=checkbox]").forEach(c => {
            if (c !== cb) c.checked = false;
          });
          selectedPath = cb.checked ? full : "";
        };

        row.appendChild(cb);
      } else {
        const spacer = document.createElement("div");
        spacer.style.width = "22px";
        row.appendChild(spacer);
      }

      // Name (click folder → open)
      const name = document.createElement("span");
      name.classList.add("picker-link");   // <-- blue text like exclusions

      name.innerHTML = e.type === "dir" ? "📁 " + e.name : "📄 " + e.name;

      name.onclick = () => {
        if (disabled) {
          shakeModal();
          return;
        }
        if (e.type === "dir") loadPicker(full);
      };

      row.appendChild(name);
      pickerGrid.appendChild(row);
    });
  }

  // ==========================
  // Up button
  // ==========================
  document.getElementById("picker-up").addEventListener("click", () => {
    if (pickerPath !== "/mnt") {
      const parent = pickerPath.substring(0, pickerPath.lastIndexOf("/")) || "/mnt";
      loadPicker(parent);
    }
  });

  // ==========================
  // Close modal
  // ==========================
  document.getElementById("picker-close").addEventListener("click", () => {
    pickerModal.style.display = "none";
    hideNewFolderRow();
  });

  // ==========================
  // Add Selected
  // ==========================
  document.getElementById("picker-add").addEventListener("click", () => {
    if (!selectedPath) return;

    if (pickerMode === "src") {
      document.getElementById("manual_source").value = selectedPath + "/";
    } else {
      document.getElementById("manual_dest").value = selectedPath + "/";
    }

    pickerModal.style.display = "none";
  });

  document.getElementById("picker-clear").addEventListener("click", () => {
    // Uncheck all checkboxes
    pickerGrid.querySelectorAll("input[type=checkbox]").forEach(cb => {
      cb.checked = false;
    });

    // Reset stored selection
    selectedPath = "";

    // Clear the input field for the current picker mode
    if (pickerMode === "src") {
      document.getElementById("manual_source").value = "";
    } else if (pickerMode === "dst") {
      document.getElementById("manual_dest").value = "";
    }
  });

  function shakeModal() {
    const box = document.querySelector("#path-picker-modal > div");
    box.style.animation = "shake 0.3s";
    setTimeout(() => box.style.animation = "", 300);
  }
</script>
<script>
  // === Disable buttons immediately after click ===
  document.addEventListener("DOMContentLoaded", () => {
    const actionButtons = [
      document.getElementById("save-settings"),
      document.getElementById("moveNowBtn"),
    ];

    actionButtons.forEach(btn => {
      if (!btn) return;

      btn.addEventListener("click", () => {
        // Immediately disable the clicked button
        btn.disabled = true;
        btn.style.backgroundColor = "#000";
        btn.style.opacity = "0.6";
        btn.style.cursor = "not-allowed";

        // Optionally disable *all* other action buttons too
        actionButtons.forEach(other => {
          if (other && other !== btn) {
            other.disabled = true;
            other.style.backgroundColor = "#000";
            other.style.opacity = "0.6";
            other.style.cursor = "not-allowed";
          }
        });

        // Optional: automatically re-enable after some time (e.g. 60s)
        // setTimeout(() => {
        //   actionButtons.forEach(b => {
        //     if (b) {
        //       b.disabled = false;
        //       b.style.backgroundColor = "";
        //       b.style.opacity = "1";
        //       b.style.cursor = "pointer";
        //     }
        //   });
        // }, 60000);
      });
    });
  });
</script>
<?php if (file_exists('/boot/config/plugins/ca.mover.tuning.plg')): ?>
<!-- Bottom-fixed Mover Tuning Warning -->
<div id="mover-tuning-warning" style="
  display:none; /* Hidden until JS confirms it should be shown */
  position: fixed;
  bottom: 25px;
  left: 50%;
  transform: translateX(-50%);
  background: #111;
  color: #ffcc00;
  border: 1px solid var(--primary-blue);
  border-radius: 10px;
  padding: 14px 22px;
  width: 480px;
  max-width: 90%;
  text-align: center;
  box-shadow: 0 0 12px rgba(0, 128, 128, .3);
  z-index: 9999;
  font-size: 15px;
  line-height: 1.4;
">
  ⚠️ Mover Tuning plugin appears to be installed<br>
  Having both can result in conflicts<br>
  Consider uninstalling one to avoid incompatibility issues.

  <!-- close “X” -->
  <button id="mover-tuning-close" style="
    position: absolute;
    top: -10px;
    right: -28px;
    background: transparent;
    border: none;
    color: #ffcc00;
    font-size: 22px;
    font-weight: bold;
    cursor: pointer;
    line-height: 1;
  " title="Close warning">×</button>

  <!-- dismiss permanently row -->
  <div style="text-align:center; margin-top:1px; margin-bottom:1px;">
    <button id="dismiss-mover-warning" style="
      background: #000;
      color: #ffa500;
      border: 2px solid #ffa500;
      border-radius: 6px;
      cursor: pointer;
      padding: 8px 16px;
      font-weight: 600;
      transition: all 0.25s ease;
      box-shadow: 0 0 10px rgba(255,165,0,0.2);
    " onmouseover="this.style.background='#ffa500';this.style.color='#fff';"
      onmouseout="this.style.background='#000';this.style.color='#ffa500';">
      Dismiss Permanently
    </button>
    <div style="
      color: #999;
      font-size: 11px;
      margin-top: 2px;
    ">
      *To re-enable after disabling permanently, delete <b>mover_warning_dismissed.txt</b><br>
      from <i>/boot/config/plugins/automover</i> on the flash drive.
    </div>
    <div id="dismiss-status" style="
      display:none;
      margin-top:1px;
      color:#00ffaa;
      font-weight:bold;
    ">✅ Warning dismissed permanently</div>
  </div>
</div>

<script>
  // === Mover Tuning Warning Dismiss ===
  const warningBox = document.getElementById('mover-tuning-warning');
  const closeBtn = document.getElementById('mover-tuning-close');
  const dismissBtn = document.getElementById('dismiss-mover-warning');
  const dismissStatus = document.getElementById('dismiss-status');

  // Check dismissal state before showing to prevent flash
  fetch('/plugins/automover/helpers/mover_warning_state.php')
    .then(res => res.json())
    .then(data => {
      if (!data.dismissed && warningBox) {
        warningBox.style.display = 'block'; // Only show if NOT dismissed
      }
    })
    .catch(() => {
      // fallback: show warning if fetch fails (for safety)
      if (warningBox) warningBox.style.display = 'block';
    });

  // Close "×" (temporary hide)
  if (closeBtn && warningBox) {
    closeBtn.addEventListener('click', () => {
      warningBox.style.transition = 'opacity 0.3s ease';
      warningBox.style.opacity = '0';
      setTimeout(() => warningBox.remove(), 300);
    });
  }

  // Dismiss Permanently
  if (dismissBtn && warningBox) {
    dismissBtn.addEventListener('click', () => {
      fetch('/plugins/automover/helpers/mover_warning_state.php', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/x-www-form-urlencoded',
          'X-CSRF-TOKEN': csrfToken
        },
        body: new URLSearchParams({ csrf_token: csrfToken })
      })
        .then(res => res.json())
        .then(data => {
          if (data.ok) {
            dismissBtn.style.display = 'none';
            dismissStatus.style.display = 'block';
            setTimeout(() => { warningBox.style.display = 'none'; }, 1500);
          } else {
            alert('Failed to dismiss warning: ' + (data.error || 'Unknown error'));
          }
        })
        .catch(err => {
          console.error('Dismiss fetch error:', err);
          alert('Dismiss request failed — check console for details.');
        });
    });
  }
</script>
<?php endif; ?>
<script>
  const UNRAID_VERSION = "<?= $unraid_version ?>";
  console.log("Detected via PHP:", UNRAID_VERSION);

  const major = parseFloat(UNRAID_VERSION);

  if (!isNaN(major) && major >= 7.2) {
    document.body.classList.add("unraid-72");
  } else {
    document.body.classList.add("unraid-71");
  }
</script>
<script>
  const pickerCreateBtn = document.getElementById("picker-create-folder");
  const newFolderRow = document.getElementById("picker-newfolder-row");
  const newFolderInput = document.getElementById("picker-newfolder-input");
  const newFolderConfirm = document.getElementById("picker-newfolder-confirm");
  const newFolderCancel = document.getElementById("picker-newfolder-cancel");

  // Show name input row
  pickerCreateBtn.addEventListener("click", () => {
    newFolderRow.style.display = "flex";
    newFolderInput.value = "";
    newFolderInput.focus();
  });

  // Confirm ✓
  newFolderConfirm.addEventListener("click", () => {
    const parent = pickerPath;
    const name = newFolderInput.value.trim();

    if (!name) {
      newFolderInput.style.borderColor = "red";
      return;
    }

    newFolderInput.style.borderColor = "";

    fetch("/plugins/automover/helpers/create_folder.php", {
      method: "POST",
      headers: { "Content-Type": "application/x-www-form-urlencoded" },
      body:
        "parent=" + encodeURIComponent(parent) +
        "&name=" + encodeURIComponent(name) +
        "&csrf_token=" + encodeURIComponent(csrfToken)
    })
      .then(r => r.json())
      .then(data => {
        if (data.ok) {
          hideNewFolderRow();
          loadPicker(parent);
        } else {
          newFolderInput.style.borderColor = "red";
        }
      })
      .catch(() => {
        newFolderInput.style.borderColor = "red";
      });
  });

  // Cancel ✗
  newFolderCancel.addEventListener("click", hideNewFolderRow);

  // Press Enter = ✓, Escape = ✗
  newFolderInput.addEventListener("keydown", e => {
    if (e.key === "Enter") newFolderConfirm.click();
    if (e.key === "Escape") hideNewFolderRow();
  });

  function hideNewFolderRow() {
    newFolderRow.style.display = "none";
    newFolderInput.style.borderColor = "";
  }
</script>