Menu="Utilities"
Type="xmenu"
Title="VM Backup & Restore"
Icon="icon.png"
Tag="icon.png"
Markdown="false"
---
<?php
$cfgPath = '/boot/config/plugins/vm-backup-and-restore/settings.cfg';

// Define all default keys and their order
$defaults = [
    'VM_NAME' => '',
    'BACKUP_DESTINATION' => '',
    'NUMBER_OF_BACKUPS' => '0',
    'STOP_VMS' => 'yes', 
    'DRY_RUN' => '1',
    'ENABLE_NOTIFICATIONS' => '0',
    'BACKUP_OWNER' => 'nobody'
];

// Load existing config if present
$existing = [];
if (file_exists($cfgPath)) {
    $existing = parse_ini_file($cfgPath) ?: [];
}
// Merge without overwriting existing keys
foreach ($defaults as $key => $value) {
    if (!array_key_exists($key, $existing)) {
        $existing[$key] = $value;
    }
}
// Rebuild config text in the correct order
$configText = '';
foreach ($defaults as $key => $defaultValue) {
    $val = $existing[$key];
    $configText .= "$key=\"$val\"\n";
}
@file_put_contents($cfgPath, $configText);
$settings = $existing;
?>

<?php
$restoreCfgPath = '/boot/config/plugins/vm-backup-and-restore/settings_restore.cfg';

// Define all default keys and their order for restore
$restoreDefaults = [
    'VM_NAME_RESTORE' => '',
    'RESTORE_LOCATION' => '',
    'DRY_RUN_RESTORE' => 'false',
    'ENABLE_NOTIFICATIONS_RESTORE' => '0',
    'RESTORE_VERSIONS' => '',
    'RESTORE_DESTINATION' => '/mnt/user/domains'
];

// Load existing restore config if present
$existingRestore = [];
if (file_exists($restoreCfgPath)) {
    $existingRestore = parse_ini_file($restoreCfgPath) ?: [];
}

// Merge defaults without overwriting existing keys
foreach ($restoreDefaults as $key => $value) {
    if (!array_key_exists($key, $existingRestore)) {
        $existingRestore[$key] = $value;
    }
}

// Rebuild restore config text in the correct order
$restoreConfigText = '';
foreach ($restoreDefaults as $key => $defaultValue) {
    $val = $existingRestore[$key];
    $restoreConfigText .= "$key=\"$val\"\n";
}

// Save the restore config
@file_put_contents($restoreCfgPath, $restoreConfigText);

// Make it available to your page
$restoreSettings = $existingRestore;

// Load saved VM list (string or array)
$saved_vm_list = $vm_list_settings['VM_NAME_RESTORE'] ?? '';

// Normalize into array
if (!is_array($saved_vm_list)) {
    $saved_vm_list = array_filter(array_map('trim', explode(',', $saved_vm_list)));
}
?>

<?php
$unraid_version = "7.2"; // fallback
if (file_exists("/etc/unraid-version")) {
    $data = parse_ini_file("/etc/unraid-version");
    if (!empty($data["version"])) {
        $unraid_version = $data["version"];
    }
}
?>

<script>
  // UNIVERSAL CSRF TOKEN DISCOVERY for Unraid plugin pages
  let csrfToken = "<?= $_GET['csrf_token'] ?? ($_COOKIE['csrf_token'] ?? '') ?>";

  // Try dynamic lookup from global scope, cookie, or meta
  if (!csrfToken || csrfToken === "undefined" || csrfToken === "") {
    try {
      // 1Ô∏è‚É£ Try the global variable used by Unraid's WebGUI JS
      if (typeof window.csrf_token !== "undefined" && window.csrf_token) {
        csrfToken = window.csrf_token;
      }

      // 2Ô∏è‚É£ Try any embedded meta tag
      if ((!csrfToken || csrfToken === "") && document.querySelector("meta[name='csrf_token']")) {
        csrfToken = document.querySelector("meta[name='csrf_token']").getAttribute("content");
      }

      // 3Ô∏è‚É£ Try cookie (most Unraid builds set it)
      if ((!csrfToken || csrfToken === "") && document.cookie.includes("csrf_token=")) {
        const m = document.cookie.match(/csrf_token=([^;]+)/);
        if (m) csrfToken = decodeURIComponent(m[1]);
      }

      // 4Ô∏è‚É£ Fallback: try to extract from any script tag in the parent frame
      if ((!csrfToken || csrfToken === "") && window.parent) {
        try {
          if (window.parent.csrf_token) csrfToken = window.parent.csrf_token;
        } catch (e) { /* ignore cross-frame */ }
      }
    } catch (err) {
      console.warn("CSRF token discovery failed:", err);
    }
  }

  console.log("Resolved CSRF token:", csrfToken || "<empty>");
</script>

<style>
  :root {
    --primary-blue: #e6231c;
    --status-green: #2ECC40;
  }

  /* === Layout Wrapper === */
  #vm-backup-and-restore-wrapper {
    display: flex;
    flex-wrap: nowrap;
    /* stay side-by-side */
    align-items: flex-start;
    /* align at top */
    justify-content: space-evenly;
    /* even horizontal spacing */
    gap: 20px;
    /* space between panels */
    width: 100%;
    box-sizing: border-box;
  }

  /* === Each Panel (auto-sizing) === */
  #vm-backup-and-restore-settings,
  #moved-log-container,
  #last-run-container {
    background: #111;
    border-radius: 12px;
    box-shadow: 0 0 12px rgba(255, 0, 0, .3);
    color: #f0f8ff;
    padding: 20px;
    flex: 1 1 auto;
    /* grow and shrink dynamically */
    height: auto;
    /* dynamic height */
    max-height: none;
    /* remove fixed limit */
    overflow: visible;
    /* expand with content */
    min-width: 0;
    /* prevent overflow on long content */
    box-sizing: border-box;
  }

  #vm-backup-and-restore-settings {
    padding-top: 0px !important;
    /* reduce from default 20px */
  }

  #last-run-container {
    padding-top: 10px !important;
    /* reduce from default 20px */
  }

  #last-run-container h3 {
    margin-top: 0 !important;
    /* remove any top margin */
    margin-bottom: 10px;
    /* keep small spacing below title */
  }

  #moved-log-container {
    padding-top: 10px !important;
    /* reduce from default 20px */
  }

  #moved-log-container h3 {
    margin-top: 0 !important;
    /* remove any top margin */
    margin-bottom: 10px;
    /* keep small spacing below title */
  }

  /* === Optional: fine-tune widths === */
  #vm-backup-and-restore-settings {
    flex-basis: 25%;
  }

  #moved-log-container {
    flex-basis: 53%;
  }

  #last-run-container {
    flex-basis: 22%;
  }

  .unraid-71 #vm-backup-and-restore-settings {
    min-height: 77vh;
    max-height: 77vh;
    overflow-y: auto;
    margin: 0;
  }

  .unraid-71 #moved-log-container pre {
    max-height: 60vh;
    overflow-y: auto;
    margin: 0;
  }

  .unraid-71 #last-run-container pre {
    max-height: 68vh;
    overflow-y: auto;
    margin: 0;
  }

  .unraid-72 #vm-backup-and-restore-settings {
    min-height: 76vh;
    max-height: 76vh;
    overflow-y: auto;
    margin: 0;
  }

  .unraid-72 #moved-log-container pre {
    max-height: 59vh;
    overflow-y: auto;
    margin: 0;
  }

  .unraid-72 #last-run-container pre {
    max-height: 67vh;
    overflow-y: auto;
    margin: 0;
  }

  @media (max-width: 1100px) {
    #vm-backup-and-restore-wrapper {
      flex-wrap: wrap;
    }

    #vm-backup-and-restore-settings,
    #moved-log-container,
    #last-run-container {
      flex: 1 1 100%;
    }
  }

  .form-row {
    flex-direction: column;
    gap: 15px;
    margin-bottom: 20px;
  }

  label {
    color: var(--primary-blue);
    font-weight: bold;
    margin-bottom: 5px;
  }

  input,
  select {
    background: #111;
    border: 1px solid var(--primary-blue);
    border-radius: 5px;
    color: #fff;
    padding: 8px;
  }

  .unraid-71 #vm-backup-and-restore-wrapper {
    margin-top: -31px !important;
  }

  .unraid-72 #vm-backup-and-restore-wrapper {
    margin-top: -20px !important;
  }

  button {
    border: none;
    border-radius: 4px;
    color: #fff;
    cursor: pointer;
    margin-right: 10px;
    padding: 8px 15px;
  }

  .checkbox-row {
    align-items: center;
    display: grid;
    gap: 0 0px;
    grid-template-columns: repeat(2, 1fr);
    margin-top: 10px;
  }

  .checkbox-row label {
    align-items: center;
    cursor: pointer;
    display: flex;
    font-size: 15px;
    gap: 0px;
    line-height: 1.4;
  }

  .checkbox-row input[type="checkbox"] {
    accent-color: var(--primary-blue);
    transform: scale(1.2);
  }

  input[type="checkbox"] {
    accent-color: var(--primary-blue);
    cursor: pointer;
    height: 16px;
    width: 16px;
  }

  .form-check input {
    margin-right: 8px;
    vertical-align: middle;
  }

  .status-container {
    margin-top: 20px;
  }

  .status-row {
    align-items: center;
    display: flex;
    margin-bottom: 6px;
  }

  .status-label {
    color: var(--primary-blue);
    font-weight: bold;
    width: 75px;
  }

  #version-text {
    color: #fff;
  }

  .tooltip {
    display: inline-block;
    position: relative;
  }

  .tooltip:hover::after {
    background: #333;
    border-radius: 4px;
    bottom: 125%;
    color: #fff;
    content: attr(data-tooltip);
    font-size: 12px;
    left: 0;
    opacity: .9;
    padding: 6px 10px;
    position: absolute;
    text-transform: none;
    white-space: nowrap;
    z-index: 10;
  }

  .form-pair {
    display: flex;
    align-items: center;
    /* Center vertically */
    justify-content: flex-start;
    gap: 10px;
    margin-bottom: 15px;
    margin-top: 8px;
  }

  .input-wrapper {
    display: flex;
    flex-direction: column;
    flex: 1;
    /* Let input fill remaining width */
  }

  .form-pair label {
    width: 130px;
    /* Match other field labels */
    color: var(--primary-blue);
    font-weight: bold;
    text-align: left;
    /* Align text right for consistency */
    margin-right: 10px;
  }

  .form-pair input,
  .form-pair select {
    background: #111;
    color: #fff;
    width: 200px;
    /* Full width under input-wrapper */
    min-width: fit-content;
    max-width: 100%;
    /* Cap the input width if needed */
  }

  .form-pair input[type="text"],
  .form-pair input[type="password"] {
    min-width: fit-content;
    max-width: 100%;
    /* Cap the input width if needed */
  }

  .short-input {
    flex: 0 0 auto;

  }

  .short-input-filter {
    flex: 0 0 auto;

  }

  #pool.short-input {
    flex: 0 0 auto;

  }

  input.invalid {
    border-color: red;
    color: red;
  }

  .field-warning {
    color: red;
    display: none;
    font-size: 12px;
    margin-top: 4px;
  }

  input.invalid+.field-warning {
    display: block;
  }

  @keyframes shake {

    0%,
    100% {
      transform: translateX(0);
    }

    25% {
      transform: translateX(-5px);
    }

    50% {
      transform: translateX(5px);
    }

    75% {
      transform: translateX(-5px);
    }
  }

  #vm-backup-and-restore-settings.shake {
    animation: shake .3s;
  }

  @keyframes flash {
    0% {
      opacity: 0;
      transform: scale(1);
    }

    50% {
      opacity: 1;
      transform: scale(1.1);
    }

    100% {
      opacity: 1;
      transform: scale(1);
    }
  }

  #moved-log-container h3 {
    color: var(--primary-blue);
    font-size: 18px;
    margin-bottom: 12px;
  }

  #vm-backup-and-restore-log {
    background: #111;
    border: 1px solid var(--primary-blue);
    border-radius: 8px;
    box-sizing: border-box;
    color: #00ffaa;
    font-family: monospace;
    font-size: 13px;
    padding: 10px;
    white-space: pre-wrap;
    width: 100%;
    word-break: break-word;
  }

  #log-counts {
    color: var(--primary-blue);
    font-size: 14px;
    margin-bottom: 0px;
    text-align: left;
    width: 100%;
  }

  .skipped-line {
    color: #ffd700;
  }

  .log-header {
    align-items: flex-start;
    display: flex;
    flex-direction: column;
    margin-bottom: 12px;
  }

  .log-header h3 {
    color: var(--primary-blue);
    font-size: 18px;
    margin: 0;
  }

  .log-header-row {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 8px;
  }

  .log-header-row h3 {
    color: var(--primary-blue);
    font-size: 18px;
    margin: 0;
  }

  .log-header-row button {
    margin-top: -1px;
    background: transparent;
    color: #ff8800;
    border: 2px solid #ff6600;
  }

  .log-header-row button:hover {
    background: linear-gradient(90deg, #ff3c00 0%, #ff8800 100%);
    color: #fff;
    box-shadow: 0 0 8px rgba(255, 136, 0, 0.4);
    transform: translateY(-1px);
  }

  .log-header-row button:active {
    transform: translateY(0);
    box-shadow: 0 0 4px rgba(255, 136, 0, 0.2);
  }

  .toast-wrapper {
    display: flex;
    flex-direction: column;
    align-items: flex-end;
    position: relative;
  }

  .toast-wrapper .toast-inline {
    align-self: flex-end;
  }

  .toast-inline {
    display: block;
    /* take full row under button */
    border-radius: 6px;
    color: #ff8800;
    font-size: 13px;
    font-weight: 600;
    padding: 6px 12px;
    margin-top: -17px;
    opacity: 0;
    height: 0;
    overflow: hidden;
    transform: translateY(-6px);
    transition:
      opacity 0.4s ease,
      transform 0.3s ease,
      height 0.3s ease,
      margin 0.3s ease;
    pointer-events: none;
    text-align: center;
    white-space: nowrap;
  }

  .toast-inline.show {
    opacity: 1;
    height: auto;
    margin-top: 8px;
    transform: translateY(0);
  }

  .toast-inline.hide {
    opacity: 0;
    height: 0;
    margin-top: 0;
    transform: translateY(-6px);
  }

  .log-stats {
    color: #00ffaa;
    font-size: 14px;
    text-align: right;
    white-space: nowrap;
  }

  #last-run-container h3 {
    color: var(--primary-blue);
    font-size: 18px;
    margin-bottom: 12px;
  }

  #last-run-log {
    background: #111;
    border: 1px solid var(--primary-blue);
    border-radius: 8px;
    color: #00ffaa;
    font-family: monospace;
    font-size: 13px;
    max-height: 95vh;
    overflow-y: auto;
    padding: 10px;
    white-space: pre-wrap;
    word-break: break-word;
  }

  #log-filter {
    background: #111;
    border: 1px solid var(--primary-blue);
    border-radius: 6px;
    box-shadow: 0 0 6px rgba(0, 128, 128, .3);
    color: #00ffaa;
    font-family: monospace;
    font-size: 13px;
    padding: 8px 12px;
    transition: border-color .2s, box-shadow .2s;
    width: 200px;
  }

  #log-filter:focus {
    border-color: #00bfff;
    box-shadow: 0 0 10px rgba(0, 191, 255, .5);
    outline: none;
  }

  #log-filter::placeholder {
    color: #008080;
  }

  input[type="number"].short-input {
    -moz-appearance: auto;
    -webkit-appearance: auto;
    appearance: auto;
  }

  /* Restore number input spinner alignment for Unraid 7.2 */
  input[type="number"] {
    padding-right: 0;
    /* remove internal spacing */
  }

  /* Force Chrome/Webkit to place arrows at field edge */
  input[type="number"]::-webkit-inner-spin-button,
  input[type="number"]::-webkit-outer-spin-button {
    margin: 0;
    right: 0;
    position: absolute;
  }

  #save-messages div {
    opacity: 1;
    transition: opacity .6s;
  }

  .footer>div {
    gap: 6px !important;
  }

  .footer button {
    margin: 0 !important;
  }

  *,
  *::before,
  *::after {
    box-sizing: border-box;
  }

  /* Focus outline for keyboard users */
  :focus-visible {
    outline: 2px solid var(--primary-blue);
    outline-offset: 2px;
  }

  /* Hover and focus for interactive elements */
  button:hover,
  input[type="checkbox"]:hover,
  select:hover,
  a:hover {
    filter: brightness(1.1);
  }

  button:focus-visible,
  input[type="checkbox"]:focus-visible,
  select:focus-visible,
  a:focus-visible {
    outline: 2px solid var(--primary-blue);
    outline-offset: 2px;
  }

  /* Scrollbar dark theme for readability */
  ::-webkit-scrollbar {
    width: 8px;
  }

  ::-webkit-scrollbar-thumb {
    background: var(--primary-blue);
    border-radius: 4px;
  }

  @keyframes manualShake {
    0% {
      transform: translateX(0);
    }

    20% {
      transform: translateX(-8px);
    }

    40% {
      transform: translateX(8px);
    }

    60% {
      transform: translateX(-8px);
    }

    80% {
      transform: translateX(8px);
    }

    100% {
      transform: translateX(0);
    }
  }

  .form-check {
    display: flex;
    align-items: center;
    gap: 0px;
    /* same spacing as other checkboxes */
    cursor: pointer;
    color: var(--primary-blue);
  }

  .form-check input[type="checkbox"] {
    width: 16px;
    height: 16px;
    transform: scale(1.1);
    /* same enlargement as others */
    accent-color: var(--primary-blue);
    cursor: pointer;
  }

  .form-check label {
    margin: 0;
    line-height: 1.4;
    font-size: 14px;
    font-weight: bold;
    color: var(--primary-blue);
    cursor: pointer;
  }

  .vm-multiselect {
    position: relative;
    width: 200px;
    border: 1px solid #ff4444;
    padding: 6px;
    background: #111;
    cursor: pointer;
    color: #111;
    transition: width .2s;
    white-space: nowrap;
    border-radius: 4px;
    transition: border-color .15s, box-shadow .15s;
  }

  .vm-multiselect.active {
    border-color: #ff4444;
  }

  .vm-dropdown-label-restore,
  .vm-dropdown-label {
    color: #fff;
    user-select: none;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .vm-dropdown-list-restore,
  .vm-dropdown-list {
    padding: 6px;
    display: none;
    position: absolute;
    top: 100%;
    left: 0;
    width: 100%;
    max-width: 100%;
    max-height: 200px;
    overflow-y: auto;
    border: 1px solid #ff4444;
    background: #111;
    color: #fff;
    z-index: 10;
    font-family: 'Segoe UI', sans-serif;
  }

  .vm-dropdown-list-restore div,
  .vm-dropdown-list div {
    padding: 4px 0;
    text-align: left;
    line-height: 1.5;
    height: 28px;
    display: flex;
    align-items: center;
  }

  .vm-dropdown-list-restore label,
  .vm-dropdown-list label {
    display: flex;
    align-items: center;
    gap: 6px;
    color: #fff;
    padding-left: 0px;
  }

  .vm-dropdown-list-restore input[type="checkbox"],
  .vm-dropdown-list input[type="checkbox"] {
    align-items: left;
    appearance: none;
    width: 16px;
    height: 16px;
    border: 1px solid #ccc;
    background: #222;
    cursor: pointer;
    position: relative;
    accent-color: #ff4444;
  }

  .vm-dropdown-list-restore input[type="checkbox"]:checked::after,
  .vm-dropdown-list input[type="checkbox"]:checked::after {
    content: '‚úî';
    position: absolute;
    top: 0;
    left: 2px;
    font-size: 14px;
    color: #fff;
  }

  .vm-dropdown-list-restore div:hover,
  .vm-dropdown-list div:hover {
    background: #111;
  }

  .checkbox-row label.vm-backup-and-restoretip {
    display: inline-flex;
    /* shrink to content */
    align-items: center;
    /* vertically center checkbox and text */
    width: auto;
    /* prevent stretching */
    cursor: pointer;
    /* nice hover pointer */
  }

  .checkbox-row input[type="checkbox"] {
    margin-right: 6px;
    /* space between checkbox and text */
  }

  .vm-dropdown-item.no-vms-restore,
  .vm-dropdown-item.no-vms {
    color: #999;
    cursor: default;
    font-style: italic;
  }

  #move-now-confirmation {
    animation: flash .4s ease;
    background: var(--primary-blue);
    border-radius: 6px;
    clear: both;
    color: #fff;
    display: block;
    font-weight: bold;
    opacity: 0;
    padding: 6px 12px;
    transition: opacity .4s ease;
    width: fit-content;
    display: inline-block;
    margin-bottom: 10px;
  }

  #vm-backup-and-restore-wrapper {
    width: 25vw;
    /* 25% of viewport width */
    max-width: 480px;
    /* optional: keeps it sane on big screens */
    min-width: 320px;
    /* optional: avoids it being too narrow */
  }

  #vm-backup-and-restore-layout {
    display: grid;
    grid-template-columns: 25% 25%;
    gap: 20px;
    align-items: start;
  }

  .status-row2 {
    display: flex;
    justify-content: flex-end;
    gap: 6px;
    /* optional spacing between label and value */
  }
</style>

<?php
$plg = "/boot/config/plugins/vm-backup-and-restore.plg";
$version = "unknown";

if (is_file($plg)) {
    $xml = @simplexml_load_file($plg);
    if ($xml && isset($xml['version'])) {
        $version = (string)$xml['version'];
    }
}
?>

<div id="vm-backup-and-restore-layout">
  <div id="vm-backup-and-restore-wrapper">
    <form id="vm-backup-and-restore-settings">

      <h2>Backup:</h2>

      <!-- VM -->
      <div class="form-pair">
        <label>
          <span class="vm-backup-and-restoretip" title="Choose which VM(s) to backup">
            VM(s) To Backup:
          </span>
        </label>

        <div id="vm-dropdown" class="vm-multiselect vm-backup-and-restoretip" title="Choose which VM(s) to backup"
          data-selected="<?php echo htmlspecialchars($settings['VM_NAME'] ?? '') ?>">
          <div class="vm-dropdown-label">Select VM(s)</div>
          <div class="vm-dropdown-list"></div>
        </div>
      </div>

      <!-- DESTINATION -->
      <div class="form-pair">
        <label>
          <span class="vm-backup-and-restoretip"
            title="Choose destination for backup. Each VM will be saved to a subdirectory with the name the same as the VM">
            Backup Destination:
          </span>
        </label>

        <span class="vm-backup-and-restoretip"
          title="Choose destination for backup. Each VM will be saved to a subdirectory with the name the same as the VM">
          <input type="text" id="backup_destination" name="BACKUP_DESTINATION" placeholder="e.g. /mnt/user/backups/vms"
            value="<?php echo htmlspecialchars($settings['BACKUP_DESTINATION'] ?? ''); ?>">
        </span>
      </div>

      <!-- NUMBER OF BACKUPS -->
      <div class="form-pair">
        <label for="number_of_backups">
          <span title="Choose the amount of backups to keep for the VM" class="vm-backup-and-restoretip">
            Number Of Backups:
          </span>
        </label>

        <span title="Choose the amount of backups to keep for the VM" class="vm-backup-and-restoretip">
          <select id="number_of_backups" class="short-input" name="number_of_backups">
            <?php
        $current = $settings['NUMBER_OF_BACKUPS'] ?? 0;

        for ($i = 0; $i <= 99; $i++) {
          $selected = ((int)$current === $i) ? 'selected' : '';

          if ($i === 0) {
            echo "<option value=\"0\" $selected>Unlimited</option>";
          } elseif ($i === 1) {
            echo "<option value=\"1\" $selected>Current Only</option>";
          } else {
            echo "<option value=\"$i\" $selected>$i</option>";
          }
        }
      ?>
          </select>
        </span>
      </div>

      <!-- STOP VMS -->
      <div class="form-pair">
        <label for="stop_vms">
          <span title="Choose whether VMs should be stopped during backup" class="vm-backup-and-restoretip">
            Stop VMs:
          </span>
        </label>

        <span title="Choose whether VMs should be stopped during backup" class="vm-backup-and-restoretip">
          <select id="stop_vms" class="short-input" name="stop_vms">
            <option value="yes" <?=($settings['STOP_VMS'] ?? 'yes' )==='yes' ? 'selected' : '' ?>>
              Yes - Full backup
            </option>
            <option value="no" <?=($settings['STOP_VMS'] ?? 'yes' )==='no' ? 'selected' : '' ?>>
              No - Snapshot backup
            </option>
          </select>
        </span>
      </div>

      <!-- DRY RUN -->
      <div class="form-pair">
        <label for="dry_run">
          <span class="vm-backup-and-restoretip" title="Enable to simulate backup">
            Dry Run:
          </span>
        </label>

        <span class="vm-backup-and-restoretip" title="Enable to simulate backup">
          <select id="dry_run" class="short-input" name="dry_run">
            <option value="0" <?=((string)($settings['DRY_RUN'] ?? '1' )==='0' ) ? 'selected' : '' ?>>Yes</option>
            <option value="1" <?=((string)($settings['DRY_RUN'] ?? '1' )==='1' ) ? 'selected' : '' ?>>No</option>
          </select>
        </span>
      </div>

      <!-- NOTIFICATIONS -->
      <div class="form-pair">
        <label for="enable_notifications">
          <span class="vm-backup-and-restoretip"
            title="Send Unraid system notifications when VM backup starts and finishes">
            Enable Notifications:
          </span>
        </label>

        <span class="vm-backup-and-restoretip"
          title="Send Unraid system notifications when VM backup starts and finishes">
          <select id="enable_notifications" class="short-input" name="enable_notifications">
            <option value="1" <?=((int)($settings['ENABLE_NOTIFICATIONS'] ?? 0)===1) ? 'selected' : '' ?>>
              Yes
            </option>
            <option value="0" <?=((int)($settings['ENABLE_NOTIFICATIONS'] ?? 0)===0) ? 'selected' : '' ?>>
              No
            </option>
          </select>
        </span>
      </div>

      <!-- BACKUP OWNER -->
      <div class="form-pair">
        <label>
          <span class="vm-backup-and-restoretip"
            title="Choose the owner for the backup if you wanted it owned by one of your created users">
            Backup Owner:
          </span>
        </label>

        <span class="vm-backup-and-restoretip"
          title="Choose the owner for the backup if you wanted it owned by one of your created users">
          <select id="backup_owner" name="BACKUP_OWNER"
            data-selected="<?php echo htmlspecialchars($settings['BACKUP_OWNER'] ?? 'nobody'); ?>">
          </select>
        </span>
      </div>

      <div id="backup-status" style="color:red; font-weight:bold; margin-bottom:6px; display:none;">
        Backup in progress!
      </div>

      <!-- Backup Button-->
      <div class="form-group">
        <span title="Run backup of selected VM's. Last 20 logs kept at destination/logs"
          class="vm-backup-and-restoretip">
          <button type="button" id="backupbtn">Backup</button>
        </span>
      </div>
    </form>
  </div>

  <div id="vm-backup-and-restore-wrapper">
    <form id="vm-backup-and-restore-settings">

      <h2>Restore:</h2>

      <!-- LOCATION -->
      <div class="form-pair">
        <label>
          <span class="vm-backup-and-restoretip" title="Choose location where backups are located">
            Location Of Backups:
          </span>
        </label>

        <span class="vm-backup-and-restoretip" title="Choose location where backups are located">
          <input type="text" id="restore_location" name="RESTORE_LOCATION" placeholder="your backup destination"
            value="<?php echo htmlspecialchars($restoreSettings['RESTORE_LOCATION'] ?? ''); ?>">
        </span>
      </div>

      <!-- VM RESTORE -->
      <div class="form-pair">
        <label>
          <span class="vm-backup-and-restoretip" title="Choose which VM(s) to restore">
            VM(s) To Restore:
          </span>
        </label>

        <div id="vm-dropdown-restore" class="vm-multiselect vm-backup-and-restoretip"
          title="Choose which VM(s) to restore"
          data-selected="<?php echo htmlspecialchars($restoreSettings['VM_NAME_RESTORE'] ?? '') ?>">

          <div class="vm-dropdown-label-restore">Select VM(s)</div>
          <div class="vm-dropdown-list-restore"></div>
        </div>

        <!-- üî• CRITICAL: Hidden field that JS reads on page load -->
        <input type="hidden" id="vm-hidden-restore" name="VM_NAME_RESTORE"
          value="<?php echo htmlspecialchars($restoreSettings['VM_NAME_RESTORE'] ?? '') ?>">
      </div>

      <!-- VERSION FIELDS (auto-generated) -->
      <div id="version-fields-container"></div>

      <!-- RESTORE DESTINATION -->
      <div class="form-pair">
        <label>
          <span class="vm-backup-and-restoretip" title="Choose destination to restore VM(s) to">
            Restore Destination:
          </span>
        </label>

        <span class="vm-backup-and-restoretip" title="Choose destination to restore VM(s) to">
          <input type="text" id="restore_destination" name="RESTORE_DESTINATION" placeholder="e.g. /mnt/user/domains"
            value="<?php echo htmlspecialchars($restoreSettings['RESTORE_DESTINATION'] ?? ''); ?>">
        </span>
      </div>

      <!-- DRY RUN -->
      <div class="form-pair">
        <label for="dry_run_restore">
          <span class="vm-backup-and-restoretip" title="Enable to simulate restore">
            Dry Run:
          </span>
        </label>

        <span class="vm-backup-and-restoretip" title="Enable to simulate restore">
          <select id="dry_run_restore" class="short-input" name="DRY_RUN_RESTORE">
            <?php
        $val = (string)($restoreSettings['DRY_RUN_RESTORE'] ?? 'true');
      ?>
            <option value="true" <?=$val==='true' ? 'selected' : '' ?>>Yes</option>
            <option value="false" <?=$val==='false' ? 'selected' : '' ?>>No</option>
          </select>
        </span>
      </div>

      <!-- NOTIFICATIONS -->
      <div class="form-pair">
        <label for="enable_notifications_restore">
          <span class="vm-backup-and-restoretip"
            title="Send Unraid system notifications when VM restore starts and finishes">
            Enable Notifications:
          </span>
        </label>

        <span class="vm-backup-and-restoretip"
          title="Send Unraid system notifications when VM restore starts and finishes">
          <select id="enable_notifications_restore" class="short-input" name="enable_notifications_restore">
            <option value="1" <?=((int)($restoreSettings['ENABLE_NOTIFICATIONS_RESTORE'] ?? 0)===1) ? 'selected' : '' ?>
              >
              Yes
            </option>
            <option value="0" <?=((int)($restoreSettings['ENABLE_NOTIFICATIONS_RESTORE'] ?? 0)===0) ? 'selected' : '' ?>
              >
              No
            </option>
          </select>
        </span>
      </div>

      <div id="restore-status" style="color:red; font-weight:bold; margin-bottom:6px; display:none;">
        Restore in progress!
      </div>

      <!-- Restore Button-->
      <div class="form-group">
        <span title="Restore selected VM" class="vm-backup-and-restoretip">
          <button type="button" id="restorebtn">Restore</button>
        </span>
      </div>
      <div class="status-container">
        <div class="status-row2"><span class="status-label">Plugin Version:</span><span id="version-text">
            <?= $version ?>
          </span></div>
      </div>
    </form>
  </div>

</div>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    const locationInput = document.getElementById("restore_location");

    function updateVisibility() {
      const hasPath = locationInput.value.trim().length > 0;
    }

    // Trigger on load (in case settings already contain a path)
    updateVisibility();

    // Trigger on user input
    locationInput.addEventListener("input", updateVisibility);
  });

  $(document).ready(function () {
    const select = $('#backup_owner');
    const selected = select.data('selected') || 'nobody';

    $.getJSON('/plugins/vm-backup-and-restore/helpers/list_users_group100.php', function (data) {
      select.empty();

      data.users.forEach(user => {
        const opt = $('<option>', {
          value: user,
          text: user
        });

        if (user === selected) {
          opt.prop('selected', true);
        }

        select.append(opt);
      });
    });
  });

  $(document).ready(function () {
    const dropdown = $('#vm-dropdown');
    const label = dropdown.find('.vm-dropdown-label');
    const list = dropdown.find('.vm-dropdown-list');

    // Saved selections (comma-separated string)
    const selectedRaw = dropdown.data('selected') || '';
    const selected = selectedRaw.split(',').map(s => s.trim()).filter(s => s !== '');

    /* -----------------------------
       OPEN / CLOSE BEHAVIOR
       ----------------------------- */

    label.on('click', function (e) {
      // Prevent opening if no VMs
      if (dropdown.hasClass('disabled')) return;

      e.stopPropagation();
      list.toggle();

      dropdown.toggleClass('active', list.is(':visible'));
    });

    // Close when clicking outside
    $(document).on('click', function (e) {
      if (!$(e.target).closest('#vm-dropdown').length) {
        list.hide();
        dropdown.removeClass('active');
      }
    });

    /* -----------------------------
       LOAD VM LIST
       ----------------------------- */
    $.getJSON('/plugins/vm-backup-and-restore/helpers/list_vms.php', function (data) {
      list.empty();

      if (!data.vms || data.vms.length === 0) {
        // No VMs found
        list.append('<div class="vm-dropdown-item no-vms">No VMs found</div>');
        label.text('No VMs available');
        dropdown.addClass('disabled'); // visually indicate disabled
      } else {
        data.vms.forEach(vm => {
          const id = 'vmchk-' + vm.replace(/\s+/g, '_');

          const item = $(`
            <div>
              <label>
                <input type="checkbox" value="${vm}" id="${id}">
                ${vm}
              </label>
            </div>
          `);

          // Pre-select saved values
          if (selected.includes(vm)) {
            item.find('input').prop('checked', true);
          }

          list.append(item);
        });

        updateLabel();
      }
    });

    /* -----------------------------
       UPDATE LABEL + HIDDEN FIELD
       ----------------------------- */
    function updateLabel() {
      const checked = list.find('input:checked').map(function () {
        return $(this).val();
      }).get();

      if (checked.length === 0) {
        label.text('Select VM(s)');
      } else {
        label.text(checked.join(', '));
      }

      ensureHiddenField(checked.join(','));
    }

    list.on('change', 'input[type=checkbox]', updateLabel);

    function ensureHiddenField(value) {
      let hidden = $('#vm-hidden');
      if (!hidden.length) {
        hidden = $('<input>', {
          type: 'hidden',
          id: 'vm-hidden',
          name: 'VM_NAME'
        }).appendTo(dropdown.parent());
      }
      hidden.val(value);
    }

    /* -----------------------------
       TOOLTIPSTER INIT
       ----------------------------- */
    $('.vm-backup-and-restoretip').tooltipster({
      maxWidth: 300
    });
  });

  // Force-close any Dynamix tooltip when dropdown opens
  function closeTooltips() {
    $('.vm-backup-and-restoretip').trigger('mouseleave');
  }

  $('.vm-dropdown-label, .vm-dropdown-list, select, .custom-dropdown').on('click', function () {
    closeTooltips();
  });

  const versionSelections = {};

  document.addEventListener("DOMContentLoaded", () => {
    const vmDropdownRestore = document.getElementById("vm-dropdown-restore");
    const versionContainer = document.getElementById("version-fields-container");

    function rebuildVersionFields() {
      const container = $('#version-fields-container');
      container.empty(); // atomic reset

      const raw = $('#vm-hidden-restore').val() || '';
      const selected = raw
        .split(',')
        .map(s => s.trim())
        .filter(Boolean);

      // If nothing selected, nothing to build
      if (selected.length === 0) return;

      selected.forEach(vm => {
        $.getJSON(
          '/plugins/vm-backup-and-restore/helpers/get_vm_versions.php',
          {
            vm: vm,
            restore_path: $('#restore_location').val()
          },
          function (versions) {
            const wrapper = $(`
          <div class="form-pair version-field">
            <label>
              <span class="vm-backup-and-restoretip" title="Choose version for ${vm}">
                Version for ${vm}:
              </span>
            </label>
            <select name="VERSION_${vm}" class="version-select"></select>
          </div>
        `);

            const select = wrapper.find('select');

            if (!versions || versions.length === 0) {
              select.append(`<option value="">NONE FOUND</option>`);
            } else {
              versions.forEach((v, idx) => {
                let label = v.display;
                if (idx === 0) label += ' (LATEST)';
                if (idx === versions.length - 1) label += ' (OLDEST)';
                select.append(`<option value="${v.raw}">${label}</option>`);
              });
            }

            container.append(wrapper);
          }
        );
      });
    }

    // Trigger rebuild when VM selection changes
    vmDropdownRestore.addEventListener("change", rebuildVersionFields);

    // Initial load ‚Äî will work ONLY if #vm-hidden-restore has persisted values
    rebuildVersionFields();

  });

  $(document).ready(function () {
    const dropdown = $('#vm-dropdown-restore');
    const list = dropdown.find('.vm-dropdown-list-restore');
    const label = dropdown.find('.vm-dropdown-label-restore');

    // Saved selections (comma-separated)
    const selectedRaw = dropdown.data('selected') || '';
    const selected = selectedRaw.split(',').map(s => s.trim()).filter(s => s !== '');

    // Toggle dropdown
    dropdown.on('click', function (e) {
      e.stopPropagation();
      list.toggle();
      dropdown.toggleClass('active', list.is(':visible'));
    });

    // Close when clicking outside
    $(document).on('click', function () {
      list.hide();
      dropdown.removeClass('active');
    });

    // Prevent checkbox clicks from closing the dropdown
    list.on('click', 'input[type=checkbox]', function (e) {
      e.stopPropagation();
    });

    // Prevent label clicks from closing the dropdown
    list.on('click', 'label', function (e) {
      e.stopPropagation();
    });

    // Load restore folders
    function loadRestoreFolders() {
      const restorePath = $('#restore_location').val();
      if (!restorePath) {
        list.empty();
        label.text('No backups at this location');
        return;
      }

      $.getJSON('/plugins/vm-backup-and-restore/helpers/list_restore_folders.php', { restore_path: restorePath }, function (data) {
        list.empty();

        if (data.error) {
          console.warn(data.error);
          label.text('No VMs here');
          return;
        }

        data.folders.forEach(folder => {
          const id = 'vmrestore-' + folder.replace(/\s+/g, '_');

          const item = $(`
          <div>
            <label>
              <input type="checkbox" value="${folder}" id="${id}">
              ${folder}
            </label>
          </div>
        `);

          if (selected.includes(folder)) {
            item.find('input').prop('checked', true);
          }

          list.append(item);
        });

        updateRestoreLabel();
      });
    }

    // Update label & hidden field
    function updateRestoreLabel() {
      const checked = list.find('input:checked').map(function () {
        return $(this).val();
      }).get();

      if (checked.length === 0) {
        label.text('Select VM(s)');
      } else {
        label.text(checked.join(', '));
      }

      ensureHiddenFieldRestore(checked.join(','));
    }

    function ensureHiddenFieldRestore(value) {
      let hidden = $('#vm-hidden-restore');
      if (!hidden.length) {
        hidden = $('<input>', {
          type: 'hidden',
          id: 'vm-hidden-restore',
          name: 'VM_NAME_RESTORE'
        }).appendTo(dropdown.parent());
      }
      hidden.val(value);
    }

    // Listen for checkbox changes
    list.on('change', 'input[type=checkbox]', updateRestoreLabel);
    list.on('change', 'input[type=checkbox]', function () {
      updateRestoreLabel();
    });

    // Load folders on restore path change
    $('#restore_location').on('input blur change', function () {
      loadRestoreFolders();
    });

    // Initial load if restore_location already has a value
    loadRestoreFolders();
  });
</script>

<script>
  let backupStartTime = 0;
  const MIN_DURATION = 5000;

  function updateBackupUI(running) {

    const btn = $('#backupbtn');
    const status = $('#backup-status');

    if (running) {

      if (!backupStartTime) {
        backupStartTime = Date.now();
      }

      btn.prop('disabled', true);
      btn.text('Backup running...');
      status.show();

      return;
    }

    if (!backupStartTime) {
      // Not running and never started
      btn.prop('disabled', false);
      btn.text('Backup');
      status.hide();
      return;
    }

    const elapsed = Date.now() - backupStartTime;

    if (elapsed < MIN_DURATION) {
      setTimeout(() => updateBackupUI(false), MIN_DURATION - elapsed);
      return;
    }

    backupStartTime = 0;

    btn.prop('disabled', false);
    btn.text('Backup');
    status.hide();
  }

  function pollBackupStatus() {
    $.getJSON('/plugins/vm-backup-and-restore/helpers/backup_status.php', function (res) {
      updateBackupUI(res.running);
    });
  }

  setInterval(pollBackupStatus, 1000);

  $(document).ready(function () {
    pollBackupStatus();
  });

  // Force-close any Dynamix tooltip
  function closeTooltips() {
    $('.vm-backup-and-restoretip').trigger('mouseleave');
  }

  // When your dropdown opens, close tooltips
  $('.vm-dropdown-label, .vm-dropdown-list, select, .custom-dropdown').on('click', function () {
    closeTooltips();
  });

  let backupRequestInProgress = false;

  $('#backupbtn').on('click', function () {

    if (backupRequestInProgress) {
      console.warn('Backup already being triggered');
      return;
    }

    const vms = $('#vm-hidden').val();
    const dest = $('#backup_destination').val().trim();

    if (!vms) {
      alert('Please select at least one VM to backup');
      return;
    }

    if (!dest) {
      alert('Please set a backup destination');
      return;
    }

    backupRequestInProgress = true;  // üîí prevent double-click

    const params = $.param({
      VM_NAME: vms,
      BACKUP_DESTINATION: dest,
      NUMBER_OF_BACKUPS: $('#number_of_backups').val(),
      STOP_VMS: $('#stop_vms').val(),
      DRY_RUN: $('#dry_run').val(),
      ENABLE_NOTIFICATIONS: $('#enable_notifications').val(),
      BACKUP_OWNER: $('#backup_owner').val(),
      csrf_token: csrfToken
    });

    $.get('/plugins/vm-backup-and-restore/helpers/save_settings.php?' + params)
      .done(function (res) {

        if (res && res.status === 'ok') {
          startBackup();  // let polling detect running state
        } else {
          alert('Failed to save settings');
        }

      })
      .fail(function () {
        alert('Error saving settings');
      })
      .always(function () {
        // üîì ALWAYS release click lock after request finishes
        backupRequestInProgress = false;
      });

  });

  function startBackup() {
    $.get('/plugins/vm-backup-and-restore/helpers/backup.php', {
      csrf_token: csrfToken
    })
      .done(function (res) {
        if (res && res.status === 'ok') {
          console.log('Backup started, PID:', res.pid);
        } else {
          alert(res.message || 'Failed to start backup');
        }
      })
      .fail(function () {
        alert('Error starting backup');
      });
  }
</script>

<script>
  let restoreStartTime = 0;
  const MIN_RESTORE_DURATION = 5000;

  function updateRestoreUI(running) {

    const btn = $('#restorebtn');
    const status = $('#restore-status');

    if (running) {

      if (!restoreStartTime) {
        restoreStartTime = Date.now();
      }

      btn.prop('disabled', true);
      btn.text('Restore running...');
      status.show();

      return;
    }

    if (!restoreStartTime) {
      btn.prop('disabled', false);
      btn.text('Restore');
      status.hide();
      return;
    }

    const elapsed = Date.now() - restoreStartTime;

    if (elapsed < MIN_RESTORE_DURATION) {
      setTimeout(() => updateRestoreUI(false), MIN_RESTORE_DURATION - elapsed);
      return;
    }

    restoreStartTime = 0;

    btn.prop('disabled', false);
    btn.text('Restore');
    status.hide();
  }

  function pollRestoreStatus() {
    $.getJSON('/plugins/vm-backup-and-restore/helpers/restore_status.php', function (res) {
      updateRestoreUI(res.running);
    });
  }

  setInterval(pollRestoreStatus, 1000);

  $(document).ready(function () {
    pollRestoreStatus();
  });

  // Force-close any Dynamix tooltip
  function closeTooltips() {
    $('.vm-backup-and-restoretip').trigger('mouseleave');
  }

  // When your dropdown opens, close tooltips
  $('.vm-dropdown-label, .vm-dropdown-list, select, .custom-dropdown').on('click', function () {
    closeTooltips();
  });

  // üîß Collect per-VM version selections
  function collectRestoreVersions() {
    const versions = {};

    $('#version-fields-container select.version-select').each(function () {
      const vm = $(this).data('vm');
      const val = $(this).val();

      if (vm && val) {
        versions[vm] = val;
      }
    });

    return versions;
  }

  $('#restorebtn').on('click', function () {

    // Basic validation
    const vms_restore = $('#vm-hidden-restore').val();
    const dest = $('#restore_location').val().trim();
    const restore_dest = $('#restore_destination').val().trim();

    if (!vms_restore) {
      alert('Please select at least one VM to restore');
      return;
    }

    if (!dest) {
      alert('Please set a restore location');
      return;
    }

    if ($('#restorebtn').prop('disabled')) {
      return;
    }

    // üîß Build restore versions string (vm=version,vm=version)
    const restoreVersions = collectRestoreVersions();
    const restoreVersionsStr = Object.entries(restoreVersions)
      .map(([vm, ver]) => `${vm}=${ver}`)
      .join(',');

    const params = $.param({
      VM_NAME_RESTORE: vms_restore,
      RESTORE_LOCATION: dest,
      DRY_RUN_RESTORE: $('#dry_run_restore').val(),
      ENABLE_NOTIFICATIONS_RESTORE: $('#enable_notifications_restore').val(),
      RESTORE_VERSIONS: restoreVersionsStr,
      RESTORE_DESTINATION: restore_dest,
      csrf_token: csrfToken
    });

    // Save settings first
    $.get(
      '/plugins/vm-backup-and-restore/helpers/save_settings_restore.php?' + params
    )
      .done(function (res) {
        if (res && res.status === 'ok') {
          console.log('Settings saved');

          // NOW trigger the actual restore
          startRestore();
        } else {
          alert('Failed to save settings');
        }
      })
      .fail(function () {
        alert('Error saving settings');
      });

  });

  function startRestore() {
    $.get('/plugins/vm-backup-and-restore/helpers/restore.php', {
      csrf_token: csrfToken
    })
      .done(function (res) {
        if (res && res.status === 'ok') {
          console.log('Restore started, PID:', res.pid);
        } else {
          alert(res.message || 'Failed to start restore');
        }
      })
      .fail(function () {
        alert('Error starting restore');
      });
  }

  if (typeof caPluginUpdateCheck === "function") {
    caPluginUpdateCheck("vm-backup-and-restore.plg", { name: "vm-backup-and-restore" });
  }

</script>