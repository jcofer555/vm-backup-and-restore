Menu="Utilities"
Type="xmenu"
Title="VM-Backup-And-Restore"
Icon="icon.png"
Tag="icon.png"
Markdown="false"
---
<?php
$cfgPath = '/boot/config/plugins/vm-backup-and-restore/settings.cfg';

// Define all default keys and their order
$defaults = [
    'POOL_NAME' => 'cache',
    'DRY_RUN' => 'no',
    'ALLOW_DURING_PARITY' => 'no',
    'AUTOSTART' => 'no',
    'CRON_MODE' => 'minutes',
    'MINUTES_FREQUENCY' => '2',
    'HOURLY_FREQUENCY' => '',
    'DAILY_TIME' => '',
    'WEEKLY_DAY' => '',
    'WEEKLY_TIME' => '',
    'MONTHLY_DAY' => '',
    'MONTHLY_TIME' => '',
    'CUSTOM_CRON' => '',
    'CRON_EXPRESSION' => '',
    'ENABLE_NOTIFICATIONS' => 'no',
    'WEBHOOK_URL' => ''
];

// Load existing config if present
$existing = [];
if (file_exists($cfgPath)) {
    $existing = parse_ini_file($cfgPath) ?: [];
}
// Merge without overwriting existing keys
foreach ($defaults as $key => $value) {
    if (!array_key_exists($key, $existing)) {
        $existing[$key] = $value;
    }
}
// Rebuild config text in the correct order
$configText = '';
foreach ($defaults as $key => $defaultValue) {
    $val = $existing[$key];
    $configText .= "$key=\"$val\"\n";
}
@file_put_contents($cfgPath, $configText);
$settings = $existing;
?>

<?php
$unraid_version = "7.2"; // fallback
if (file_exists("/etc/unraid-version")) {
    $data = parse_ini_file("/etc/unraid-version");
    if (!empty($data["version"])) {
        $unraid_version = $data["version"];
    }
}
?>

<script>
  // UNIVERSAL CSRF TOKEN DISCOVERY for Unraid plugin pages
  let csrfToken = "<?= $_GET['csrf_token'] ?? ($_COOKIE['csrf_token'] ?? '') ?>";

  // Try dynamic lookup from global scope, cookie, or meta
  if (!csrfToken || csrfToken === "undefined" || csrfToken === "") {
    try {
      // 1️⃣ Try the global variable used by Unraid's WebGUI JS
      if (typeof window.csrf_token !== "undefined" && window.csrf_token) {
        csrfToken = window.csrf_token;
      }

      // 2️⃣ Try any embedded meta tag
      if ((!csrfToken || csrfToken === "") && document.querySelector("meta[name='csrf_token']")) {
        csrfToken = document.querySelector("meta[name='csrf_token']").getAttribute("content");
      }

      // 3️⃣ Try cookie (most Unraid builds set it)
      if ((!csrfToken || csrfToken === "") && document.cookie.includes("csrf_token=")) {
        const m = document.cookie.match(/csrf_token=([^;]+)/);
        if (m) csrfToken = decodeURIComponent(m[1]);
      }

      // 4️⃣ Fallback: try to extract from any script tag in the parent frame
      if ((!csrfToken || csrfToken === "") && window.parent) {
        try {
          if (window.parent.csrf_token) csrfToken = window.parent.csrf_token;
        } catch (e) { /* ignore cross-frame */ }
      }
    } catch (err) {
      console.warn("CSRF token discovery failed:", err);
    }
  }

  console.log("Resolved CSRF token:", csrfToken || "<empty>");
</script>

<style>
  :root {
    --primary-blue: #00aaff;
    --status-green: #2ECC40;
  }

  /* === Layout Wrapper === */
  #vm-backup-and-restore-wrapper {
    display: flex;
    flex-wrap: nowrap;
    /* stay side-by-side */
    align-items: flex-start;
    /* align at top */
    justify-content: space-evenly;
    /* even horizontal spacing */
    gap: 20px;
    /* space between panels */
    width: 100%;
    box-sizing: border-box;
  }

  /* === Each Panel (auto-sizing) === */
  #vm-backup-and-restore-settings,
  #moved-log-container,
  #last-run-container {
    background: #111;
    border-radius: 12px;
    box-shadow: 0 0 12px rgba(0, 128, 128, .3);
    color: #f0f8ff;
    padding: 20px;
    flex: 1 1 auto;
    /* grow and shrink dynamically */
    height: auto;
    /* dynamic height */
    max-height: none;
    /* remove fixed limit */
    overflow: visible;
    /* expand with content */
    min-width: 0;
    /* prevent overflow on long content */
    box-sizing: border-box;
  }

  #vm-backup-and-restore-settings {
    padding-top: 0px !important;
    /* reduce from default 20px */
  }

  #last-run-container {
    padding-top: 10px !important;
    /* reduce from default 20px */
  }

  #last-run-container h3 {
    margin-top: 0 !important;
    /* remove any top margin */
    margin-bottom: 10px;
    /* keep small spacing below title */
  }

  #moved-log-container {
    padding-top: 10px !important;
    /* reduce from default 20px */
  }

  #moved-log-container h3 {
    margin-top: 0 !important;
    /* remove any top margin */
    margin-bottom: 10px;
    /* keep small spacing below title */
  }

  /* === Optional: fine-tune widths === */
  #vm-backup-and-restore-settings {
    flex-basis: 25%;
  }

  #moved-log-container {
    flex-basis: 53%;
  }

  #last-run-container {
    flex-basis: 22%;
  }

  .unraid-71 #vm-backup-and-restore-settings {
    min-height: 77vh;
    max-height: 77vh;
    overflow-y: auto;
    margin: 0;
  }

  .unraid-71 #moved-log-container pre {
    max-height: 60vh;
    overflow-y: auto;
    margin: 0;
  }

  .unraid-71 #last-run-container pre {
    max-height: 68vh;
    overflow-y: auto;
    margin: 0;
  }

  .unraid-72 #vm-backup-and-restore-settings {
    min-height: 76vh;
    max-height: 76vh;
    overflow-y: auto;
    margin: 0;
  }

  .unraid-72 #moved-log-container pre {
    max-height: 59vh;
    overflow-y: auto;
    margin: 0;
  }

  .unraid-72 #last-run-container pre {
    max-height: 67vh;
    overflow-y: auto;
    margin: 0;
  }

  @media (max-width: 1100px) {
    #vm-backup-and-restore-wrapper {
      flex-wrap: wrap;
    }

    #vm-backup-and-restore-settings,
    #moved-log-container,
    #last-run-container {
      flex: 1 1 100%;
    }
  }

  .form-row {
    flex-direction: column;
    gap: 15px;
    margin-bottom: 20px;
  }

  label {
    color: var(--primary-blue);
    font-weight: bold;
    margin-bottom: 5px;
  }

  input,
  select {
    background: #111;
    border: 1px solid var(--primary-blue);
    border-radius: 5px;
    color: #fff;
    padding: 8px;
  }

  .unraid-71 #vm-backup-and-restore-wrapper {
    margin-top: -31px !important;
  }

  .unraid-72 #vm-backup-and-restore-wrapper {
    margin-top: -20px !important;
  }

  button {
    border: none;
    border-radius: 4px;
    color: #fff;
    cursor: pointer;
    margin-right: 10px;
    padding: 8px 15px;
  }

  .checkbox-row {
    align-items: center;
    display: grid;
    gap: 0 0px;
    grid-template-columns: repeat(2, 1fr);
    margin-top: 10px;
  }

  .checkbox-row label {
    align-items: center;
    cursor: pointer;
    display: flex;
    font-size: 15px;
    gap: 0px;
    line-height: 1.4;
  }

  .checkbox-row input[type="checkbox"] {
    accent-color: var(--primary-blue);
    transform: scale(1.2);
  }

  input[type="checkbox"] {
    accent-color: var(--primary-blue);
    cursor: pointer;
    height: 16px;
    width: 16px;
  }

  .form-check input {
    margin-right: 8px;
    vertical-align: middle;
  }

  .status-container {
    margin-top: 20px;
  }

  .status-row {
    align-items: center;
    display: flex;
    margin-bottom: 6px;
  }

  .status-label {
    color: var(--primary-blue);
    font-weight: bold;
    width: 75px;
  }

  #status-text,
  #last-run-text {
    color: var(--status-green);
  }

  .tooltip {
    display: inline-block;
    position: relative;
  }

  .tooltip:hover::after {
    background: #333;
    border-radius: 4px;
    bottom: 125%;
    color: #fff;
    content: attr(data-tooltip);
    font-size: 12px;
    left: 0;
    opacity: .9;
    padding: 6px 10px;
    position: absolute;
    text-transform: none;
    white-space: nowrap;
    z-index: 10;
  }

  .form-pair {
    display: flex;
    align-items: center;
    /* Center vertically */
    justify-content: flex-start;
    gap: 10px;
    margin-bottom: 15px;
    margin-top: 8px;
  }

  .input-wrapper {
    display: flex;
    flex-direction: column;
    flex: 1;
    /* Let input fill remaining width */
  }

  .form-pair label {
    width: 130px;
    /* Match other field labels */
    color: var(--primary-blue);
    font-weight: bold;
    text-align: left;
    /* Align text right for consistency */
    margin-right: 10px;
  }

  .form-pair input,
  .form-pair select {
    background: #111;
    color: #fff;
    width: 200px;
    /* Full width under input-wrapper */
    min-width: fit-content;
    max-width: 100%;
    /* Cap the input width if needed */
  }

  .form-pair input[type="text"],
  .form-pair input[type="password"] {
    min-width: fit-content;
    max-width: 100%;
    /* Cap the input width if needed */
  }

  .short-input {
    flex: 0 0 auto;

  }

  .short-input-filter {
    flex: 0 0 auto;

  }

  #pool.short-input {
    flex: 0 0 auto;

  }

  input.invalid {
    border-color: red;
    color: red;
  }

  .field-warning {
    color: red;
    display: none;
    font-size: 12px;
    margin-top: 4px;
  }

  input.invalid+.field-warning {
    display: block;
  }

  @keyframes shake {

    0%,
    100% {
      transform: translateX(0);
    }

    25% {
      transform: translateX(-5px);
    }

    50% {
      transform: translateX(5px);
    }

    75% {
      transform: translateX(-5px);
    }
  }

  #vm-backup-and-restore-settings.shake {
    animation: shake .3s;
  }

  #move-now-confirmation,
  #save-confirmation,
  #stop-confirmation {
    animation: flash .4s ease;
    background: var(--primary-blue);
    border-radius: 6px;
    clear: both;
    color: #fff;
    display: block;
    font-weight: bold;
    opacity: 0;
    padding: 6px 12px;
    transition: opacity .4s ease;
    width: fit-content;
    display: inline-block;
    margin-bottom: 10px;
  }

  @keyframes flash {
    0% {
      opacity: 0;
      transform: scale(1);
    }

    50% {
      opacity: 1;
      transform: scale(1.1);
    }

    100% {
      opacity: 1;
      transform: scale(1);
    }
  }

  #moved-log-container h3 {
    color: var(--primary-blue);
    font-size: 18px;
    margin-bottom: 12px;
  }

  #vm-backup-and-restore-log {
    background: #111;
    border: 1px solid var(--primary-blue);
    border-radius: 8px;
    box-sizing: border-box;
    color: #00ffaa;
    font-family: monospace;
    font-size: 13px;
    padding: 10px;
    white-space: pre-wrap;
    width: 100%;
    word-break: break-word;
  }

  #log-counts {
    color: var(--primary-blue);
    font-size: 14px;
    margin-bottom: 0px;
    text-align: left;
    width: 100%;
  }

  .skipped-line {
    color: #ffd700;
  }

  .log-header {
    align-items: flex-start;
    display: flex;
    flex-direction: column;
    margin-bottom: 12px;
  }

  .log-header h3 {
    color: var(--primary-blue);
    font-size: 18px;
    margin: 0;
  }

  .log-header-row {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 8px;
  }

  .log-header-row h3 {
    color: var(--primary-blue);
    font-size: 18px;
    margin: 0;
  }

  .log-header-row button {
    margin-top: -1px;
    background: transparent;
    color: #ff8800;
    border: 2px solid #ff6600;
  }

  .log-header-row button:hover {
    background: linear-gradient(90deg, #ff3c00 0%, #ff8800 100%);
    color: #fff;
    box-shadow: 0 0 8px rgba(255, 136, 0, 0.4);
    transform: translateY(-1px);
  }

  .log-header-row button:active {
    transform: translateY(0);
    box-shadow: 0 0 4px rgba(255, 136, 0, 0.2);
  }

  .toast-wrapper {
    display: flex;
    flex-direction: column;
    align-items: flex-end;
    position: relative;
  }

  .toast-wrapper .toast-inline {
    align-self: flex-end;
  }

  .toast-inline {
    display: block;
    /* take full row under button */
    border-radius: 6px;
    color: #ff8800;
    font-size: 13px;
    font-weight: 600;
    padding: 6px 12px;
    margin-top: -17px;
    opacity: 0;
    height: 0;
    overflow: hidden;
    transform: translateY(-6px);
    transition:
      opacity 0.4s ease,
      transform 0.3s ease,
      height 0.3s ease,
      margin 0.3s ease;
    pointer-events: none;
    text-align: center;
    white-space: nowrap;
  }

  .toast-inline.show {
    opacity: 1;
    height: auto;
    margin-top: 8px;
    transform: translateY(0);
  }

  .toast-inline.hide {
    opacity: 0;
    height: 0;
    margin-top: 0;
    transform: translateY(-6px);
  }

  .log-stats {
    color: #00ffaa;
    font-size: 14px;
    text-align: right;
    white-space: nowrap;
  }

  #last-run-container h3 {
    color: var(--primary-blue);
    font-size: 18px;
    margin-bottom: 12px;
  }

  #last-run-log {
    background: #111;
    border: 1px solid var(--primary-blue);
    border-radius: 8px;
    color: #00ffaa;
    font-family: monospace;
    font-size: 13px;
    max-height: 95vh;
    overflow-y: auto;
    padding: 10px;
    white-space: pre-wrap;
    word-break: break-word;
  }

  #log-filter {
    background: #111;
    border: 1px solid var(--primary-blue);
    border-radius: 6px;
    box-shadow: 0 0 6px rgba(0, 128, 128, .3);
    color: #00ffaa;
    font-family: monospace;
    font-size: 13px;
    padding: 8px 12px;
    transition: border-color .2s, box-shadow .2s;
    width: 200px;
  }

  #log-filter:focus {
    border-color: #00bfff;
    box-shadow: 0 0 10px rgba(0, 191, 255, .5);
    outline: none;
  }

  #log-filter::placeholder {
    color: #008080;
  }

  input[type="number"].short-input {
    -moz-appearance: auto;
    -webkit-appearance: auto;
    appearance: auto;
  }

  /* Restore number input spinner alignment for Unraid 7.2 */
  input[type="number"] {
    padding-right: 0;
    /* remove internal spacing */
  }

  /* Force Chrome/Webkit to place arrows at field edge */
  input[type="number"]::-webkit-inner-spin-button,
  input[type="number"]::-webkit-outer-spin-button {
    margin: 0;
    right: 0;
    position: absolute;
  }

  .select-pool {
    min-width: fit-content;
    appearance: none;
    max-width: 100%;
    overflow: hidden;
    text-overflow: ellipsis;
    transition: width .2s;
    white-space: nowrap;
    width: 200px;
  }

  #save-messages div {
    opacity: 1;
    transition: opacity .6s;
  }

  /* Modal picker */
  #exclusion-modal {
    align-items: center;
    background: rgba(0, 0, 0, .8);
    bottom: 0;
    display: none;
    justify-content: center;
    left: 0;
    position: fixed;
    right: 0;
    top: 0;
    z-index: 9999;
  }

  #exclusion-modal .box {
    background: #111;
    border-radius: 10px;
    color: #fff;
    display: flex;
    flex-direction: column;
    height: 600px;
    min-height: fit-content;
    max-height: 100%;
    overflow: hidden;
    padding: 18px;
    position: relative;
    width: 800px;
    min-width: fit-content;
    max-width: 100%;
  }

  #exclusion-modal .header {
    align-items: center;
    display: flex;
    gap: 10px;
    margin-bottom: 0px;
  }

  #exclusion-modal .crumbs {
    flex: 1;
    overflow: auto;
    white-space: nowrap;
  }

  #exclusion-modal .crumbs a {
    color: #00bfff;
    margin-right: 8px;
    text-decoration: none;
  }

  #exclusion-modal .grid {
    border: 1px solid #333;
    flex: 1;
    overflow-y: auto;
    padding: 6px;
  }

  #exclusion-modal .row {
    align-items: center;
    cursor: default;
    display: flex;
    gap: 0px;
    padding: 0px;
  }

  #exclusion-modal .row .name {
    align-items: center;
    color: #fff;
    display: flex;
    flex: 1;
    font-weight: 500;
    gap: 0px;
  }

  #exclusion-modal .row.folder .name {
    color: var(--primary-blue);
  }

  #exclusion-modal .row .name .icon {
    margin-right: 2px;
  }

  #exclusion-modal .row .name .label {
    display: inline-block;
  }

  #exclusion-modal .row input[type="checkbox"] {
    margin-right: 2px;
    transform: scale(1.1);
  }

  #exclusion-modal .row .type {
    opacity: .7;
    text-align: right;
    width: 70px;
  }

  #exclusion-modal .footer {
    align-items: center;
    display: flex;
    gap: 12px;
    justify-content: space-between;
    margin-top: 0px;
  }

  #exclusion-modal .toast {
    border-radius: 6px;
    bottom: 0px;
    color: red;
    display: none;
    left: 16px;
    padding: 8px 10px;
    position: absolute;
  }

  #exclusion-modal .btn {
    background: #0b5fff;
    border: none;
    border-radius: 6px;
    color: #fff;
    cursor: pointer;
    padding: 8px 12px;
  }

  #exclusion-modal .btn.secondary {
    background: #444;
  }

  #exclusion-modal .btn.warn {
    background: #b54708;
  }

  #exclusions-field {
    color: #ccc;
    cursor: pointer;
    font-style: italic;
    opacity: 0.6;
    user-select: none;
    width: 200px;
    min-width: fit-content;
    max-width: 100%;
  }

  #exclusion-modal .crumb {
    color: var(--primary-blue);
    cursor: pointer;
    font-weight: 500;
    transition: color 0.2s ease;
    user-select: none;
  }

  #exclusion-view-modal .modal-body {
    position: relative;
  }

  #exclusion-view-modal .toast {
    background: rgba(0, 0, 0, 0.9);
    border: 1px solid #00aaff55;
    border-radius: 6px;
    bottom: 12px;
    color: #00ff99;
    display: none;
    font-weight: 600;
    left: 50%;
    padding: 8px 14px;
    position: absolute;
    transform: translateX(-50%);
    z-index: 10;
  }

  #exclusion-view-modal .toast.error {
    color: #ff5555;
  }

  #exclusion-modal .crumb:hover {
    color: #ff3333;
    text-decoration: underline;
  }

  #exclusion-modal .sep {
    color: #999;
  }

  .footer>div {
    gap: 6px !important;
  }

  .footer button {
    margin: 0 !important;
  }

  *,
  *::before,
  *::after {
    box-sizing: border-box;
  }

  /* Focus outline for keyboard users */
  :focus-visible {
    outline: 2px solid var(--primary-blue);
    outline-offset: 2px;
  }

  /* Hover and focus for interactive elements */
  button:hover,
  input[type="checkbox"]:hover,
  select:hover,
  a:hover {
    filter: brightness(1.1);
  }

  button:focus-visible,
  input[type="checkbox"]:focus-visible,
  select:focus-visible,
  a:focus-visible {
    outline: 2px solid var(--primary-blue);
    outline-offset: 2px;
  }

  /* Scrollbar dark theme for readability */
  ::-webkit-scrollbar {
    width: 8px;
  }

  ::-webkit-scrollbar-thumb {
    background: var(--primary-blue);
    border-radius: 4px;
  }

  #qbit_status {
    width: 200px;
    min-width: fit-content;
    max-width: 100%;
    display: inline-block;
  }

  #HASH_PATH {
    width: 200px;
    min-width: fit-content;
    max-width: 100%;
    display: inline-block;
  }

  #manual-move-section {
    width: 24.5%;
    box-sizing: border-box;
  }

  .manual-move-toggle-wrapper {
    margin-top: 20px;
  }

  #manual-move-section .form-pair label {
    width: 130px;
    /* match vm-backup-and-restore settings labels */
    font-weight: bold;
    color: var(--primary-blue);
  }

  #manual-move-section .form-pair input {
    width: 200px;
    /* same as others */
  }

  #manual-move-section .form-check {
    gap: 4px !important;
  }

  #manual-move-section input[type="checkbox"] {
    margin-right: 2px !important;
    transform: scale(1.1);
  }

  /* Shake animation for invalid click */
  @keyframes pickerShake {
    0% {
      transform: translateX(0);
    }

    20% {
      transform: translateX(-8px);
    }

    40% {
      transform: translateX(8px);
    }

    60% {
      transform: translateX(-8px);
    }

    80% {
      transform: translateX(8px);
    }

    100% {
      transform: translateX(0);
    }
  }

  .shake-picker {
    animation: pickerShake 0.3s ease;
  }

  /* --- Picker link styles (same as exclusions modal) --- */
  .picker-link {
    color: var(--primary-blue);
    cursor: pointer;
    font-weight: 500;
  }

  .picker-link:hover {
    text-decoration: underline;
  }

  /* Breadcrumb container matches exclusions modal */
  #manual-picker-crumbs {
    font-size: 14px;
    color: var(--primary-blue);
    padding: 10px 12px;
    border-bottom: 1px solid #333;
    display: flex;
    gap: 6px;
    flex-wrap: wrap;
  }

  /* Breadcrumb pieces */
  .picker-crumb {
    color: #3ca8ff;
    cursor: pointer;
    transition: color 0.15s ease;
  }

  .picker-crumb:hover {
    text-decoration: underline;
    color: #ff4444;
  }

  #manual_source,
  #manual_dest {
    cursor: pointer;
  }

  #qbit-days-to-warning,
  #qbit-days-order-warning {
    max-width: 200px;
    width: 200px;
    /* optional, keeps consistent width */
    white-space: normal;
    /* allows wrapping */
  }

  .manual-error-toast {
    display: none;
    color: #ff4444;
    padding: -66px 10px;
    border-radius: 6px;
    font-size: 13px;
    font-weight: 600;
    max-width: 200px;
    white-space: normal;
  }

  .manual-error-wide {
    max-width: 350px !important;
  }

  @keyframes manualShake {
    0% {
      transform: translateX(0);
    }

    20% {
      transform: translateX(-8px);
    }

    40% {
      transform: translateX(8px);
    }

    60% {
      transform: translateX(-8px);
    }

    80% {
      transform: translateX(8px);
    }

    100% {
      transform: translateX(0);
    }
  }

  .manual-shake {
    animation: manualShake .35s ease;
  }

  #exclusion-view-modal .modal-body {
    display: flex;
    flex-direction: column;
    padding-right: 18px !important;
  }

  #exclusion-view-modal p {
    width: 100% !important;
    max-width: 100% !important;
    margin-right: 0 !important;
  }

  #exclusionsEditor {
    width: 100% !important;
    margin-right: 0 !important;
    padding-right: 8px;
  }

  #exclusion-view-modal .footer {
    display: flex;
    justify-content: flex-end !important;
    margin-top: 10px;
  }

  #exclusion-view-modal .footer>div:first-child {
    margin-right: auto;
  }

  #stop-button {
    border: none;
  }

  .form-check {
    display: flex;
    align-items: center;
    gap: 0px;
    /* same spacing as other checkboxes */
    cursor: pointer;
    color: var(--primary-blue);
  }

  .form-check input[type="checkbox"] {
    width: 16px;
    height: 16px;
    transform: scale(1.1);
    /* same enlargement as others */
    accent-color: var(--primary-blue);
    cursor: pointer;
  }

  .form-check label {
    margin: 0;
    line-height: 1.4;
    font-size: 14px;
    font-weight: bold;
    color: var(--primary-blue);
    cursor: pointer;
  }

  #stop_all_containers {
    margin-left: 2px;
    transform: scale(1.1);
    width: 16px;
    height: 16px;
    vertical-align: middle;
  }

  #cron-warning-fields,
  #cron-warning-minute,
  #cron-warning-interval {
    max-width: 360px;
    width: 100%;
    box-sizing: border-box;
    word-wrap: break-word;
  }
</style>

<div id="vm-backup-and-restore-wrapper">
  <form id="vm-backup-and-restore-settings">

    <!-- VM -->
    <div class="form-pair">
      <label for="pool" <span title="Choose which pool to monitor for disk usage" class="vm-backup-and-restoretip">VM:</span>
      </label>
      <span title="Choose which pool to monitor for disk usage" class="vm-backup-and-restoretip">
        <select id="pool" class="select-pool"
          data-selected="<?php echo htmlspecialchars($settings['POOL_NAME'] ?? '') ?>"></select>
      </span>
    </div>

<!-- Scheduling Selection -->
<div class="form-pair" id="cron-expression-row">
  <label for="cron_mode">
    <span class="vm-backup-and-restoretip" title="Select scheduling selection">
      Scheduling:
    </span>
  </label>
  <div class="input-wrapper">
    <span class="vm-backup-and-restoretip" title="Select scheduling selection">
      <select id="cron_mode" name="CRON_MODE" class="short-input">
        <option value="minutes" <?php echo (($settings['CRON_MODE'] ?? '' )==='minutes' ) ? 'selected' : '' ; ?>>Minutes</option>
        <option value="hourly" <?php echo (($settings['CRON_MODE'] ?? '' )==='hourly' ) ? 'selected' : '' ; ?>>Hourly</option>
        <option value="daily" <?php echo (($settings['CRON_MODE'] ?? '' )==='daily' ) ? 'selected' : '' ; ?>>Daily</option>
        <option value="weekly" <?php echo (($settings['CRON_MODE'] ?? '' )==='weekly' ) ? 'selected' : '' ; ?>>Weekly</option>
        <option value="monthly" <?php echo (($settings['CRON_MODE'] ?? '' )==='monthly' ) ? 'selected' : '' ; ?>>Monthly</option>
        <option value="custom" <?php echo (($settings['CRON_MODE'] ?? '' )==='custom' ) ? 'selected' : '' ; ?>>Custom</option>
      </select>
    </span>
  </div>
</div>

<!-- Minutes Options -->
<div id="minutes-options" style="display:none; margin-top:10px;">
  <div class="form-pair">
    <label for="minutes_frequency">
      <span class="vm-backup-and-restoretip" title="Select minute frequency">
        Select Frequency:
      </span>
    </label>
    <div class="input-wrapper">
      <span class="vm-backup-and-restoretip" title="Select minute frequency">
        <select id="minutes_frequency" name="MINUTES_FREQUENCY" class="short-input">
          <?php
            for ($i = 2; $i <= 59; $i++) {
              $selected = (($settings['MINUTES_FREQUENCY'] ?? '') == strval($i)) ? 'selected' : '';
              echo "<option value=\"$i\" $selected>Every $i Minutes</option>";
            }
          ?>
        </select>
      </span>
    </div>
  </div>
</div>

<!-- Hourly Options -->
<div id="hourly-options" style="display:none; margin-top:10px;">
  <div class="form-pair">
    <label for="hourly_frequency">
      <span class="vm-backup-and-restoretip" title="Select hourly frequency">
        Select Frequency:
      </span>
    </label>
    <div class="input-wrapper">
      <span class="vm-backup-and-restoretip" title="Select hourly frequency">
        <select id="hourly_frequency" name="HOURLY_FREQUENCY" class="short-input">
          <?php
          for ($i = 1; $i <= 23; $i++) {
              $selected = (($settings['HOURLY_FREQUENCY'] ?? '') === (string)$i) ? 'selected' : '';
              echo "<option value=\"$i\" $selected>Every $i Hour" . ($i > 1 ? 's' : '') . "</option>";
          }
          ?>
        </select>
      </span>
    </div>
  </div>
</div>

    <!-- Daily Options -->
    <div id="daily-options" style="display:none; margin-top:10px;">
      <div class="form-pair">
        <label for="daily_time">
          <span class="vm-backup-and-restoretip" title="Select the time of day for daily execution">
            Time Of Day:
          </span>
        </label>
        <div class="input-wrapper">
          <span class="vm-backup-and-restoretip" title="Select the time of day for daily execution">
            <select id="daily_time" name="DAILY_TIME" class="short-input">
              <?php for ($h = 0; $h < 24; $h++): 
            $time = str_pad($h, 2, "0", STR_PAD_LEFT) . ":00"; ?>
              <option value="<?php echo $time; ?>" <?php echo (($settings['DAILY_TIME'] ?? '' )===$time) ? 'selected'
                : '' ; ?>>
                <?php echo $time; ?>
              </option>
              <?php endfor; ?>
            </select>
          </span>
        </div>
      </div>
    </div>

    <!-- Weekly Options -->
    <div id="weekly-options" style="display:none; margin-top:10px;">
      <div class="form-pair">
        <label for="weekly_day">
          <span class="vm-backup-and-restoretip" title="Select day of the week">
            Day Of Week:
          </span>
        </label>
        <div class="input-wrapper">
          <span class="vm-backup-and-restoretip" title="Select day of the week">
            <select id="weekly_day" name="WEEKLY_DAY" class="short-input">
              <?php 
            $days = ["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"];
            foreach ($days as $day): ?>
              <option value="<?php echo $day; ?>" <?php echo (($settings['WEEKLY_DAY'] ?? '' )===$day) ? 'selected' : ''
                ; ?>>
                <?php echo $day; ?>
              </option>
              <?php endforeach; ?>
            </select>
          </span>
        </div>
      </div>

      <div class="form-pair">
        <label for="weekly_time">
          <span class="vm-backup-and-restoretip" title="Select time of day for weekly execution">
            Time Of Day:
          </span>
        </label>
        <div class="input-wrapper">
          <span class="vm-backup-and-restoretip" title="Select time of day for weekly execution">
            <select id="weekly_time" name="WEEKLY_TIME" class="short-input">
              <?php for ($h = 0; $h < 24; $h++): 
            $time = str_pad($h, 2, "0", STR_PAD_LEFT) . ":00"; ?>
              <option value="<?php echo $time; ?>" <?php echo (($settings['WEEKLY_TIME'] ?? '' )===$time) ? 'selected'
                : '' ; ?>>
                <?php echo $time; ?>
              </option>
              <?php endfor; ?>
            </select>
          </span>
        </div>
      </div>
    </div>

    <!-- Monthly Options -->
    <div id="monthly-options" style="display:none; margin-top:10px;">
      <div class="form-pair">
        <label for="monthly_day">
          <span class="vm-backup-and-restoretip" title="Select day of the month">
            Day Of Month:
          </span>
        </label>
        <div class="input-wrapper">
          <span class="vm-backup-and-restoretip" title="Select day of the month">
            <select id="monthly_day" name="MONTHLY_DAY" class="short-input">
              <?php for ($d = 1; $d <= 31; $d++): 
            $day = str_pad($d, 2, "0", STR_PAD_LEFT); ?>
              <option value="<?php echo $day; ?>" <?php echo (($settings['MONTHLY_DAY'] ?? '' )===$day) ? 'selected'
                : '' ; ?>>
                <?php echo $day; ?>
              </option>
              <?php endfor; ?>
            </select>
          </span>
        </div>
      </div>

      <div class="form-pair">
        <label for="monthly_time">
          <span class="vm-backup-and-restoretip" title="Select time of day for monthly execution">
            Time Of Day:
          </span>
        </label>
        <div class="input-wrapper">
          <span class="vm-backup-and-restoretip" title="Select time of day for monthly execution">
            <select id="monthly_time" name="MONTHLY_TIME" class="short-input">
              <?php for ($h = 0; $h < 24; $h++): 
            $time = str_pad($h, 2, "0", STR_PAD_LEFT) . ":00"; ?>
              <option value="<?php echo $time; ?>" <?php echo (($settings['MONTHLY_TIME'] ?? '' )===$time) ? 'selected'
                : '' ; ?>>
                <?php echo $time; ?>
              </option>
              <?php endfor; ?>
            </select>
          </span>
        </div>
      </div>
    </div>

    <!-- Custom Option -->
    <div id="custom-options" style="display:none; margin-top:10px;">
      <div class="form-pair">
        <label for="custom_cron">
          <span class="vm-backup-and-restoretip"
            title="Enter a valid cron expression 5 fields with spaces between each for example */2 * * * * visit https://crontab.guru for help">
            Cron Expression:
          </span>
        </label>
        <div class="input-wrapper">
          <span class="vm-backup-and-restoretip"
            title="Enter a valid cron expression 5 fields with spaces between each for example */2 * * * * visit https://crontab.guru for help">
            <input type="text" id="custom_cron" name="CUSTOM_CRON" class="short-input" placeholder="*/2 * * * *"
              value="<?php echo htmlspecialchars($settings['CUSTOM_CRON'] ?? ''); ?>">
          </span>
        </div>
      </div>

      <div class="form-pair">
        <div id="cron-warning-fields" class="field-warning" role="alert" style="display:none;">
          ⚠️ Enter a valid cron expression 5 fields with spaces between each for example */2 * * * *
          visit <a href="https://crontab.guru/" target="_blank">https://crontab.guru</a> for help
        </div>
        <div id="cron-warning-minute" class="field-warning" role="alert" style="display:none;">
          ⚠️ First field cannot be * use */2 or higher
        </div>
        <div id="cron-warning-interval" class="field-warning" role="alert" style="display:none;">
          ⚠️ First field must be */2 or higher
        </div>
      </div>
    </div>

    <!-- Webhook URL -->
    <div class="form-pair" id="webhook_row" style="display:none;">
      <label for="webhook_url">
        <span title="Optional: Discord Webhook URL for notifications" class="vm-backup-and-restoretip">Discord Webhook:</span>
      </label>
      <div class="input-wrapper">
        <span title="Optional: Discord Webhook URL for notifications" class="vm-backup-and-restoretip">
          <input type="text" id="webhook_url" placeholder="https://discord.com/api/webhooks/yourwebhookid"
            value="<?php echo htmlspecialchars($settings['WEBHOOK_URL'] ?? '') ?>">
        </span>
        <div id="webhook-warning" class="field-warning">
          ⚠️ Needs entered like this https://discord.com/api/webhooks/yourwebhookid
        </div>
      </div>
    </div>

    <!-- Checkboxes row -->
    <div class="checkbox-row">
      <span title="Start vm-backup-and-restore automatically when Unraid boots" class="vm-backup-and-restoretip">
        <label>
          <input type="checkbox" id="autostart" <?php echo ($settings['AUTOSTART'] ?? '' )==='yes' ? 'checked' : '' ?>>
          Autostart on Boot
        </label>
      </span>

      <span title="Enable an exclusions list of files and folders that won't be moved" class="vm-backup-and-restoretip">
        <label>
          <input type="checkbox" id="enable_exclusions" <?php echo ($settings['EXCLUSIONS_ENABLED'] ?? '' )==='yes'
            ? 'checked' : '' ?>> Enable Exclusions
        </label>
      </span>

      <span title="Allow vm-backup-and-restore to run even when Unraid is doing a parity check" class="vm-backup-and-restoretip">
        <label>
          <input type="checkbox" id="allow_during_parity" <?php echo ($settings['ALLOW_DURING_PARITY'] ?? '' )==='yes'
            ? 'checked' : '' ?>> Allow During Parity
        </label>
      </span>

      <span title="Enable to move files only if older than the specified amount of days old" class="vm-backup-and-restoretip">
        <label>
          <input type="checkbox" id="age_based_filter" <?php echo ($settings['AGE_BASED_FILTER'] ?? '' )==='yes'
            ? 'checked' : '' ?>> Enable Age Based Filter
        </label>
      </span>

      <span title="Enable to simulate moves without actually transferring files" class="vm-backup-and-restoretip">
        <label>
          <input type="checkbox" id="dry_run" <?php echo ($settings['DRY_RUN'] ?? '' )==='yes' ? 'checked' : '' ?>> Dry
          Run
        </label>
      </span>

      <span title="Enable to move only files larger than the specified size in MB" class="vm-backup-and-restoretip">
        <label>
          <input type="checkbox" id="size_based_filter" <?php echo ($settings['SIZE_BASED_FILTER'] ?? '' )==='yes'
            ? 'checked' : '' ?>> Enable Size Based Filter
        </label>
      </span>

      <span title="Enable to pause qbittorrent torrents before move and resume after" class="vm-backup-and-restoretip">
        <label>
          <input type="checkbox" id="qbit_script" <?php echo ($settings['QBITTORRENT_SCRIPT'] ?? '' )==='yes'
            ? 'checked' : '' ?>> Enable Qbit Script
        </label>
      </span>

      <span title="Skip hidden files and folders (those starting with a dot)" class="vm-backup-and-restoretip">
        <label>
          <input type="checkbox" id="hidden_filter" <?php echo ($settings['HIDDEN_FILTER'] ?? '' )==='yes' ? 'checked'
            : '' ?>> Enable Hidden Filter
        </label>
      </span>

      <span title="Force Unraid to use reconstructive (turbo) write mode during file moves" class="vm-backup-and-restoretip">
        <label>
          <input type="checkbox" id="force_reconstructive_write" <?php echo ($settings['FORCE_RECONSTRUCTIVE_WRITE']
            ?? '' )==='yes' ? 'checked' : '' ?>> Force Turbo Write
        </label>
      </span>

      <span title="Enable to remove empty folders and datasets from shares that are moved" class="vm-backup-and-restoretip">
        <label>
          <input type="checkbox" id="enable_cleanup" <?php echo ($settings['ENABLE_CLEANUP'] ?? '' )==='yes' ? 'checked'
            : '' ?>> Enable Cleanup
        </label>
      </span>

      <span
        title="Enable this if you want jdupes to run a fix-hardlinks scan on the shares moved. Exclusions for appdata, system, domains, and isos"
        class="vm-backup-and-restoretip">
        <label>
          <input type="checkbox" id="ENABLE_JDUPES" <?php echo ($settings['ENABLE_JDUPES'] ?? '' )==='yes' ? 'checked'
            : '' ; ?>> Enable Jdupes
        </label>
      </span>

      <span title="Send Unraid system notifications when vm-backup-and-restore starts and finishes" class="vm-backup-and-restoretip">
        <label>
          <input type="checkbox" id="enable_notifications" <?php echo ($settings['ENABLE_NOTIFICATIONS'] ?? '' )==='yes'
            ? 'checked' : '' ?>>
          Enable Notifications
        </label>
      </span>

      <span title="Enable running a session start and session end script which runs regardless of filters enabled"
        class="vm-backup-and-restoretip">
        <label>
          <input type="checkbox" id="enable_scripts" name="ENABLE_SCRIPTS" <?php echo (($settings['ENABLE_SCRIPTS']
            ?? 'no' )==='yes' ) ? 'checked' : '' ; ?>>
          Enable Pre/Post Scripts
        </label>
      </span>

      <span title="Enable ssd trim to run after the move completes" class="vm-backup-and-restoretip">
        <label>
          <input type="checkbox" id="enable_trim_toggle" name="ENABLE_TRIM" <?php echo (($settings['ENABLE_TRIM']
            ?? 'no' )==='yes' ) ? 'checked' : '' ; ?>>
          Enable SSD Trim
        </label>
      </span>

      <span title="Enable to show a manual move section below" class="vm-backup-and-restoretip">
        <label>
          <input type="checkbox" id="manual_move_toggle" <?php echo ($settings['MANUAL_MOVE'] ?? 'no' )==='yes'
            ? 'checked' : '' ; ?>>
          Manual Move
        </label>
      </span>
    </div>
    </div>

  </div>
</div>